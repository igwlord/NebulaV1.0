<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✅ Test Autenticación Final</title>
    <style>
        body { 
            font-family: 'Inter', Arial, sans-serif; 
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); 
            color: white; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: rgba(0,0,0,0.4); 
            border-radius: 20px; 
            padding: 30px; 
            backdrop-filter: blur(10px); 
        }
        .status { 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid; 
        }
        .success { color: #10b981; border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .error { color: #ef4444; border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .info { color: #3b82f6; border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .warning { color: #f59e0b; border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        
        button { 
            background: linear-gradient(45deg, #22c55e, #16a34a); 
            border: none; 
            color: white; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            margin: 5px; 
            transition: transform 0.2s; 
        }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            font-size: 1rem; 
        }
        input::placeholder { color: rgba(255,255,255,0.6); }
        
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 15px; 
        }
        
        .auth-form {
            display: none;
            margin-top: 15px;
        }
        .auth-form.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌌 Test Final Autenticación Nebula</h1>
        <p>Prueba completa del sistema de autenticación implementado</p>
        
        <div class="test-section">
            <h3>📊 Estado del Sistema</h3>
            <div id="system-status"></div>
        </div>
        
        <div class="test-section">
            <h3>🔐 Pruebas de Autenticación</h3>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="test-google-btn">🔗 Test Google</button>
                <button id="test-anonymous-btn">👤 Test Anónimo</button>
                <button id="test-email-btn">📧 Test Email</button>
                <button id="test-logout-btn">🚪 Logout</button>
            </div>
            
            <!-- Formulario Email -->
            <div id="email-form" class="auth-form">
                <h4>📧 Autenticación con Email</h4>
                <input type="email" id="test-email" placeholder="test@ejemplo.com" value="test@nebula.com">
                <input type="password" id="test-password" placeholder="Contraseña" value="123456">
                <div style="display: flex; gap: 10px;">
                    <button id="login-email-btn">🔐 Login</button>
                    <button id="register-email-btn">✨ Registrar</button>
                    <button id="reset-password-btn">🔄 Reset</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>👤 Usuario Actual</h3>
            <div id="user-info"></div>
        </div>
        
        <div class="test-section">
            <h3>📋 Log de Eventos</h3>
            <div id="event-log"></div>
            <button onclick="clearLog()">🗑️ Limpiar Log</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Nebula -->
    <script src="./env-loader.js"></script>
    <script src="./config/firebase-config.js"></script>
    <script src="./js/auth/firebase-auth.js"></script>
    
    <script>
        const eventLog = [];
        let currentUser = null;
        
        // Funciones de utilidad
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push({ timestamp, message, type });
            updateEventLog();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }
        
        function updateEventLog() {
            const container = document.getElementById('event-log');
            container.innerHTML = eventLog.slice(-8).map(entry => 
                `<div class="status ${entry.type}">
                    <small>${entry.timestamp}</small><br>
                    ${entry.message}
                </div>`
            ).join('');
        }
        
        function updateSystemStatus() {
            const container = document.getElementById('system-status');
            const firebaseReady = !!window.firebase;
            const configReady = !!window.NebulaConfig;
            const authReady = !!window.NebulaAuth;
            const appInitialized = firebase?.apps?.length > 0;
            
            container.innerHTML = `
                <div class="status ${firebaseReady ? 'success' : 'error'}">
                    🔥 Firebase SDK: ${firebaseReady ? '✅ Cargado' : '❌ No disponible'}
                </div>
                <div class="status ${configReady ? 'success' : 'error'}">
                    ⚙️ Config: ${configReady ? '✅ Válido' : '❌ No válido'}
                </div>
                <div class="status ${authReady ? 'success' : 'error'}">
                    🔐 NebulaAuth: ${authReady ? '✅ Disponible' : '❌ No disponible'}
                </div>
                <div class="status ${appInitialized ? 'success' : 'warning'}">
                    🚀 Firebase App: ${appInitialized ? '✅ Inicializada' : '⚠️ No inicializada'}
                </div>
            `;
        }
        
        function updateUserInfo() {
            const container = document.getElementById('user-info');
            
            if (currentUser) {
                container.innerHTML = `
                    <div class="status success">
                        <strong>✅ Usuario Autenticado</strong><br>
                        <strong>Email:</strong> ${currentUser.email || 'N/A'}<br>
                        <strong>Nombre:</strong> ${currentUser.displayName || 'N/A'}<br>
                        <strong>Provider:</strong> ${currentUser.provider || 'N/A'}<br>
                        <strong>Verificado:</strong> ${currentUser.emailVerified ? '✅' : '❌'}<br>
                        <strong>Anónimo:</strong> ${currentUser.isAnonymous ? '✅' : '❌'}<br>
                        <strong>UID:</strong> ${currentUser.uid?.substring(0, 8)}...
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="status info">
                        ⚪ No hay usuario autenticado
                    </div>
                `;
            }
        }
        
        function clearLog() {
            eventLog.length = 0;
            updateEventLog();
        }
        
        // Tests de autenticación
        async function testGoogleAuth() {
            try {
                log('🔐 Iniciando test Google Auth...', 'info');
                const user = await window.NebulaAuth.signInWithGoogle();
                log(`✅ Google Auth exitoso: ${user.email}`, 'success');
            } catch (error) {
                log(`❌ Error Google Auth: ${error.message}`, 'error');
            }
        }
        
        async function testAnonymousAuth() {
            try {
                log('👤 Iniciando test Anonymous Auth...', 'info');
                const user = await window.NebulaAuth.signInAnonymously();
                log(`✅ Anonymous Auth exitoso: ${user.uid.substring(0, 8)}...`, 'success');
            } catch (error) {
                log(`❌ Error Anonymous Auth: ${error.message}`, 'error');
            }
        }
        
        async function testEmailLogin() {
            try {
                const email = document.getElementById('test-email').value;
                const password = document.getElementById('test-password').value;
                
                log(`📧 Iniciando login email: ${email}`, 'info');
                const user = await window.NebulaAuth.signInWithEmail(email, password);
                log(`✅ Email login exitoso: ${user.email}`, 'success');
            } catch (error) {
                log(`❌ Error email login: ${error.message}`, 'error');
            }
        }
        
        async function testEmailRegister() {
            try {
                const email = document.getElementById('test-email').value;
                const password = document.getElementById('test-password').value;
                
                log(`✨ Iniciando registro email: ${email}`, 'info');
                const user = await window.NebulaAuth.createUserWithEmail(email, password, 'Usuario Test');
                log(`✅ Email registro exitoso: ${user.email}`, 'success');
            } catch (error) {
                log(`❌ Error email registro: ${error.message}`, 'error');
            }
        }
        
        async function testPasswordReset() {
            try {
                const email = document.getElementById('test-email').value;
                
                log(`🔄 Enviando reset password: ${email}`, 'info');
                await window.NebulaAuth.resetPassword(email);
                log(`✅ Reset password enviado`, 'success');
            } catch (error) {
                log(`❌ Error reset password: ${error.message}`, 'error');
            }
        }
        
        async function testLogout() {
            try {
                log('🚪 Iniciando logout...', 'info');
                await window.NebulaAuth.signOut();
                log('✅ Logout exitoso', 'success');
            } catch (error) {
                log(`❌ Error logout: ${error.message}`, 'error');
            }
        }
        
        // Event Listeners
        document.getElementById('test-google-btn').addEventListener('click', testGoogleAuth);
        document.getElementById('test-anonymous-btn').addEventListener('click', testAnonymousAuth);
        document.getElementById('test-email-btn').addEventListener('click', () => {
            const form = document.getElementById('email-form');
            form.classList.toggle('active');
        });
        document.getElementById('test-logout-btn').addEventListener('click', testLogout);
        
        document.getElementById('login-email-btn').addEventListener('click', testEmailLogin);
        document.getElementById('register-email-btn').addEventListener('click', testEmailRegister);
        document.getElementById('reset-password-btn').addEventListener('click', testPasswordReset);
        
        // Firebase Auth Event Listeners
        window.addEventListener('nebula-auth-userSignedIn', (event) => {
            currentUser = event.detail;
            log(`🔥 Usuario autenticado vía evento: ${currentUser.email || 'Anónimo'}`, 'success');
            updateUserInfo();
        });
        
        window.addEventListener('nebula-auth-userSignedOut', () => {
            currentUser = null;
            log('👋 Usuario desconectado vía evento', 'warning');
            updateUserInfo();
        });
        
        // Mock notification system with visual effects
        window.showNotification = function(message, type = 'info') {
            log(`📢 Notificación: ${message}`, type);
            
            // Crear notificación visual
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full opacity-0 ${
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white max-w-sm`;
            
            // Función para cerrar notificación
            const closeNotification = () => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            };
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="mr-3 text-xl">
                        ${type === 'error' ? '❌' : 
                          type === 'warning' ? '⚠️' : 
                          type === 'success' ? '✅' : 'ℹ️'}
                    </div>
                    <div class="flex-1">
                        ${message}
                    </div>
                    <button class="ml-2 text-white/70 hover:text-white text-xl leading-none close-btn">×</button>
                </div>
            `;
            
            // Agregar al DOM
            document.body.appendChild(notification);
            
            // Fade in effect con requestAnimationFrame para suavidad
            requestAnimationFrame(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            });
            
            // Event listener para el botón de cerrar
            const closeBtn = notification.querySelector('.close-btn');
            closeBtn.addEventListener('click', closeNotification);
            
            // Auto remove después de 5 segundos
            const autoCloseTimer = setTimeout(closeNotification, 5000);
            
            // Pausa del timer si el mouse está sobre la notificación
            notification.addEventListener('mouseenter', () => clearTimeout(autoCloseTimer));
            notification.addEventListener('mouseleave', () => {
                setTimeout(closeNotification, 2000); // 2 segundos extra después de quitar el mouse
            });
        };
        
        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            log('🚀 Test de autenticación iniciado', 'info');
            updateSystemStatus();
            updateUserInfo();
            
            // Actualizar estado cada 3 segundos
            setInterval(() => {
                updateSystemStatus();
                if (window.NebulaAuth && window.NebulaAuth.isAuthenticated()) {
                    currentUser = window.NebulaAuth.getCurrentUser();
                    updateUserInfo();
                }
            }, 3000);
        });
    </script>
</body>
</html>
