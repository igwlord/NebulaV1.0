<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ… Test AutenticaciÃ³n Final</title>
    <style>
        body { 
            font-family: 'Inter', Arial, sans-serif; 
            background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); 
            color: white; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px; 
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: rgba(0,0,0,0.4); 
            border-radius: 20px; 
            padding: 30px; 
            backdrop-filter: blur(10px); 
        }
        .status { 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 10px; 
            border: 1px solid; 
        }
        .success { color: #10b981; border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .error { color: #ef4444; border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
        .info { color: #3b82f6; border-color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        .warning { color: #f59e0b; border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        
        button { 
            background: linear-gradient(45deg, #22c55e, #16a34a); 
            border: none; 
            color: white; 
            padding: 12px 24px; 
            border-radius: 8px; 
            font-size: 1rem; 
            cursor: pointer; 
            margin: 5px; 
            transition: transform 0.2s; 
        }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid rgba(255,255,255,0.3); 
            border-radius: 8px; 
            background: rgba(255,255,255,0.1); 
            color: white; 
            font-size: 1rem; 
        }
        input::placeholder { color: rgba(255,255,255,0.6); }
        
        .test-section { 
            margin: 20px 0; 
            padding: 20px; 
            background: rgba(255,255,255,0.05); 
            border-radius: 15px; 
        }
        
        .auth-form {
            display: none;
            margin-top: 15px;
        }
        .auth-form.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒŒ Test Final AutenticaciÃ³n Nebula</h1>
        <p>Prueba completa del sistema de autenticaciÃ³n implementado</p>
        
        <div class="test-section">
            <h3>ğŸ“Š Estado del Sistema</h3>
            <div id="system-status"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ” Pruebas de AutenticaciÃ³n</h3>
            
            <!-- Tabs -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button id="test-google-btn">ğŸ”— Test Google</button>
                <button id="test-anonymous-btn">ğŸ‘¤ Test AnÃ³nimo</button>
                <button id="test-email-btn">ğŸ“§ Test Email</button>
                <button id="test-logout-btn">ğŸšª Logout</button>
            </div>
            
            <!-- Formulario Email -->
            <div id="email-form" class="auth-form">
                <h4>ğŸ“§ AutenticaciÃ³n con Email</h4>
                <input type="email" id="test-email" placeholder="test@ejemplo.com" value="test@nebula.com">
                <input type="password" id="test-password" placeholder="ContraseÃ±a" value="123456">
                <div style="display: flex; gap: 10px;">
                    <button id="login-email-btn">ğŸ” Login</button>
                    <button id="register-email-btn">âœ¨ Registrar</button>
                    <button id="reset-password-btn">ğŸ”„ Reset</button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ‘¤ Usuario Actual</h3>
            <div id="user-info"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“‹ Log de Eventos</h3>
            <div id="event-log"></div>
            <button onclick="clearLog()">ğŸ—‘ï¸ Limpiar Log</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Nebula -->
    <script src="./env-loader.js"></script>
    <script src="./config/firebase-config.js"></script>
    <script src="./js/auth/firebase-auth.js"></script>
    
    <script>
        const eventLog = [];
        let currentUser = null;
        
        // Funciones de utilidad
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            eventLog.push({ timestamp, message, type });
            updateEventLog();
            console.log(`[${timestamp}] ${type.toUpperCase()}: ${message}`);
        }
        
        function updateEventLog() {
            const container = document.getElementById('event-log');
            container.innerHTML = eventLog.slice(-8).map(entry => 
                `<div class="status ${entry.type}">
                    <small>${entry.timestamp}</small><br>
                    ${entry.message}
                </div>`
            ).join('');
        }
        
        function updateSystemStatus() {
            const container = document.getElementById('system-status');
            const firebaseReady = !!window.firebase;
            const configReady = !!window.NebulaConfig;
            const authReady = !!window.NebulaAuth;
            const appInitialized = firebase?.apps?.length > 0;
            
            container.innerHTML = `
                <div class="status ${firebaseReady ? 'success' : 'error'}">
                    ğŸ”¥ Firebase SDK: ${firebaseReady ? 'âœ… Cargado' : 'âŒ No disponible'}
                </div>
                <div class="status ${configReady ? 'success' : 'error'}">
                    âš™ï¸ Config: ${configReady ? 'âœ… VÃ¡lido' : 'âŒ No vÃ¡lido'}
                </div>
                <div class="status ${authReady ? 'success' : 'error'}">
                    ğŸ” NebulaAuth: ${authReady ? 'âœ… Disponible' : 'âŒ No disponible'}
                </div>
                <div class="status ${appInitialized ? 'success' : 'warning'}">
                    ğŸš€ Firebase App: ${appInitialized ? 'âœ… Inicializada' : 'âš ï¸ No inicializada'}
                </div>
            `;
        }
        
        function updateUserInfo() {
            const container = document.getElementById('user-info');
            
            if (currentUser) {
                container.innerHTML = `
                    <div class="status success">
                        <strong>âœ… Usuario Autenticado</strong><br>
                        <strong>Email:</strong> ${currentUser.email || 'N/A'}<br>
                        <strong>Nombre:</strong> ${currentUser.displayName || 'N/A'}<br>
                        <strong>Provider:</strong> ${currentUser.provider || 'N/A'}<br>
                        <strong>Verificado:</strong> ${currentUser.emailVerified ? 'âœ…' : 'âŒ'}<br>
                        <strong>AnÃ³nimo:</strong> ${currentUser.isAnonymous ? 'âœ…' : 'âŒ'}<br>
                        <strong>UID:</strong> ${currentUser.uid?.substring(0, 8)}...
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="status info">
                        âšª No hay usuario autenticado
                    </div>
                `;
            }
        }
        
        function clearLog() {
            eventLog.length = 0;
            updateEventLog();
        }
        
        // Tests de autenticaciÃ³n
        async function testGoogleAuth() {
            try {
                log('ğŸ” Iniciando test Google Auth...', 'info');
                const user = await window.NebulaAuth.signInWithGoogle();
                log(`âœ… Google Auth exitoso: ${user.email}`, 'success');
            } catch (error) {
                log(`âŒ Error Google Auth: ${error.message}`, 'error');
            }
        }
        
        async function testAnonymousAuth() {
            try {
                log('ğŸ‘¤ Iniciando test Anonymous Auth...', 'info');
                const user = await window.NebulaAuth.signInAnonymously();
                log(`âœ… Anonymous Auth exitoso: ${user.uid.substring(0, 8)}...`, 'success');
            } catch (error) {
                log(`âŒ Error Anonymous Auth: ${error.message}`, 'error');
            }
        }
        
        async function testEmailLogin() {
            try {
                const email = document.getElementById('test-email').value;
                const password = document.getElementById('test-password').value;
                
                log(`ğŸ“§ Iniciando login email: ${email}`, 'info');
                const user = await window.NebulaAuth.signInWithEmail(email, password);
                log(`âœ… Email login exitoso: ${user.email}`, 'success');
            } catch (error) {
                log(`âŒ Error email login: ${error.message}`, 'error');
            }
        }
        
        async function testEmailRegister() {
            try {
                const email = document.getElementById('test-email').value;
                const password = document.getElementById('test-password').value;
                
                log(`âœ¨ Iniciando registro email: ${email}`, 'info');
                const user = await window.NebulaAuth.createUserWithEmail(email, password, 'Usuario Test');
                log(`âœ… Email registro exitoso: ${user.email}`, 'success');
            } catch (error) {
                log(`âŒ Error email registro: ${error.message}`, 'error');
            }
        }
        
        async function testPasswordReset() {
            try {
                const email = document.getElementById('test-email').value;
                
                log(`ğŸ”„ Enviando reset password: ${email}`, 'info');
                await window.NebulaAuth.resetPassword(email);
                log(`âœ… Reset password enviado`, 'success');
            } catch (error) {
                log(`âŒ Error reset password: ${error.message}`, 'error');
            }
        }
        
        async function testLogout() {
            try {
                log('ğŸšª Iniciando logout...', 'info');
                await window.NebulaAuth.signOut();
                log('âœ… Logout exitoso', 'success');
            } catch (error) {
                log(`âŒ Error logout: ${error.message}`, 'error');
            }
        }
        
        // Event Listeners
        document.getElementById('test-google-btn').addEventListener('click', testGoogleAuth);
        document.getElementById('test-anonymous-btn').addEventListener('click', testAnonymousAuth);
        document.getElementById('test-email-btn').addEventListener('click', () => {
            const form = document.getElementById('email-form');
            form.classList.toggle('active');
        });
        document.getElementById('test-logout-btn').addEventListener('click', testLogout);
        
        document.getElementById('login-email-btn').addEventListener('click', testEmailLogin);
        document.getElementById('register-email-btn').addEventListener('click', testEmailRegister);
        document.getElementById('reset-password-btn').addEventListener('click', testPasswordReset);
        
        // Firebase Auth Event Listeners
        window.addEventListener('nebula-auth-userSignedIn', (event) => {
            currentUser = event.detail;
            log(`ğŸ”¥ Usuario autenticado vÃ­a evento: ${currentUser.email || 'AnÃ³nimo'}`, 'success');
            updateUserInfo();
        });
        
        window.addEventListener('nebula-auth-userSignedOut', () => {
            currentUser = null;
            log('ğŸ‘‹ Usuario desconectado vÃ­a evento', 'warning');
            updateUserInfo();
        });
        
        // Mock notification system with visual effects
        window.showNotification = function(message, type = 'info') {
            log(`ğŸ“¢ NotificaciÃ³n: ${message}`, type);
            
            // Crear notificaciÃ³n visual
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full opacity-0 ${
                type === 'error' ? 'bg-red-500' : 
                type === 'warning' ? 'bg-yellow-500' : 
                type === 'success' ? 'bg-green-500' : 'bg-blue-500'
            } text-white max-w-sm`;
            
            // FunciÃ³n para cerrar notificaciÃ³n
            const closeNotification = () => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 300);
            };
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="mr-3 text-xl">
                        ${type === 'error' ? 'âŒ' : 
                          type === 'warning' ? 'âš ï¸' : 
                          type === 'success' ? 'âœ…' : 'â„¹ï¸'}
                    </div>
                    <div class="flex-1">
                        ${message}
                    </div>
                    <button class="ml-2 text-white/70 hover:text-white text-xl leading-none close-btn">Ã—</button>
                </div>
            `;
            
            // Agregar al DOM
            document.body.appendChild(notification);
            
            // Fade in effect con requestAnimationFrame para suavidad
            requestAnimationFrame(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateX(0)';
            });
            
            // Event listener para el botÃ³n de cerrar
            const closeBtn = notification.querySelector('.close-btn');
            closeBtn.addEventListener('click', closeNotification);
            
            // Auto remove despuÃ©s de 5 segundos
            const autoCloseTimer = setTimeout(closeNotification, 5000);
            
            // Pausa del timer si el mouse estÃ¡ sobre la notificaciÃ³n
            notification.addEventListener('mouseenter', () => clearTimeout(autoCloseTimer));
            notification.addEventListener('mouseleave', () => {
                setTimeout(closeNotification, 2000); // 2 segundos extra despuÃ©s de quitar el mouse
            });
        };
        
        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸš€ Test de autenticaciÃ³n iniciado', 'info');
            updateSystemStatus();
            updateUserInfo();
            
            // Actualizar estado cada 3 segundos
            setInterval(() => {
                updateSystemStatus();
                if (window.NebulaAuth && window.NebulaAuth.isAuthenticated()) {
                    currentUser = window.NebulaAuth.getCurrentUser();
                    updateUserInfo();
                }
            }, 3000);
        });
    </script>
</body>
</html>
