<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    
    <!-- üöÄ OPTIMIZACI√ìN NUCLEAR - Cache Busting Inteligente -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- üåå NEBULA IDENTITY - SEO Optimizado -->
    <title>üåå Nebula Financial - Tu Universo Financiero √âpico</title>
    <meta name="description" content="La experiencia financiera m√°s avanzada del universo. Gestiona ingresos, gastos, inversiones y deudas con inteligencia gal√°ctica.">
    <meta name="keywords" content="finanzas personales, gesti√≥n financiera, presupuesto, inversiones, nebula">
    <meta name="author" content="Nebula Financial Team">
    
    <!-- üéØ PERFORMANCE CRITICAL - Recursos Prioritarios -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <!-- üöÄ FUENTES - Carga Optimizada -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"></noscript>
    
    <!-- üé® ICONOS Y MANIFEST -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåå</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FCD34D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nebula Financial">
    
    <!-- üéØ CSS CR√çTICO - Inline para LCP √©pico -->
    <style>
        /* üöÄ CRITICAL CSS - Primera Impresi√≥n √âpica */
        :root {
            --nebula-primary: #1e40af;
            --nebula-secondary: #7c3aed;
            --nebula-accent: #fcd34d;
            --nebula-gold: #ffd700;
            --nebula-dark: #0f0f23;
            --nebula-darker: #0a0a1a;
            --nebula-glass: rgba(255, 255, 255, 0.1);
            --nebula-glow: 0 0 20px rgba(252, 211, 77, 0.5);
            --nebula-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--nebula-dark);
            color: var(--nebula-accent);
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* üåå LOADING √âPICO - Primera Impresi√≥n */
        .nebula-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .nebula-loading.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .nebula-logo {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #fcd34d, #ffd700, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            animation: nebulaGlow 2s ease-in-out infinite alternate;        }
        
        /* üöÄ CSS FALLBACK - Para cuando Tailwind no est√© disponible */
        .tailwind-fallback .flex { display: flex; }
        .tailwind-fallback .items-center { align-items: center; }
        .tailwind-fallback .justify-center { justify-content: center; }
        .tailwind-fallback .justify-between { justify-content: space-between; }
        .tailwind-fallback .space-x-4 > * + * { margin-left: 1rem; }
        .tailwind-fallback .space-y-4 > * + * { margin-top: 1rem; }
        .tailwind-fallback .p-4 { padding: 1rem; }
        .tailwind-fallback .p-6 { padding: 1.5rem; }
        .tailwind-fallback .bg-opacity-10 { background-color: rgba(255,255,255,0.1); }
        .tailwind-fallback .rounded-lg { border-radius: 0.5rem; }
        .tailwind-fallback .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .tailwind-fallback .text-center { text-align: center; }
        .tailwind-fallback .font-bold { font-weight: bold; }
        .tailwind-fallback .text-yellow-400 { color: #fbbf24; }
        .tailwind-fallback .hidden { display: none; }
        .tailwind-fallback .block { display: block; }
        .tailwind-fallback .w-full { width: 100%; }
        .tailwind-fallback .h-full { height: 100%; }
        .tailwind-fallback .min-h-screen { min-height: 100vh; }
        .tailwind-fallback .cursor-pointer { cursor: pointer; }
        .tailwind-fallback .transition-all { transition: all 0.3s ease; }
        
        .tailwind-fallback .nebula-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            text-decoration: none;
        }
        
        .tailwind-fallback .nebula-btn-primary {
            background: linear-gradient(45deg, var(--nebula-primary), var(--nebula-secondary));
            color: white;
        }
        
        .tailwind-fallback .nebula-btn-secondary {
            background: rgba(255,255,255,0.1);
            color: var(--nebula-accent);
            border: 1px solid rgba(252,211,77,0.3);
        }
        
        @keyframes nebulaGlow {
            from { filter: drop-shadow(0 0 10px rgba(252, 211, 77, 0.5)); }
            to { filter: drop-shadow(0 0 25px rgba(252, 211, 77, 0.8)); }
        }
        
        .nebula-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid transparent;
            border-top: 3px solid var(--nebula-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* üéØ LAYOUT CR√çTICO */
        #app-container {
            min-height: 100vh;
            position: relative;
        }
        
        #content-root {
            position: relative;
            z-index: 10;
            padding-bottom: 6rem;
            min-height: 100vh;
        }
        
        #dock-root {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }
        
        #parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            perspective: 1000px;
            pointer-events: none;
        }
        
        /* üöÄ ANIMACIONES √âPICAS */
        .nebula-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .nebula-slide-up {
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* üé® GLASSMORPHISM √âPICO */
        .nebula-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }
        
        /* üî• HOVER EFFECTS √âPICOS */
        .nebula-hover {
            transition: var(--nebula-transition);
            cursor: pointer;
        }
        
        .nebula-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--nebula-glow);
        }
          /* üì± RESPONSIVE √âPICO */
        @media (max-width: 768px) {
            .nebula-logo { font-size: 3rem; }
            #content-root { padding-bottom: 5rem; }
        }
        
        /* üé® CSS EXTENDIDO - Animaciones para efectos de part√≠culas */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }
        
        @keyframes glow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.4); }
        }
        
        @keyframes drift {
            0% { transform: translateX(0px) translateY(0px); opacity: 0.1; }
            50% { transform: translateX(100px) translateY(-50px); opacity: 0.3; }
            100% { transform: translateX(200px) translateY(0px); opacity: 0.1; }
        }
        
        @keyframes wave {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.3; }
        }
          @keyframes orbit {
            0% { transform: rotate(0deg) translateX(var(--radius)) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(var(--radius)) rotate(-360deg); }
        }
        
        /* üé® SISTEMA DE VALIDACI√ìN VISUAL */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444 !important;
        }
        
        .field-error-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 500;
            animation: slideInError 0.3s ease-out;
        }
        
        @keyframes slideInError {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .field-error-message svg {
            width: 0.875rem;
            height: 0.875rem;
            flex-shrink: 0;
        }
          .input-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 1px #10b981 !important;
        }

        /* üé≠ SISTEMA DE MODALES ELEGANTE */
        .nebula-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nebula-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nebula-modal {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            min-width: 320px;
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .nebula-modal-overlay.active .nebula-modal {
            transform: scale(1) translateY(0);
        }

        .nebula-modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .nebula-modal-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nebula-modal-icon.warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .nebula-modal-icon.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .nebula-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .nebula-modal-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .nebula-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .nebula-modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nebula-modal-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nebula-modal-button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nebula-modal-button.primary {
            background: #3b82f6;
            color: white;
        }

        .nebula-modal-button.primary:hover {
            background: #2563eb;
        }

        .nebula-modal-button.danger {
            background: #ef4444;
            color: white;
        }

        .nebula-modal-button.danger:hover {
            background: #dc2626;
        }

        @media (max-width: 640px) {
            .nebula-modal {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .nebula-modal-actions {
                flex-direction: column-reverse;
            }
            
            .nebula-modal-button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
    
    <!-- üéØ TAILWIND - Sin configuraci√≥n problem√°tica -->    <!-- üöÄ TAILWIND CSS - Optimizado para Producci√≥n -->
    <script>
        // üî• CACHE-BUSTING INTELIGENTE
        const CACHE_BUSTER = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('üî• Cache-Buster activo:', CACHE_BUSTER);
        
        // üéØ CARGA INTELIGENTE DE TAILWIND CON FALLBACK
        const loadTailwind = () => {
            if (!document.getElementById('tailwind-css')) {
                const script = document.createElement('script');
                script.id = 'tailwind-css';
                
                // üöÄ Usar versi√≥n espec√≠fica para mejor estabilidad
                script.src = 'https://cdn.tailwindcss.com?v=3.4.1';
                script.async = true;
                
                // üéØ Configuraci√≥n de Tailwind para suprimir advertencias
                script.setAttribute('data-tw-config', JSON.stringify({
                    experimental: { optimizeUniversalDefaults: true },
                    corePlugins: { preflight: false }
                }));
                
                script.onload = () => {
                    console.log('‚úÖ Tailwind CSS cargado exitosamente (v3.4.1)');
                    
                    // üîá Suprimir advertencias de desarrollo
                    if (window.tailwind && window.tailwind.config) {
                        window.tailwind.config.devMode = false;
                    }
                };
                
                script.onerror = () => {
                    console.warn('‚ö†Ô∏è Tailwind CSS no disponible, usando CSS nativo');
                    // Aplicar estilos alternativos si Tailwind falla
                    document.body.classList.add('tailwind-fallback');
                };
                
                document.head.appendChild(script);
                console.log('üé® Tailwind CSS cargado din√°micamente');
            }
        };
        
        // Cargar Tailwind cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadTailwind);
        } else {
            loadTailwind();
        }
    </script>
    
    <!-- üìä CHART.JS - Carga S√∫per Diferida -->
    <script>
        // üöÄ CARGA CHARTS SOLO CUANDO SEA NECESARIO
        window.loadChartJS = function() {
            return new Promise((resolve, reject) => {
                if (window.Chart) {
                    resolve(window.Chart);
                    return;
                }
                
                console.log('üìä Cargando Chart.js din√°micamente...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js';
                script.async = true;
                script.onload = () => {
                    console.log('‚úÖ Chart.js cargado exitosamente');
                    resolve(window.Chart);
                };
                script.onerror = () => {
                    console.error('‚ùå Error cargando Chart.js');
                    reject(new Error('Failed to load Chart.js'));
                };
                document.head.appendChild(script);
            });
        };
        
        // üéØ PRECARGAR CHART.JS EN BACKGROUND DESPU√âS DE 2 SEGUNDOS
        setTimeout(() => {
            if (!window.Chart) {
                window.loadChartJS().catch(console.error);
            }
        }, 2000);
    </script>
    
    <!-- üé® CSS EXTERNO - Carga Optimizada -->
    <script>
        // üöÄ CARGA DIFERIDA DE CSS NO CR√çTICO
        const loadCSS = (href, id) => {
            if (!document.getElementById(id)) {
                const link = document.createElement('link');
                link.id = id;
                link.rel = 'stylesheet';
                link.href = href;
                link.media = 'print';
                link.onload = function() { 
                    this.media = 'all'; 
                    console.log(`üé® CSS ${id} cargado`);
                };
                document.head.appendChild(link);
            }
        };
        
        // Cargar CSS no cr√≠tico despu√©s del DOM
        document.addEventListener('DOMContentLoaded', () => {
            loadCSS('css/styles.css', 'styles-css');
            loadCSS('css/optimized.css', 'optimized-css');
        });
    </script>
</head>
<body>
    <!-- üåå LOADING SCREEN √âPICO -->
    <div id="nebula-loading" class="nebula-loading">
        <div class="text-center">
            <div class="nebula-logo">üåå Nebula</div>
            <div class="text-lg font-medium text-nebula-300 mt-4">Inicializando tu universo financiero...</div>
            <div class="nebula-spinner mx-auto"></div>        </div>
    </div>

    <!-- üåå APLICACI√ìN PRINCIPAL - Container √âpico -->
    <div id="app-container">
        <div id="parallax-bg" class="fixed inset-0 z-0 perspective-[1000px]"></div>
        <main id="content-root" class="relative z-10 pb-24 nebula-fade-in" aria-label="Contenido principal de la aplicaci√≥n"></main>
        <div id="dock-root" class="fixed bottom-0 left-0 right-0 z-20"></div>
        <div id="modal-root" class="fixed inset-0 z-50 pointer-events-none"></div>

        <!-- üé≠ SISTEMA DE MODALES ELEGANTE -->
        <div id="nebula-modal-overlay" class="nebula-modal-overlay">
            <div class="nebula-modal">
                <div class="nebula-modal-header">
                    <div id="nebula-modal-icon" class="nebula-modal-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <h3 id="nebula-modal-title" class="nebula-modal-title">Confirmaci√≥n</h3>
                </div>
                <div id="nebula-modal-content" class="nebula-modal-content">
                    ¬øEst√°s seguro de que deseas realizar esta acci√≥n?
                </div>
                <div class="nebula-modal-actions">
                    <button id="nebula-modal-cancel" class="nebula-modal-button secondary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancelar
                    </button>
                    <button id="nebula-modal-confirm" class="nebula-modal-button primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
        <div id="notification-container" class="notification-container"></div>
    </div>    <!-- üîí SEGURIDAD CR√çTICA - Carga Prioritaria -->
    <!-- üîê CryptoJS - Biblioteca de criptograf√≠a -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js" 
            integrity="sha512-a+SUDuwNzXDvz4XrIcXHuCf089/iJAoN4lmrXJg18XnduKK6YlDHNRalv4yd1N40OKI80tFidF+rqTFKGPoWFQ==" 
            crossorigin="anonymous" 
            referrerpolicy="no-referrer">
    </script>
    <script>
        // üîí Verificar que CryptoJS se carg√≥ correctamente
        if (typeof CryptoJS === 'undefined') {
            console.warn('‚ö†Ô∏è CryptoJS no se carg√≥ desde CDN, creando fallback...');
            window.CryptoJS = {
                AES: {
                    encrypt: (data, key) => btoa(data + '|' + key),
                    decrypt: (encrypted, key) => {
                        try {
                            const decoded = atob(encrypted);
                            return decoded.split('|')[0];
                        } catch {
                            return encrypted;
                        }
                    }
                },
                enc: {
                    Utf8: {
                        stringify: (data) => data,
                        parse: (data) => data
                    }
                }
            };
            console.log('üîß Fallback CryptoJS activado');
        } else {
            console.log('‚úÖ CryptoJS cargado exitosamente');
        }    </script>
    
    <!-- üî• FIREBASE - Sistema de Autenticaci√≥n -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
        import { 
            getAuth, 
            GoogleAuthProvider, 
            signInWithPopup, 
            signOut, 
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
        
        // üîß Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCk9hfIQXFQoPplvcdWqM62dbpl5L5Hzcg",
            authDomain: "nebula-v2-94054.firebaseapp.com",
            projectId: "nebula-v2-94054",
            storageBucket: "nebula-v2-94054.firebasestorage.app",
            messagingSenderId: "1052460930493",
            appId: "1:1052460930493:web:3c7b8c8e8c9f4e5f6g7h8i"
        };
        
        // üöÄ Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const googleProvider = new GoogleAuthProvider();
        
        // ‚úÖ Exponer Firebase globalmente
        window.firebaseAuth = auth;
        window.googleProvider = googleProvider;
        window.signInWithPopup = signInWithPopup;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        
        console.log('üî• Firebase inicializado correctamente');
        
        // üéØ Trigger evento para indicar que Firebase est√° listo
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>
    
    <!-- üîê Sistema de Autenticaci√≥n Nebula -->
    <script src="nebula-auth.js"></script>
    
    <script src="js/utils/security.js"></script>
    <script src="js/utils/input-validation.js"></script>
    
    <!-- üöÄ SISTEMA DE CARGA MODULAR √âPICO -->
    <script>
        // üéØ M√ìDULOS NEBULA - Configuraci√≥n Inteligente
        const NEBULA_MODULES = {            // üî• CR√çTICOS - Carga inmediata
            critical: [
                'js/modules/dashboard.js',
                'js/modules/dock-navigation.js',
                'js/components/shortcuts.js',
                'js/components/notifications.js',
                'js/components/modals.js'
            ],
            // ‚ö° IMPORTANTES - Carga r√°pida
            important: [
                'js/modules/settings.js',
                'js/modules/grid-cards.js'
            ],            // üåü FUNCIONALES - Carga diferida
            functional: [
                'js/modules/income.js',
                'js/modules/expenses.js',
                'js/modules/goals.js',
                'js/modules/investments.js',
                'js/modules/debts.js'            ],
              // üé® EXTRAS - Calendario minimalista y componentes adicionales
            extras: [
                'js/components/calendar-minimal.js'
            ]
        };
        
        // üöÄ CARGADOR MODULAR INTELIGENTE
        class NebulaModuleLoader {
            constructor() {
                this.loaded = new Set();
                this.loading = new Map();
                this.totalModules = Object.values(NEBULA_MODULES).flat().length;
                this.loadedCount = 0;
            }
              async loadModule(src) {
                if (this.loaded.has(src)) return true;
                if (this.loading.has(src)) return this.loading.get(src);
                
                const promise = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    // üî• CACHE-BUST AGRESIVO
                    script.src = `${src}?v=${Date.now()}&cb=${Math.random()}`;
                    script.async = true;
                    
                    script.onload = () => {
                        this.loaded.add(src);
                        this.loadedCount++;
                        this.updateProgress();
                        console.log(`‚úÖ ${src.split('/').pop()} cargado (${this.loadedCount}/${this.totalModules})`);
                        resolve(true);
                    };
                    
                    script.onerror = () => {
                        console.error(`‚ùå Error cargando ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    };
                    
                    document.head.appendChild(script);
                });
                
                this.loading.set(src, promise);
                return promise;
            }
            
            async loadModuleGroup(group, groupName) {
                console.log(`üöÄ Cargando grupo ${groupName}...`);
                const promises = group.map(src => this.loadModule(src));
                
                try {
                    await Promise.all(promises);
                    console.log(`‚úÖ Grupo ${groupName} completado`);
                    return true;
                } catch (error) {
                    console.error(`‚ùå Error en grupo ${groupName}:`, error);
                    return false;
                }
            }
            
            updateProgress() {
                const progress = (this.loadedCount / this.totalModules) * 100;
                const progressText = document.querySelector('#nebula-loading .text-lg');
                if (progressText) {
                    progressText.textContent = `Cargando m√≥dulos... ${Math.round(progress)}%`;
                }
                
                // Ocultar loading cuando est√© completo
                if (this.loadedCount === this.totalModules) {
                    setTimeout(() => this.hideLoading(), 500);
                }
            }
            
            hideLoading() {
                const loading = document.getElementById('nebula-loading');
                if (loading) {
                    loading.classList.add('hidden');
                    setTimeout(() => loading.remove(), 500);
                }
                console.log('üéâ Todos los m√≥dulos cargados - UI lista');
            }
            
            async loadAll() {
                try {
                    // üî• Fase 1: M√≥dulos cr√≠ticos (paralelo)
                    await this.loadModuleGroup(NEBULA_MODULES.critical, 'CR√çTICO');
                    
                    // ‚ö° Fase 2: M√≥dulos importantes (paralelo)
                    await this.loadModuleGroup(NEBULA_MODULES.important, 'IMPORTANTE');
                    
                    // üåü Fase 3: M√≥dulos funcionales (paralelo con delay)
                    setTimeout(() => {
                        this.loadModuleGroup(NEBULA_MODULES.functional, 'FUNCIONAL');
                    }, 100);
                    
                    // üé® Fase 4: M√≥dulos extras (bajo demanda)
                    setTimeout(() => {
                        this.loadModuleGroup(NEBULA_MODULES.extras, 'EXTRAS');
                    }, 500);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico cargando m√≥dulos:', error);
                    return false;
                }
            }
        }
        
        // üöÄ INICIALIZAR CARGA INTELIGENTE
        const moduleLoader = new NebulaModuleLoader();
        window.nebulaModuleLoader = moduleLoader; // Disponible globalmente
        
        // Iniciar carga cuando DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => moduleLoader.loadAll());
        } else {
            moduleLoader.loadAll();
        }
    </script>
      <!-- üåå APLICACI√ìN PRINCIPAL - Motor de Inicializaci√≥n -->
    <script type="module">
        // üöÄ NEBULA FINANCIAL v3.0 - LABORATORIO √âPICO        console.log('üåå Iniciando Nebula Financial v3.0 - LABORATORIO √âPICO');
        
        // üïê Marca de tiempo para performance
        window.nebulaStartTime = Date.now();
        
        // üåü FUNCIONES GLOBALES CR√çTICAS - Exponer ANTES de cargar m√≥dulos
        const formatNumberWithDots = (value) => {
            if (!value) return '';
            const numStr = value.toString().replace(/\D/g, '');
            return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        };
        
        const formatCurrency = (value) => value != null ? `$${formatNumberWithDots(value)}` : '$0';
        
        // Exponer globalmente INMEDIATAMENTE
        window.formatCurrency = formatCurrency;
        window.formatNumberWithDots = formatNumberWithDots;
        window.parseNumberWithDots = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        };
        
        console.log('‚úÖ Funciones globales cr√≠ticas expuestas');
        
        // üîí INICIALIZAR SEGURIDAD CR√çTICA
        if (typeof NebulaSecurityUtils !== 'undefined') {
            NebulaSecurityUtils.init();
            console.log('üîí Sistema de seguridad Nebula inicializado');
        }
        
        if (typeof NebulaInputValidator !== 'undefined') {
            console.log('üîí Sistema de validaci√≥n de entrada inicializado');
        }
        
        // üéØ TIMESTAMP Y VERSION TRACKING
        const buildTimestamp = Date.now();
        console.log('üïê TIMESTAMP CARGA:', new Date().toISOString(), 'Cache-bust activo');
        console.log('üîÑ VERSION C√ìDIGO:', `v3.0_LAB_EPIC_${buildTimestamp}`);
        console.log('üöÄ OPTIMIZACIONES √âPICAS APLICADAS');
          // üåü FUNCI√ìN DE ESPERA INTELIGENTE PARA M√ìDULOS (CON TIMEOUT DE SEGURIDAD)
        const waitForModules = () => {
            return new Promise((resolve) => {
                let attempts = 0;
                const maxAttempts = 60; // 3 segundos m√°ximo (60 * 50ms)
                
                const checkModules = () => {
                    attempts++;
                    
                    if (window.nebulaModuleLoader && window.nebulaModuleLoader.loadedCount >= 4) {
                        console.log('‚úÖ M√≥dulos cargados exitosamente');
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        console.log('‚ö° Timeout de m√≥dulos - Continuando con inicializaci√≥n b√°sica');
                        resolve(); // Continuar aunque no todos los m√≥dulos est√©n listos
                    } else {
                        setTimeout(checkModules, 50);
                    }
                };
                checkModules();
            });
        };        // üöÄ INICIALIZACI√ìN √âPICA DE LA APLICACI√ìN (CON PROTECCI√ìN ANTI-LOOP)
        const initNebulaEpic = async () => {
            try {
                console.log('‚è≥ Esperando m√≥dulos cr√≠ticos...');
                await waitForModules();
                
                // üéØ IMPORTAR THEMES CON FALLBACK DE SEGURIDAD
                try {
                    const { THEMES } = await import('./js/utils/helpers.js');
                    window.THEMES = THEMES;
                    console.log('‚úÖ THEMES cargado exitosamente');
                } catch (themeError) {
                    console.warn('‚ö†Ô∏è Error cargando THEMES, usando fallback:', themeError);
                    // Fallback b√°sico para THEMES
                    window.THEMES = {
                        current: 'dark',
                        available: ['dark', 'light']
                    };
                }
                
                console.log('‚úÖ Iniciando aplicaci√≥n...');
                
                // üöÄ INICIALIZAR APLICACI√ìN - startNebula har√° el resto
                startNebula();
                
                console.log('üéâ Nebula Financial inicializado correctamente');
                
                // ‚ú® EFECTOS VISUALES √âPICOS POST-CARGA
                document.body.classList.add('nebula-loaded');
                
                // üß™ EJECUTAR VALIDACI√ìN AUTOM√ÅTICA
                setTimeout(() => validateNebula(), 1000);
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                console.error('üìä Stack trace:', error.stack);
                
                // üîç DIAGN√ìSTICO DETALLADO
                console.log('üîç Diagn√≥stico del error:');
                console.log('- DOM ready state:', document.readyState);
                console.log('- M√≥dulos cargados:', window.nebulaModuleLoader?.loadedCount || 0);
                console.log('- THEMES disponible:', typeof window.THEMES !== 'undefined');
                console.log('- appState disponible:', typeof window.appState !== 'undefined');
                
                // üÜò FALLBACK INTELIGENTE CON REINTENTOS
                let retryCount = parseInt(sessionStorage.getItem('nebula_retry_count') || '0');
                if (retryCount < 3) {
                    retryCount++;
                    sessionStorage.setItem('nebula_retry_count', retryCount.toString());
                    console.log(`üîÑ Reintento ${retryCount}/3 en 2 segundos...`);
                    
                    setTimeout(() => {
                        console.log('üîÑ Recargando aplicaci√≥n...');
                        window.location.reload();
                    }, 2000);
                } else {
                    console.log('‚ùå M√°ximo de reintentos alcanzado, mostrando error cr√≠tico');
                    sessionStorage.removeItem('nebula_retry_count');
                    showCriticalError(error);
                }
            }
        };
        
        // üÜò FUNCI√ìN PARA MOSTRAR ERROR CR√çTICO
        function showCriticalError(error) {
            document.body.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); color: white; font-family: 'Inter', Arial, sans-serif;">
                    <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.4); border-radius: 20px; backdrop-filter: blur(10px); max-width: 600px;">
                        <h1 style="font-size: 4rem; margin-bottom: 1rem;">üåå</h1>
                        <h2 style="font-size: 2.5rem; margin-bottom: 1rem; color: #e2e8f0;">Nebula Financial</h2>
                        <p style="margin-bottom: 1.5rem; color: #cbd5e1; font-size: 1.2rem;">Error cr√≠tico detectado</p>
                        
                        <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); padding: 20px; border-radius: 10px; margin-bottom: 2rem; text-align: left;">
                            <h3 style="color: #ef4444; margin-bottom: 10px; font-size: 1.1rem;">üö® Detalles del Error:</h3>
                            <code style="color: #fcd34d; font-family: monospace; font-size: 0.9rem; line-height: 1.4; display: block; white-space: pre-wrap;">${error.message}</code>
                        </div>
                        
                        <div style="background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.4); padding: 15px; border-radius: 10px; margin-bottom: 2rem; text-align: left;">
                            <h4 style="color: #60a5fa; margin-bottom: 8px;">üîß Informaci√≥n del Sistema:</h4>
                            <small style="color: #e2e8f0; font-family: monospace; line-height: 1.3;">
                                Navegador: ${navigator.userAgent}<br>
                                Hora: ${new Date().toLocaleString()}<br>
                                URL: ${window.location.href}
                            </small>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <button onclick="location.reload()" style="background: linear-gradient(45deg, #22c55e, #16a34a); border: none; color: white; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); transition: transform 0.2s; min-width: 140px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üîÑ Recargar App
                            </button>
                            <button onclick="if(typeof NebulaSecurityUtils !== 'undefined') { NebulaSecurityUtils.clearSecurityData(); } else { localStorage.clear(); } sessionStorage.clear(); location.reload()" style="background: linear-gradient(45deg, #f59e0b, #d97706); border: none; color: white; padding: 16px 32px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); transition: transform 0.2s; min-width: 140px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üóëÔ∏è Reset Total
                            </button>
                        </div>
                        
                        <p style="margin-top: 2rem; color: #94a3b8; font-size: 0.9rem;">
                            Si el problema persiste, contacta al soporte t√©cnico
                        </p>
                    </div>
                </div>
            `;
        }
        
        // üéØ INICIALIZAR CUANDO TODO EST√â LISTO
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNebulaEpic);
        } else {
            initNebulaEpic();
        }
        
        // üîí FUNCIONES DE SEGURIDAD - Protecci√≥n XSS
        /**
         * Sanitiza strings para prevenir ataques XSS
         * @param {string} str - String a sanitizar
         * @returns {string} String sanitizado
         */        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Exponer sanitizeHTML globalmente para los m√≥dulos
        window.sanitizeHTML = sanitizeHTML;

        /**
         * Sanitiza objetos con propiedades de texto
         * @param {object} obj - Objeto a sanitizar
         * @returns {object} Objeto sanitizado
         */
        function sanitizeObject(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const sanitized = {};
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string') {
                    sanitized[key] = sanitizeHTML(value);
                } else if (typeof value === 'object') {
                    sanitized[key] = sanitizeObject(value);
                } else {
                    sanitized[key] = value;
                }
            }
            return sanitized;
        }

        /**
         * Establece innerHTML de forma segura
         * @param {Element} element - Elemento DOM
         * @param {string} html - HTML a insertar (ser√° sanitizado si contiene entrada de usuario)
         * @param {boolean} trusted - Si el HTML viene de c√≥digo confiable (default: true)
         */
        function safeSetInnerHTML(element, html, trusted = true) {
            if (!element) return;
            if (trusted) {
                element.innerHTML = html; // HTML confiable del c√≥digo de la app
            } else {
                element.textContent = html; // Entrada de usuario - solo texto
            }
        }

        /**
         * üé® DEFINICI√ìN DE TEMAS VISUALES
         * Cada tema define colores, gradientes y efectos de part√≠culas √∫nicos
         * Todos centrados alrededor del SOL como estrella principal de la aplicaci√≥n
         */
        const THEMES = {            aureoAmanecer: { 
                name: '√Åureo Amanecer', 
                gradient: 'radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffd700\' fill-opacity=\'0.1\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-amber-300', 
                accentBg: 'bg-amber-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,191,36,0.8)]', 
                accentColor: '#FCD34D', 
                accentBorder: 'border-amber-300', 
                accentRing: 'focus:ring-amber-300', 
                positive: 'text-emerald-300', 
                negative: 'text-rose-300', 
                surface: 'bg-black/20 border-amber-200/30 backdrop-blur-md', 
                textPrimary: 'text-amber-50', 
                textSecondary: 'text-amber-200/80', 
                particleType: 'goldenDust',
                sunColor: '#FFD700'
            },            crisonVespertino: { 
                name: 'Cris√≥n Vespertino', 
                gradient: 'radial-gradient(ellipse at center, #2d1b3d 0%, #4a1942 40%, #1a0f1a 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ff6b9d\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-rose-300', 
                accentBg: 'bg-rose-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,113,133,0.8)]', 
                accentColor: '#FB7185', 
                accentBorder: 'border-rose-300', 
                accentRing: 'focus:ring-rose-300', 
                positive: 'text-teal-300', 
                negative: 'text-orange-300', 
                surface: 'bg-black/20 border-rose-200/30 backdrop-blur-md', 
                textPrimary: 'text-rose-50', 
                textSecondary: 'text-rose-200/80', 
                particleType: 'crimsonMist',
                sunColor: '#FF4C6A'
            },            aguamarinaCeleste: { 
                name: 'Aguamarina Celeste', 
                gradient: 'radial-gradient(ellipse at center, #0f2027 0%, #203a43 40%, #0c1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%2367e8f9\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-cyan-300', 
                accentBg: 'bg-cyan-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(103,232,249,0.8)]', 
                accentColor: '#67E8F9', 
                accentBorder: 'border-cyan-300', 
                accentRing: 'focus:ring-cyan-300', 
                positive: 'text-lime-300', 
                negative: 'text-amber-300', 
                surface: 'bg-black/20 border-cyan-200/30 backdrop-blur-md', 
                textPrimary: 'text-cyan-50', 
                textSecondary: 'text-cyan-200/80', 
                particleType: 'aquaFlow',
                sunColor: '#00CED1'
            },            violetaReal: { 
                name: 'Violeta Real', 
                gradient: 'radial-gradient(ellipse at center, #1e1b4b 0%, #312e81 40%, #111827 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23a855f7\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-purple-300', 
                accentBg: 'bg-purple-500', 
                accentGlow: 'shadow-[0_0_25px_rgba(168,85,247,0.8)]', 
                accentColor: '#A855F7', 
                accentBorder: 'border-purple-300', 
                accentRing: 'focus:ring-purple-300', 
                positive: 'text-green-300', 
                negative: 'text-red-300', 
                surface: 'bg-black/20 border-purple-200/30 backdrop-blur-md', 
                textPrimary: 'text-purple-50', 
                textSecondary: 'text-purple-200/80', 
                particleType: 'royalAura',
                sunColor: '#8B5CF6'
            }
        };/**
         * üéØ ICONOS SVG VECTORIALES
         * Conjunto de iconos optimizados para la interfaz
         */
        const ICONS = {            dashboard: `<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/>`,
            income: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4-4 4 4"/><path d="M12 8v8"/>`,
            expenses: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/>`,
            goals: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1"/>`,
            investments: `<path d="M3 3v18h18"/><path d="m4 14 4-4 4 4 6-6"/>`,
            debts: `<rect x="1" y="4" width="22" height="16" rx="3" ry="3"/><line x1="1" y1="10" x2="23" y2="10"/>`,
            achievements: `<path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>`,
            settings: `<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`,
            plus: `<path d="M12 5v14m-7-7h14" />`,
            trash: `<path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>`,
            eye: `<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>`,
            eyeOff: `<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 11 8 11 8a18.35 18.35 0 0 1-2.18 3.2M3.5 12a10.43 10.43 0 0 1 2.22-3.2"/><path d="M1 1l22 22"/>`,
            chevronLeft: `<path d="m15 18-6-6 6-6"/>`,
            chevronRight: `<path d="m9 18 6-6-6-6"/>`,
            history: `<path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>`,
            mail: `<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>`,
            zap: `<path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>`,            x: `<path d="M18 6 6 18M6 6l12 12"/>`,
              // üìÖ Iconos de calendario mejorados y m√°s atractivos
            calendar: `<rect x="3" y="4" width="18" height="18" rx="3" ry="3" fill="none" stroke="currentColor" stroke-width="2"/><path d="M8 2v4M16 2v4" stroke="currentColor" stroke-width="2"/><rect x="3" y="10" width="18" height="2" fill="currentColor"/><circle cx="8" cy="16" r="1.5" fill="currentColor"/><circle cx="12" cy="16" r="1.5" fill="currentColor"/><circle cx="16" cy="16" r="1.5" fill="currentColor"/>`,
            calendarDays: `<rect x="3" y="4" width="18" height="18" rx="3" ry="3"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="m14 18 2 2 4-4"/>`,
            calendarCheck: `<rect x="3" y="4" width="18" height="18" rx="3" ry="3"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><path d="m9 16 2 2 4-4"/>`,
            
            check: `<polyline points="20 6 9 17 4 12"/>`,
            alertCircle: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/>`,
            info: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/>`,
            alertTriangle: `<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/>`,
            repeat: `<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
            copy: `<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>`,
            logOut: `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>`,
            download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>`
        };
        
        /**
         * üìÇ CATEGOR√çAS DE GASTOS DISPONIBLES
         * Lista predefinida para categorizaci√≥n de transacciones
         */
        const CATEGORIES = ['Comida', 'Transporte', 'Ocio', 'Hogar', 'Salud', 'Educaci√≥n', 'Regalos', 'Varios'];        // ===============================================
        // üîî SISTEMA DE NOTIFICACIONES MODERNO
        // ===============================================
        
        /**
         * üì¢ Gestor de Notificaciones
         * Sistema completo para mostrar mensajes al usuario de forma no invasiva
         */
        const NotificationSystem = {
            container: null,
            
            init() {
                this.container = document.getElementById('notification-container');
            },
            
            /**
             * Muestra una notificaci√≥n
             * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
             * @param {string} title - T√≠tulo de la notificaci√≥n
             * @param {string} message - Mensaje descriptivo
             * @param {number} duration - Duraci√≥n en ms (default: 4000)
             */
            show(type = 'info', title = '', message = '', duration = 4000) {
                if (!this.container) this.init();
                
                const id = Date.now().toString();
                const iconMap = {
                    success: ICONS.check,
                    error: ICONS.alertCircle,
                    warning: ICONS.alertTriangle,
                    info: ICONS.info
                };
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                  notification.innerHTML = `
                    <button class="notification-close" onclick="NotificationSystem.remove('${id}')" aria-label="Cerrar notificaci√≥n" role="button">
                        ${createIcon(ICONS.x, 'w-4 h-4')}
                    </button>
                    <div class="notification-header">
                        ${createIcon(iconMap[type] || iconMap.info, 'w-5 h-5')}
                        <span>${title}</span>
                    </div>
                    <div class="notification-body">${message}</div>
                `;
                
                this.container.appendChild(notification);
                
                // Trigger animation
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });
                
                // Auto remove
                if (duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }
                
                return id;
            },
            
            remove(id) {
                const notification = document.getElementById(`notification-${id}`);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }
            },
            
            // M√©todos convenientes
            success(title, message, duration) {
                return this.show('success', title, message, duration);
            },
            
            error(title, message, duration) {
                return this.show('error', title, message, duration);
            },
            
            warning(title, message, duration) {
                return this.show('warning', title, message, duration);
            },
            
            info(title, message, duration) {
                return this.show('info', title, message, duration);
            }
        };
        
        /**
         * üéÆ GESTOR CENTRAL DEL ESTADO
         * Maneja toda la l√≥gica de negocio y persistencia de datos
         */
        const appState = {
            // --- Estado de Usuario y Sesi√≥n ---
            user: JSON.parse(sessionStorage.getItem('financialUser')) || null,
            isLoading: false,
            activeView: 'dashboard',
            activeModal: null,
              // --- Configuraci√≥n y Preferencias ---
            isPrivate: (() => {
                try {
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('isPrivateMode', true) :
                        JSON.parse(localStorage.getItem('isPrivateMode')) ?? true;
                } catch { return true; }
            })(),
            themeKey: (() => {
                try {
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('financialTheme', 'aureoAmanecer') :
                        localStorage.getItem('financialTheme') || 'aureoAmanecer';
                } catch { return 'aureoAmanecer'; }
            })(),
            
            // --- Estado Temporal de Navegaci√≥n ---
            currentDate: new Date(),
            // calendarViewYear eliminado - sin calendarios
              // --- Datos Financieros Principales ---
            data: (() => {
                try {
                    const defaultData = { transactions: {}, goals: [], investments: [], debts: [] };
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('financialData', defaultData) :
                        JSON.parse(localStorage.getItem('financialData')) || defaultData;
                } catch { 
                    return { transactions: {}, goals: [], investments: [], debts: [] }; 
                }
            })(),
              // --- Getters Computados ---
            get theme() { 
                return THEMES[this.themeKey]; 
            },
            
            get currentMonthKey() { 
                return `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}`; 
            },
            
            // üé® M√©todo para obtener tema actual (compatibilidad con m√≥dulos)
            getCurrentTheme() {
                return this.theme;
            },
              // --- Persistencia de Datos ---
            saveState() {
                try {
                    if (NebulaSecurityUtils) {
                        // Usar almacenamiento seguro cifrado
                        NebulaSecurityUtils.secureSetItem('financialTheme', this.themeKey);
                        NebulaSecurityUtils.secureSetItem('financialData', this.data);
                        NebulaSecurityUtils.secureSetItem('isPrivateMode', this.isPrivate);
                        console.log('üîí Estado guardado de forma segura');
                    } else {
                        // Fallback a localStorage normal
                        localStorage.setItem('financialTheme', this.themeKey);
                        localStorage.setItem('financialData', JSON.stringify(this.data));
                        localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                        console.log('‚ö†Ô∏è Estado guardado sin cifrado (fallback)');
                    }
                } catch (error) {
                    console.error('‚ùå Error guardando estado:', error);
                    // √öltimo recurso: localStorage directo
                    localStorage.setItem('financialTheme', this.themeKey);
                    localStorage.setItem('financialData', JSON.stringify(this.data));
                    localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                }
            },
              // --- Autenticaci√≥n ---
            async login(method) {
                if (method === 'google') {
                    // üîê Login con Google usando Firebase
                    if (window.NebulaAuth) {
                        try {
                            this.isLoading = true;
                            renderApp();
                            
                            console.log('üîê Intentando login con Google...');
                            const userCredential = await window.NebulaAuth.loginWithGoogle();
                            
                            if (userCredential && userCredential.user) {
                                this.user = {
                                    name: userCredential.user.displayName || 'Usuario de Google',
                                    email: userCredential.user.email,
                                    photo: userCredential.user.photoURL,
                                    uid: userCredential.user.uid
                                };
                                sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                                console.log('‚úÖ Login exitoso:', this.user.name);
                            }
                        } catch (error) {
                            console.error('‚ùå Error en login con Google:', error);
                            // Fallback a modo invitado
                            this.user = { name: 'Invitado (Error en login)' };
                            sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                        } finally {
                            this.isLoading = false;
                            renderApp();
                        }
                    } else {
                        console.warn('‚ö†Ô∏è NebulaAuth no disponible, usando fallback');
                        // Fallback cuando NebulaAuth no est√° disponible
                        this.isLoading = true;
                        renderApp();
                        setTimeout(() => {
                            this.user = { name: 'Usuario de Correo (Fallback)' };
                            sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                            this.isLoading = false;
                            renderApp();
                        }, 1500);
                    }
                } else if (method === 'guest') {
                    // üë§ Modo invitado
                    this.isLoading = true;
                    renderApp();
                    setTimeout(() => {
                        this.user = { name: 'Invitado' };
                        sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                        this.isLoading = false;
                        renderApp();
                    }, 1000);
                }
            },
            
            // --- Configuraci√≥n Visual ---
            setTheme(key) { 
                this.themeKey = key; 
                this.saveState(); 
                renderApp(); 
            },
            
            setView(view) { 
                this.activeView = view; 
                renderApp(); 
            },
            
            togglePrivacy() { 
                this.isPrivate = !this.isPrivate; 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Navegaci√≥n Temporal ---
            changeMonth(direction) { 
                this.currentDate.setMonth(this.currentDate.getMonth() + direction); 
                renderApp(); 
            },
              // setCalendarDate eliminado - sin calendarios
              // --- Gesti√≥n de Modales ---
            openModal(modalType) {                if (modalType === 'calendar') {
                    // üìÖ Usar el nuevo calendario minimalista
                    if (typeof openCalendar === 'function') {
                        openCalendar();
                        return;
                    } else {
                        console.warn('‚ö†Ô∏è Calendario minimalista no disponible a√∫n');
                        return;
                    }
                }
                this.activeModal = modalType;
                renderModal();
            },
            
            closeModal(shouldRenderAppAfter = false) {
                const modalContainer = document.querySelector('.modal-container');
                if (modalContainer) {
                    modalContainer.classList.remove('modal-enter');
                    modalContainer.classList.add('modal-leave');
                    modalContainer.addEventListener('animationend', () => {
                        this.activeModal = null;
                        renderModal(); 
                        if (shouldRenderAppAfter) renderApp();
                    }, { once: true });
                } else {
                     this.activeModal = null;
                     if (shouldRenderAppAfter) renderApp();
                }
            },// --- Gesti√≥n de Transacciones ---
            addTransaction(t) {
                const key = this.currentMonthKey;
                if (!this.data.transactions[key]) this.data.transactions[key] = [];
                this.data.transactions[key].push({ 
                    ...t, 
                    id: Date.now(), 
                    date: new Date().toISOString() 
                });
                this.saveState();
                renderApp();
            },
            
            deleteTransaction(id) {
                const key = this.currentMonthKey;
                if(this.data.transactions[key]) {
                    this.data.transactions[key] = this.data.transactions[key].filter(t => t.id !== id);
                    this.saveState();
                    renderApp();
                }
            },
              repeatPreviousMonth(type) {
                const prevDate = new Date(this.currentDate);
                prevDate.setMonth(prevDate.getMonth() - 1);
                const prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
                const prevTransactions = this.data.transactions[prevKey] || [];
                const transactionsToCopy = prevTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length > 0) {
                    transactionsToCopy.forEach(t => this.addTransaction({ 
                        ...t, 
                        date: new Date().toISOString() 
                    }));
                    NotificationSystem.success('√âxito', 
                        `Se copiaron ${transactionsToCopy.length} transacciones del mes anterior`);
                } else {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones del mes anterior para copiar');
                }
            },
            
            /**
             * üìÖ Repite transacciones actuales hasta fin de a√±o
             * @param {string} type - Tipo de transacci√≥n ('income' o 'expense')
             */
            repeatYearlyFromCurrent(type) {
                const currentTransactions = this.data.transactions[this.currentMonthKey] || [];
                const transactionsToCopy = currentTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length === 0) {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones en el mes actual para copiar');
                    return;
                }
                
                const currentYear = this.currentDate.getFullYear();
                const currentMonth = this.currentDate.getMonth();
                let totalCopied = 0;
                
                // Copiar a todos los meses restantes del a√±o
                for (let month = currentMonth + 1; month < 12; month++) {
                    const targetKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                    
                    if (!this.data.transactions[targetKey]) {
                        this.data.transactions[targetKey] = [];
                    }
                    
                    transactionsToCopy.forEach(t => {
                        const newTransaction = {
                            ...t,
                            id: Date.now() + Math.random(), // ID √∫nico
                            date: new Date(currentYear, month, new Date(t.date).getDate()).toISOString()
                        };
                        this.data.transactions[targetKey].push(newTransaction);
                        totalCopied++;
                    });
                }
                
                if (totalCopied > 0) {
                    this.saveState();
                    NotificationSystem.success('√âxito', 
                        `Se copiaron ${totalCopied} transacciones hasta fin de a√±o`);
                } else {
                    NotificationSystem.info('Sin cambios', 
                        'Ya es diciembre o no hay meses restantes');
                }
            },
            
            // --- Gesti√≥n de Metas ---
            addGoal(g) { 
                this.data.goals.push({ 
                    ...g, 
                    id: Date.now(), 
                    saved: 0 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteGoal(id) { 
                this.data.goals = this.data.goals.filter(goal => goal.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Gesti√≥n de Inversiones ---
            addInvestment(i) { 
                this.data.investments.push({ 
                    ...i, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteInvestment(id) { 
                this.data.investments = this.data.investments.filter(inv => inv.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            updateInvestment(id, newAmount) {
                const investment = this.data.investments.find(inv => inv.id === id);
                if (investment) investment.currentAmount = newAmount;
                this.saveState();
                if(this.activeView === 'investments') {
                    document.querySelector('#content-root > main').innerHTML = renderInvestmentsView();
                }
            },
            
            // --- Gesti√≥n de Deudas ---
            addDebt(d) { 
                this.data.debts.push({ 
                    ...d, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteDebt(id) { 
                this.data.debts = this.data.debts.filter(debt => debt.id !== id); 
                this.saveState(); 
                renderApp(); 
            }        };
        
        // üåê Exponer appState globalmente INMEDIATAMENTE
        window.appState = appState;
        console.log('‚úÖ appState expuesto globalmente');

        // ===============================================
        // üîß UTILIDADES Y FUNCIONES AUXILIARES
        // ===============================================
        /**
         * üî¢ Convierte n√∫mero formateado a n√∫mero plano
         * @param {string} value - Valor formateado con puntos
         * @returns {number} N√∫mero sin formato
         */
        const parseFormattedNumber = (value) => parseFloat(String(value).replace(/\./g, '')) || 0;
          // Exponer funciones adicionales globalmente
        window.parseFormattedNumber = parseFormattedNumber;
        
        /**
         * üé® SISTEMA DE VALIDACI√ìN VISUAL
         * CloudSonnet4: Sistema modular para mensajes de error elegantes
         */
        
        // Funci√≥n para mostrar error en campo espec√≠fico
        function showFieldError(inputElement, message) {
            if (!inputElement) return;
            
            // Remover error previo
            clearFieldError(inputElement);
            
            // Agregar clase de error al input
            inputElement.classList.add('input-error');
            inputElement.setAttribute('aria-invalid', 'true');
            
            // Crear mensaje de error
            const errorElement = document.createElement('div');
            errorElement.className = 'field-error-message';
            errorElement.id = `${inputElement.id || inputElement.name}-error`;
            errorElement.setAttribute('role', 'alert');
            errorElement.innerHTML = `
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                ${message}
            `;
            
            // Insertar despu√©s del input
            inputElement.parentNode.insertBefore(errorElement, inputElement.nextSibling);
            
            // Configurar aria-describedby
            inputElement.setAttribute('aria-describedby', errorElement.id);
            
            // Auto-clear cuando el usuario escriba
            const clearOnInput = () => {
                clearFieldError(inputElement);
                inputElement.removeEventListener('input', clearOnInput);
            };
            inputElement.addEventListener('input', clearOnInput);
        }
        
        // Funci√≥n para limpiar error de campo
        function clearFieldError(inputElement) {
            if (!inputElement) return;
            
            inputElement.classList.remove('input-error');
            inputElement.classList.add('input-success');
            inputElement.removeAttribute('aria-invalid');
            
            // Remover mensaje de error
            const errorId = `${inputElement.id || inputElement.name}-error`;
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.remove();
            }
            
            // Limpiar aria-describedby
            inputElement.removeAttribute('aria-describedby');
            
            // Remover clase success despu√©s de un tiempo
            setTimeout(() => {
                inputElement.classList.remove('input-success');
            }, 2000);
        }
        
        // Funci√≥n para validar campo obligatorio
        function validateField(inputElement, fieldName) {
            const value = inputElement.value.trim();
            if (!value) {
                showFieldError(inputElement, `Por favor ingresa ${fieldName}`);
                return false;
            }
            clearFieldError(inputElement);
            return true;
        }
        
        // Funci√≥n para validar formulario completo
        function validateForm(formElement) {
            const requiredFields = formElement.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                const fieldName = field.getAttribute('data-field-name') || 
                                 field.previousElementSibling?.textContent || 
                                 'este campo';
                
                if (!validateField(field, fieldName)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
          // CloudSonnet4: Exponer funciones globalmente para uso en m√≥dulos
        window.showFieldError = showFieldError;
        window.clearFieldError = clearFieldError;
        window.validateField = validateField;
        window.validateForm = validateForm;

        /**
         * üé≠ SISTEMA DE MODALES ELEGANTE
         * CloudSonnet4: Reemplazo profesional para alert() y confirm()
         */
        
        // Funci√≥n para mostrar modal de confirmaci√≥n
        function showConfirmModal(title, content, type = 'warning', options = {}) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('nebula-modal-overlay');
                const modalTitle = document.getElementById('nebula-modal-title');
                const modalContent = document.getElementById('nebula-modal-content');
                const modalIcon = document.getElementById('nebula-modal-icon');
                const cancelButton = document.getElementById('nebula-modal-cancel');
                const confirmButton = document.getElementById('nebula-modal-confirm');
                
                // Configurar contenido
                modalTitle.textContent = title;
                modalContent.innerHTML = content;
                
                // Configurar icono seg√∫n tipo
                modalIcon.className = `nebula-modal-icon ${type}`;
                if (type === 'danger') {
                    modalIcon.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    `;
                } else {
                    modalIcon.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    `;
                }
                
                // Configurar botones
                cancelButton.textContent = options.cancelText || 'Cancelar';
                confirmButton.textContent = options.confirmText || 'Confirmar';
                
                // Configurar estilo del bot√≥n de confirmar
                confirmButton.className = `nebula-modal-button ${type === 'danger' ? 'danger' : 'primary'}`;
                
                // Funci√≥n para cerrar modal
                const closeModal = () => {
                    overlay.classList.remove('active');
                    document.removeEventListener('keydown', handleKeydown);
                };
                
                // Manejar teclas
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        resolve(false);
                    } else if (e.key === 'Enter') {
                        closeModal();
                        resolve(true);
                    }
                };
                
                // Event listeners
                const handleCancel = () => {
                    closeModal();
                    resolve(false);
                };
                
                const handleConfirm = () => {
                    closeModal();
                    resolve(true);
                };
                
                // Limpiar listeners previos
                cancelButton.removeEventListener('click', handleCancel);
                confirmButton.removeEventListener('click', handleConfirm);
                
                // A√±adir listeners
                cancelButton.addEventListener('click', handleCancel);
                confirmButton.addEventListener('click', handleConfirm);
                document.addEventListener('keydown', handleKeydown);
                
                // Cerrar al hacer clic fuera del modal
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal();
                        resolve(false);
                    }
                });
                
                // Mostrar modal
                overlay.classList.add('active');
                
                // Focus en el bot√≥n de cancelar para accesibilidad
                setTimeout(() => cancelButton.focus(), 100);
            });
        }
        
        // Funciones de conveniencia para diferentes tipos de modales
        const showWarningModal = (title, content, options = {}) => 
            showConfirmModal(title, content, 'warning', options);
            
        const showDangerModal = (title, content, options = {}) => 
            showConfirmModal(title, content, 'danger', options);
        
        // CloudSonnet4: Exponer funciones globalmente
        window.showConfirmModal = showConfirmModal;
        window.showWarningModal = showWarningModal;
        window.showDangerModal = showDangerModal;
        
        /**
         * üé® Crea elemento SVG de icono
         * @param {string} path - Path del icono SVG
         * @param {string} className - Clases CSS adicionales
         * @returns {string} HTML del icono SVG
         */
        const createIcon = (path, className = "w-6 h-6") => 
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;

        // ===============================================
        // üèóÔ∏è REFERENCIAS DOM PRINCIPALES        // ===============================================
        // üéØ REFERENCIAS A ELEMENTOS DEL DOM (se inicializan m√°s tarde)
        // ===============================================
        
        let contentRoot, dockRoot, parallaxBg, modalRoot;// ===============================================
        // üñºÔ∏è FUNCIONES DE RENDERIZADO PRINCIPAL
        // ===============================================
          /**
         * üéØ RENDERIZADOR PRINCIPAL DE LA APLICACI√ìN
         * Controla el flujo de renderizado seg√∫n el estado actual
         */        function renderApp() {
            // Las part√≠culas de fondo se manejan directamente en parallax-bg
            parallaxBg.innerHTML = renderParallaxBackground();
            
            if (appState.isLoading) {
                contentRoot.innerHTML = renderLoadingScreen();
                dockRoot.innerHTML = '';
            } else if (!appState.user) {
                contentRoot.innerHTML = renderLoginView();
                dockRoot.innerHTML = '';
            } else {
                let viewHTML = '';
                
                // Agregar selector de mes para vistas que lo requieren
                if(!['settings', 'achievements', 'goals', 'investments', 'debts'].includes(appState.activeView)) {
                   viewHTML += renderMonthSelector();
                }                // Renderizar vista seg√∫n selecci√≥n activa
                switch (appState.activeView) {
                    case 'dashboard': 
                        viewHTML += window.NebulaDashboardModule ? window.NebulaDashboardModule.render() : renderDashboard(); 
                        break;
                    case 'income': 
                        viewHTML += window.NebulaIncomeModule ? window.NebulaIncomeModule.render() : renderTransactionsView('income'); 
                        break;
                    case 'expenses': 
                        viewHTML += window.NebulaExpensesModule ? window.NebulaExpensesModule.render() : renderTransactionsView('expense'); 
                        break;
                    case 'goals': 
                        viewHTML += window.NebulaGoalsModule ? window.NebulaGoalsModule.render() : renderGoalsView(); 
                        break;
                    case 'investments': 
                        viewHTML += window.NebulaInvestmentsModule ? window.NebulaInvestmentsModule.render() : renderInvestmentsView(); 
                        break;
                    case 'debts': 
                        viewHTML += window.NebulaDebtsModule ? window.NebulaDebtsModule.render() : renderDebtsView(); 
                        break;
                    case 'settings': 
                        viewHTML += window.NebulaSettingsModule ? window.NebulaSettingsModule.render() : renderSettingsView(); 
                        break;
                    default: 
                        viewHTML += renderComingSoon(appState.activeView);
                }
                
                contentRoot.innerHTML = `<main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto w-full view-transition">${viewHTML}</main>`;
                dockRoot.innerHTML = renderDock();
            }
            
            addEventListeners();
              // Actualizar glider despu√©s del renderizado
            setTimeout(() => updateDockGlider(), 100);
        }

        // üöÄ CloudSonnet4 - Funci√≥n global para cargar secciones (para uso de m√≥dulos)
        window.loadSection = function(sectionName) {
            if (sectionName && sectionName !== appState.activeView) {
                appState.activeView = sectionName;
            }
            window.currentSection = appState.activeView; // Para que los m√≥dulos sepan en qu√© secci√≥n est√°n
            renderApp();
        };

          // ===============================================
        // üé≠ FUNCIONES DE RENDERIZADO DE VISTAS ESPECIALES
        // ===============================================
        
        /**
         * üîê Vista de Login/Autenticaci√≥n
         */        function renderLoginView() {
            return `
                <div class="flex flex-col items-center justify-center h-screen login-card p-4" style="background-image: url('images/Fondo login Nebula.png'); background-size: cover; background-position: center; background-repeat: no-repeat;">
                    <div class="backdrop-blur-lg rounded-3xl shadow-2xl p-8 bg-white/10 border border-white/20 text-center w-full max-w-md">
                        <div class="mb-6">
                            <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-blue-400 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg">
                                <img src="images/NebulaICO.png" alt="Nebula" class="w-12 h-12">
                            </div>
                            <h1 class="text-4xl font-black text-white bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Nebula</h1>
                            <p class="mt-2 text-white/80 text-sm">Tu universo financiero personal</p>
                        </div>
                        <div class="space-y-4">
                            <button data-login-method="google" class="login-button w-full flex items-center justify-center gap-3 bg-white text-gray-700 font-medium py-3.5 px-6 rounded-lg hover:bg-gray-50 hover:shadow-md transition-all duration-200 transform hover:scale-[1.02] border border-gray-200 shadow-lg">
                                <svg viewBox="0 0 24 24" class="w-5 h-5 flex-shrink-0">
                                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                                </svg>
                                Continuar con Google
                            </button>
                            <button data-login-method="guest" class="login-button w-full bg-white/20 backdrop-blur-sm text-white font-medium py-3.5 px-6 rounded-lg hover:bg-white/30 transition-all duration-200 transform hover:scale-[1.02] border border-white/30 shadow-lg">
                                üöÄ Entrar como Invitado
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * ‚è≥ Pantalla de Carga con Animaci√≥n Orbital
         */
        function renderLoadingScreen() {
            return `
                <div class="fixed inset-0 flex flex-col items-center justify-center text-white z-50">
                    <div class="w-64 h-64 relative mb-8">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-yellow-400 rounded-full ${appState.theme.accentGlow}"></div>
                        <div class="absolute inset-0 animate-[spin_20s_linear_infinite]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-4 h-4 bg-red-500 rounded-full"></div>
                        </div>
                        <div class="absolute inset-4 animate-[spin_30s_linear_infinite_reverse]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-6 bg-blue-500 rounded-full"></div>
                        </div>
                        <div class="absolute inset-10 animate-[spin_45s_linear_infinite]">
                            <div class="absolute bottom-0 right-1/2 translate-x-1/2 w-5 h-5 bg-green-500 rounded-full"></div>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-white mb-2">Alineando las estrellas...</h1>
                    <p class="${appState.theme.textSecondary}">Cargando tu universo financiero.</p>
                </div>
            `;
        }
          /**
         * üìÖ Selector de Mes con Calendario Desplegable
         */        function renderMonthSelector() {
            const today = new Date();
            const currentDate = appState.currentDate;
            const monthName = currentDate.toLocaleString('es-ES', { month: 'long' });
            const year = currentDate.getFullYear();
            
            // Determinar si es pasado, presente o futuro
            let timeLabel = '';
            if (currentDate.getFullYear() < today.getFullYear() || 
                (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() < today.getMonth())) {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full bg-amber-500/20 text-amber-300 font-medium backdrop-blur-sm border border-amber-400/30">‚ú® PASADO</span>`;
            } else if (currentDate.getFullYear() > today.getFullYear() || 
                      (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() > today.getMonth())) {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full bg-cyan-500/20 text-cyan-300 font-medium backdrop-blur-sm border border-cyan-400/30">üöÄ FUTURO</span>`;
            } else {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full ${appState.theme.accentBg}/20 ${appState.theme.accent} font-medium backdrop-blur-sm border ${appState.theme.accentBorder}/30">üåü ACTUAL</span>`;
            }
              return `
                <div class="text-center mb-8 relative">
                    <!-- T√≠tulo principal centrado con efectos -->
                    <div class="flex flex-col items-center gap-3 mb-6">
                        <h1 class="text-3xl sm:text-4xl font-black ${appState.theme.textPrimary} capitalize relative">
                            <span class="relative z-10 bg-gradient-to-r from-${appState.theme.accent.replace('text-', '')} to-${appState.theme.accent.replace('text-', '')} bg-clip-text text-transparent filter drop-shadow-lg">
                                ${monthName} ${year}
                            </span>
                            <!-- Efecto de brillo sutil -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent blur-sm opacity-30 animate-pulse"></div>
                            <!-- Sombra de resplandor -->
                            <div class="absolute inset-0 ${appState.theme.accentGlow} opacity-20 blur-lg"></div>
                        </h1>
                        ${timeLabel}
                    </div>                    <!-- Bot√≥n del calendario elegante y moderno -->
                    <div class="absolute top-0 right-4">
                        <button onclick="openCalendar()" 
                                class="group relative p-4 bg-gradient-to-br from-slate-800 to-slate-900 
                                       border border-amber-400/30 rounded-2xl shadow-2xl 
                                       hover:shadow-amber-400/20 transition-all duration-200 
                                       hover:border-amber-400/60 active:scale-95"
                                title="Abrir Calendario (Tecla: C)">
                            
                            <!-- √çcono del calendario -->
                            <div class="w-7 h-7 text-amber-300 group-hover:text-amber-200 transition-colors duration-200">
                                ${createIcon(ICONS.calendar)}
                            </div>
                            
                            <!-- Indicador de atajo elegante -->
                            <div class="absolute -top-1 -right-1 w-5 h-5 bg-amber-400 text-slate-900 text-xs 
                                        font-bold rounded-lg flex items-center justify-center shadow-md
                                        group-hover:bg-amber-300 transition-all duration-200">
                                C
                            </div>
                            
                            <!-- Efecto de resplandor sutil -->
                            <div class="absolute inset-0 bg-amber-400/5 rounded-2xl opacity-0 
                                        group-hover:opacity-100 transition-opacity duration-200"></div>
                                        
                            <!-- Borde interior brillante -->
                            <div class="absolute inset-0 rounded-2xl border border-white/10 
                                        opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                        </button>
                    </div>
                      <!-- Controles de navegaci√≥n centrados -->
                    <div class="flex items-center justify-center gap-4">                        <button id="month-prev" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Mes anterior (‚Üê)" aria-label="Ir al mes anterior" role="button">
                            ${createIcon(ICONS.chevronLeft, "w-6 h-6")}
                        </button>
                        
                        <button id="month-next" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Mes siguiente (‚Üí)">
                            ${createIcon(ICONS.chevronRight, "w-6 h-6")}
                        </button>
                    </div>
                </div>
            `;
        }
          // ===============================================
        // ü™ü SISTEMA DE MODALES
        // ===============================================
        
        /**
         * üé≠ Renderizador Principal de Modales
         * Controla qu√© modal mostrar seg√∫n el estado activo
         */        function renderModal() {
            modalRoot.innerHTML = '';
            
            if (appState.activeModal === 'shortcuts') {
                modalRoot.innerHTML = renderShortcutsModal();
            }
            
            if (appState.activeModal) {
                addModalEventListeners();
            }
        }
          /**
         * ‚å®Ô∏è Modal de Atajos de Teclado Actualizado
         */
        function renderShortcutsModal() {
            const shortcutsList = ShortcutSystem.getShortcutsList();
            
            const shortcutsHTML = shortcutsList.map(s => `
                <li class="flex justify-between items-center p-3 bg-black/20 rounded-lg backdrop-blur-md">
                    <span class="${appState.theme.textSecondary}">${s.description}</span>
                    <kbd class="px-3 py-1.5 text-sm font-semibold ${appState.theme.textPrimary} ${appState.theme.surface} border ${appState.theme.accentBorder} rounded-md">${s.key}</kbd>
                </li>
            `).join('');

            return `
                 <div class="modal-container fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm modal-enter p-4">
                    <div class="modal-content relative backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
                        <button class="modal-close-button absolute top-3 right-3 p-2 ${appState.theme.textSecondary} hover:${appState.theme.accent} rounded-full">
                            ${createIcon(ICONS.x, 'w-6 h-6')}
                        </button>
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">Atajos de Teclado</h2>
                        <ul class="space-y-3">${shortcutsHTML}</ul>
                        
                        <div class="mt-6 pt-4 border-t border-white/10">
                            <p class="text-xs ${appState.theme.textSecondary} text-center">
                                Los atajos no funcionan cuando est√°s escribiendo en campos de texto.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }// ===============================================
        // üìä VISTAS PRINCIPALES DE LA APLICACI√ìN
        // ===============================================
        
        /**
         * üè† Vista Principal del Dashboard
         * Muestra resumen financiero con orbe central interactivo
         */
        function renderDashboard() {
            const { balance, netWorth } = calculateSummary();
            const firstGoal = appState.data.goals[0];
            let monthsToGoal = "Sin metas";
            
            if(firstGoal) {
                const allTransactions = Object.values(appState.data.transactions).flat();
                const globalIncome = allTransactions.filter(t=>t.type==='income').reduce((sum,t)=>sum+t.amount,0);
                const globalExpenses = allTransactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+t.amount,0);
                const firstDate = allTransactions.length > 0 ? new Date(allTransactions.reduce((min, t) => Math.min(min, new Date(t.date).getTime()), Date.now())) : new Date();
                const monthsDiff = Math.max(1, (new Date().getFullYear() - firstDate.getFullYear()) * 12 + (new Date().getMonth() - firstDate.getMonth()) + 1);
                const monthlySavings = (globalIncome-globalExpenses)/monthsDiff;
                monthsToGoal = monthlySavings > 0 ? `${Math.ceil((firstGoal.target - firstGoal.saved)/monthlySavings)} meses` : '‚àû';
            }            const infoHTML = appState.isPrivate ? `
                <div class="flex flex-col items-center justify-center ${appState.theme.textPrimary} p-10 rounded-full cursor-pointer" id="privacy-toggle">
                    ${createIcon(ICONS.eyeOff, "w-20 h-20")}
                    <p class="font-semibold mt-2">Informaci√≥n Oculta</p>
                </div>
            ` : `
                <div class="flex flex-col items-center justify-center text-slate-900 w-full h-full">
                    <div class="relative mb-4">
                        <div class="flex items-center gap-2">
                            <p class="text-sm font-medium opacity-70">Patrimonio Neto</p>                            <button id="privacy-toggle" class="text-slate-900/50 hover:text-slate-900 transition-colors" title="Ocultar informaci√≥n" aria-label="Alternar modo privacidad" aria-pressed="${appState.privacyMode}" role="button">
                                ${createIcon(ICONS.eye, "w-5 h-5")}
                            </button>
                        </div>
                        <p class="text-4xl font-bold">${formatCurrency(netWorth)}</p>
                    </div>
                    <div class="flex justify-around w-full text-sm">
                        <div>
                            <p class="font-medium opacity-70">Balance (Mes)</p>
                            <p class="font-semibold text-lg">${formatCurrency(balance)}</p>
                        </div>
                        <div class="border-l border-slate-900/30"></div>
                        <div>
                            <p class="font-medium opacity-70">Pr√≥xima Meta</p>
                            <p class="font-semibold text-lg">${monthsToGoal}</p>
                        </div>
                    </div>
                </div>
            `;            return `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-250px)] relative">
                    <div class="w-80 h-80 sm:w-96 sm:h-96 rounded-full flex items-center justify-center text-center transition-all duration-500" 
                         style="background: radial-gradient(circle at 30% 30%, ${appState.theme.sunColor || appState.theme.accentColor}, ${appState.theme.accentColor}aa 60%, ${appState.theme.accentColor}44 100%); 
                                box-shadow: 0 0 40px 10px ${appState.theme.sunColor || appState.theme.accentColor}60, 
                                           0 0 80px 30px ${appState.theme.sunColor || appState.theme.accentColor}30, 
                                           0 0 120px 50px ${appState.theme.sunColor || appState.theme.accentColor}20,
                                           inset 0 0 30px ${appState.theme.sunColor || appState.theme.accentColor}20;">
                        ${infoHTML}
                    </div>
                    
                    <!-- Rayos de sol sutiles -->
                    <div class="absolute inset-0 pointer-events-none">
                        ${Array.from({length: 8}, (_, i) => `
                            <div class="absolute w-1 h-20 origin-bottom animate-pulse" 
                                 style="background: linear-gradient(to top, ${appState.theme.sunColor || appState.theme.accentColor}20, transparent);
                                        left: 50%; top: 50%; 
                                        transform: translate(-50%, -100%) rotate(${i * 45}deg);
                                        animation-delay: ${i * 0.2}s;
                                        opacity: 0.6;">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }        /**
         * üí∞ Vista de Gesti√≥n de Transacciones (Ingresos/Gastos)
         * @param {string} type - Tipo de transacci√≥n ('income' o 'expense')
         */
        function renderTransactionsView(type) {
            const title = type === 'income' ? 'Ingresos' : 'Gastos';
            const isExpense = type === 'expense';
            const currentMonthTransactions = appState.data.transactions[appState.currentMonthKey] || [];              // Renderizar lista de transacciones del mes actual
            const transactionsHTML = currentMonthTransactions
                .filter(t => t.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => `
                    <li class="border border-white/10 p-4 rounded-lg flex justify-between items-center transition-all hover:bg-white/5">
                        <div>
                            <p class="font-semibold ${appState.theme.textPrimary}">${t.description}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${ isExpense && t.category ? `<p class="text-xs font-medium px-2 py-0.5 rounded-full" style="background-color:${appState.theme.accentColor}30; color:${appState.theme.accentColor}">${t.category}</p>` : '' }
                                <p class="text-xs ${appState.theme.textSecondary}">${new Date(t.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <p class="font-bold text-lg ${type === 'income' ? appState.theme.positive : appState.theme.negative}">
                                ${formatCurrency(t.amount)}
                            </p>
                            <button class="delete-transaction-button text-red-500/70 hover:text-red-500 transition-colors" data-transaction-id="${t.id}" title="Eliminar transacci√≥n">
                                ${createIcon(ICONS.trash, 'w-5 h-5')}
                            </button>
                        </div>
                    </li>
                `).join('');

            // Opciones de categor√≠as para gastos
            const categoryOptionsHTML = CATEGORIES.map(cat => 
                `<option class="bg-slate-800" value="${cat}">${cat}</option>`
            ).join('');            // Campo de categor√≠a (solo para gastos)
            const categoryFieldHTML = isExpense ? `
                <div>
                    <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Categor√≠a</label>
                    <select name="category" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required>
                        ${categoryOptionsHTML}
                    </select>
                </div>
            ` : '';return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">üí∞ Gesti√≥n de ${title}</h2>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="repeat-month-button" data-type="${type}" class="flex items-center gap-2 text-sm ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-3 py-2 rounded-lg hover:bg-white/5" title="Copia las transacciones del mes anterior">
                               ${createIcon(ICONS.history, 'w-4 h-4')} Repetir Mes Anterior
                            </button>
                            <button id="repeat-yearly-button" data-type="${type}" class="flex items-center gap-2 text-sm ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-3 py-2 rounded-lg hover:bg-white/5" title="Copia estas transacciones hasta fin de a√±o">
                               ${createIcon(ICONS.repeat, 'w-4 h-4')} Repetir Anualmente
                            </button>
                        </div>
                    </div>
                    
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-${isExpense ? '4' : '2'} gap-4 mb-8 items-end">                        <div class="${isExpense ? 'md:col-span-2' : ''}">
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Descripci√≥n</label>
                            <input type="text" name="description" placeholder="${type === 'income' ? 'Ej: Sueldo de presidente' : 'Ej: Comida para la expedici√≥n'}" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="la descripci√≥n" />
                        </div>
                        
                        ${categoryFieldHTML}                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto</label>
                            <input type="text" inputmode="numeric" name="amount" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el monto" />
                        </div>

                        <div class="md:col-span-full">
                            <button type="submit" class="w-full mt-2 ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-opacity ${appState.theme.accentGlow} flex items-center justify-center gap-2">
                                ${createIcon(ICONS.plus)} Agregar ${title.slice(0,-1)}
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">Historial del Mes</h3>
                        <ul class="space-y-3">                            ${transactionsHTML || `<p class="${appState.theme.textSecondary} text-center py-4">No hay transacciones a√∫n.</p>`}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // ‚úÖ EXPOSICI√ìN GLOBAL INMEDIATA - Para m√≥dulos
        window.renderTransactionsView = renderTransactionsView;
        
        function renderInvestmentsView() {
            const { totalInvestments } = calculateSummary();
            const totalInitial = appState.data.investments.reduce((sum, i) => sum + i.initialAmount, 0);
            const portfolioPerformance = totalInitial === 0 ? 0 : ((totalInvestments - totalInitial) / totalInitial) * 100;
            const performanceClass = portfolioPerformance >= 0 ? appState.theme.positive : appState.theme.negative;            const investmentsHTML = appState.data.investments.map(inv => {
                const performance = inv.initialAmount === 0 ? 0 : ((inv.currentAmount - inv.initialAmount) / inv.initialAmount) * 100;
                return `
                    <div class="border border-white/10 p-4 rounded-lg flex flex-col justify-between">
                        <div class="flex justify-between items-start">                           <div>
                                <p class="font-bold text-lg ${appState.theme.textPrimary}">${inv.name}</p>
                                <p class="text-sm ${appState.theme.textSecondary}">${inv.type}</p>
                           </div>
                           <div class="flex space-x-2">
                               <button data-action="edit-investment" data-investment-id="${inv.id}" class="p-2 bg-blue-500/20 hover:bg-blue-500 rounded-lg transition-all duration-200 text-blue-300 hover:text-white" title="Editar inversi√≥n">
                                   ${createIcon(ICONS.edit, 'w-4 h-4')}
                               </button>
                               <button data-action="delete-investment" data-investment-id="${inv.id}" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition-all duration-200 text-red-300 hover:text-white" title="Eliminar inversi√≥n">
                                   ${createIcon(ICONS.trash, 'w-4 h-4')}
                               </button>
                           </div>
                        </div>
                        <div class="mt-4">
                            <label class="text-xs ${appState.theme.textSecondary}">Valor Actual</label>
                            <input type="text" inputmode="numeric" data-investment-id="${inv.id}" value="${formatNumberWithDots(inv.currentAmount)}" placeholder="0" class="numeric-input investment-update-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" />
                            <p class="mt-2 text-right text-sm font-semibold ${performance >= 0 ? appState.theme.positive : appState.theme.negative}">${performance.toFixed(2)}%</p>
                        </div>
                    </div>
                `;
            }).join('');            return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-4">Resumen de Cartera</h2>
                    <div class="flex justify-between items-center">
                        <div><p class="text-sm ${appState.theme.textSecondary}">Valor Total</p><p class="text-3xl font-bold ${appState.theme.textPrimary}">${formatCurrency(totalInvestments)}</p></div>
                        <div class="text-right"><p class="text-sm ${appState.theme.textSecondary}">Rendimiento</p><div class="text-3xl font-bold flex items-center gap-2 ${performanceClass}"><span>${portfolioPerformance > 0 ? '+':''}${portfolioPerformance.toFixed(2)}%</span></div></div>
                    </div>                </div>
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">Inversiones</h2>
                        <button data-action="add-investment" class="px-4 py-2 ${appState.theme.accentBg} text-white rounded-lg hover:opacity-90 transition-all duration-200 ${appState.theme.accentGlow} font-medium">
                            + Nueva Inversi√≥n
                        </button>
                    </div>
                    <form id="investment-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 items-end">
                        <div class="md:col-span-2"><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Activo</label><input name="name" type="text" placeholder="Ej: Acciones de Adamantium..." class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el nombre del activo" /></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Tipo</label><select name="type" class="w-full border border-white/20 text-white rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent"><option class="bg-slate-800">Acciones</option><option class="bg-slate-800">Cripto</option><option class="bg-slate-800">Fondos</option><option class="bg-slate-800">Otro</option></select></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Inversi√≥n Inicial</label><input name="initialAmount" type="text" inputmode="numeric" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="la inversi√≥n inicial" /></div>
                        <div class="md:col-span-4"><button type="submit" class="w-full mt-2 ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-opacity ${appState.theme.accentGlow} flex items-center justify-center gap-2">${createIcon(ICONS.plus)}A√±adir Inversi√≥n</button></div>
                    </form>
                    <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mt-8 mb-4">Mis Activos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${investmentsHTML || `<p class="${appState.theme.textSecondary} text-center py-4 col-span-full">Tu cartera de inversiones est√° vac√≠a.</p>`}</div>
                </div>
            `;
        }
          function renderGoalsView() {
             const goalsHTML = appState.data.goals.map(goal => `
                <div class="border border-white/10 p-4 rounded-lg">                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold ${appState.theme.textPrimary}">${goal.name}</p>
                            <p class="text-sm ${appState.theme.textSecondary} mt-1">${formatCurrency(goal.saved)} / ${formatCurrency(goal.target)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-action="edit-goal" data-goal-id="${goal.id}" class="p-2 bg-blue-500/20 hover:bg-blue-500 rounded-lg transition-all duration-200 text-blue-300 hover:text-white" title="Editar meta">
                                ${createIcon(ICONS.edit, 'w-4 h-4')}
                            </button>
                            <button data-action="delete-goal" data-goal-id="${goal.id}" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition-all duration-200 text-red-300 hover:text-white" title="Eliminar meta">
                                ${createIcon(ICONS.trash, 'w-4 h-4')}
                            </button>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div class="${appState.theme.accentBg} h-2.5 rounded-full" style="width: ${((goal.saved / goal.target) * 100)}%"></div>
                    </div>
                </div>
            `).join('');            return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">Metas de Ahorro</h2>
                        <button data-action="add-goal" class="px-4 py-2 ${appState.theme.accentBg} text-white rounded-lg hover:opacity-90 transition-all duration-200 ${appState.theme.accentGlow} font-medium">
                            + Nueva Meta
                        </button>
                    </div>
                    <form id="goal-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Nombre de la Meta</label><input type="text" name="name" placeholder="Ej: Viaje a Marte" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el nombre de la meta" /></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto Objetivo</label><input type="text" inputmode="numeric" name="target" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el monto objetivo" /></div>
                        <div class="self-end"><button type="submit" class="w-full ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-colors ${appState.theme.accentGlow} flex items-center justify-center gap-2">${createIcon(ICONS.plus)}Crear Meta</button></div>
                    </form>
                    <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mt-8 mb-4">Mis Metas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${goalsHTML || `<p class="${appState.theme.textSecondary} col-span-full text-center py-4">A√∫n no has definido metas.</p>`}</div>
                </div>
            `;
        }        function renderDebtsView() {
            const debtsHTML = appState.data.debts.map(debt => `
                <li class="border border-white/10 rounded-lg flex justify-between items-center p-4">
                    <div><p class="font-semibold ${appState.theme.textPrimary}">${debt.description}</p></div>                    <div class="flex items-center gap-4">
                        <p class="font-bold text-lg ${appState.theme.negative}">${formatCurrency(debt.amount)}</p>
                        <div class="flex space-x-2">
                            <button data-action="edit-debt" data-debt-id="${debt.id}" class="p-2 bg-blue-500/20 hover:bg-blue-500 rounded-lg transition-all duration-200 text-blue-300 hover:text-white" title="Editar deuda">
                                ${createIcon(ICONS.edit, 'w-4 h-4')}
                            </button>
                            <button data-action="delete-debt" data-debt-id="${debt.id}" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition-all duration-200 text-red-300 hover:text-white" title="Eliminar deuda">
                                ${createIcon(ICONS.trash, 'w-4 h-4')}
                            </button>
                        </div>
                    </div>
                </li>
            `).join('');            return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">üí≥ Gesti√≥n de Deudas</h2>
                        <button data-action="add-debt" class="px-4 py-2 ${appState.theme.accentBg} text-white rounded-lg hover:opacity-90 transition-all duration-200 ${appState.theme.accentGlow} font-medium">
                            + Nueva Deuda
                        </button>
                    </div>
                    <form id="debt-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Descripci√≥n</label>
                            <input type="text" name="description" placeholder="Ej: Pr√©stamo de Mercado Plasma" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="la descripci√≥n de la deuda" />
                        </div>                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto Total</label>
                            <input type="text" inputmode="numeric" name="amount" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el monto total" />
                        </div>
                        <div class="self-end">
                            <button type="submit" class="w-full ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-all ${appState.theme.accentGlow} flex items-center justify-center gap-2 transform hover:scale-105">
                                ${createIcon(ICONS.plus)} Agregar Deuda
                            </button>
                        </div>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">Deudas Actuales</h3>
                        <ul class="space-y-3">
                            ${debtsHTML || `<div class="text-center py-8"><p class="${appState.theme.textSecondary}">üéâ ¬°No tienes deudas registradas!</p></div>`}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderSettingsView() {
            const themesHTML = Object.entries(THEMES).map(([key, theme]) => `
                <button data-theme-key="${key}" class="theme-selector p-4 rounded-lg border-2 transition-all ${appState.themeKey === key ? `${theme.accentBorder} scale-105 shadow-lg` : 'border-transparent opacity-70 hover:opacity-100'}">
                    <div class="w-full h-16 rounded-md mb-2" style="background: ${theme.gradient}"></div>
                    <p class="${appState.theme.textPrimary}">${theme.name}</p>
                </button>
            `).join('');            return `
                <div class="${appState.theme.surface} rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">‚öôÔ∏è Ajustes y Personalizaci√≥n</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">üé® Tema Visual</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${themesHTML}</div>
                        </div>                        <div>
                            <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">üõ†Ô∏è Herramientas</h3>
                             <button id="open-shortcuts-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md mb-3">
                                ${createIcon(ICONS.zap, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">‚ö° Atajos de Teclado</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Navega m√°s r√°pido por la aplicaci√≥n.</p>
                                </div>
                            </button>
                            
                            <button id="logout-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md mb-3">
                                ${createIcon(ICONS.logOut, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">üö™ Cerrar Sesi√≥n</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Salir de tu cuenta de Nebula Financial.</p>
                                </div>
                            </button>
                            
                            <button id="export-excel-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md mb-3">
                                ${createIcon(ICONS.download, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">üìä Exportar a Excel</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Descarga todos tus datos financieros.</p>
                                </div>
                            </button>
                            
                            <button id="clear-all-data-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-red-500/20 p-4 rounded-lg transition-colors backdrop-blur-md border border-red-500/30">
                                ${createIcon(ICONS.trash, `w-6 h-6 text-red-400`)}
                                <div>
                                    <p class="font-bold text-red-400">üóëÔ∏è Borrar Todos los Datos</p>
                                    <p class="text-sm text-red-300">‚ö†Ô∏è Esta acci√≥n no se puede deshacer.</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderComingSoon(section = 'Esta secci√≥n') {
            const label = { achievements: 'Logros' }[section] || 'Esta secci√≥n';
            return `
                <div class="backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} text-center h-[calc(100vh-200px)] flex flex-col justify-center items-center">
                    <div class="w-24 h-24 text-cyan-400 mb-4 animate-pulse">${createIcon(ICONS.settings)}</div>
                    <h2 class="text-3xl font-bold ${appState.theme.textPrimary}">${label} en Construcci√≥n</h2>
                    <p class="mt-4 ${appState.theme.textSecondary}">¬°Estamos explorando esta galaxia! Vuelve pronto.</p>
                </div>
            `;
        }        function renderDock() {
            const navItems = [
                { id: 'dashboard', label: 'Resumen', icon: ICONS.dashboard, key: 'D' },
                { id: 'income', label: 'Ingresos', icon: ICONS.income, key: 'I' },
                { id: 'expenses', label: 'Gastos', icon: ICONS.expenses, key: 'G' },
                { id: 'investments', label: 'Inversiones', icon: ICONS.investments, key: 'N' },
                { id: 'debts', label: 'Deudas', icon: ICONS.debts, key: 'P' },
                { id: 'goals', label: 'Metas', icon: ICONS.goals, key: 'M' },
                { id: 'settings', label: 'Ajustes', icon: ICONS.settings, key: 'A' }
            ];

            const navButtonsHTML = navItems.map(item => `
                <button data-view="${item.id}" aria-label="${item.label}" 
                        class="nav-button p-3 w-16 h-16 flex items-center justify-center
                               ${appState.activeView === item.id ? `text-white active` : `${appState.theme.textSecondary} hover:text-white`}" 
                        title="${item.label} (${item.key})">
                    ${createIcon(item.icon, "w-6 h-6")}
                </button>
            `).join('');            return `
                <nav class="p-4 backdrop-blur-lg bg-black/20">
                    <div class="dock-container w-full max-w-md mx-auto flex justify-between items-center">
                        ${navButtonsHTML}
                    </div>
                </nav>`;
        }        function renderParallaxBackground() {
            if (parallaxBg.children.length > 0 && parallaxBg.dataset.theme === appState.themeKey) return '';
            parallaxBg.dataset.theme = appState.themeKey;

            // üé® EFECTOS DE PART√çCULAS OPTIMIZADOS
            // Todos los temas ahora usan el mismo patr√≥n eficiente de "Aureo Amancer"
            // para mejorar el rendimiento y reducir los tiempos de carga
            switch(appState.theme.particleType) {
                case 'goldenDust': {
                    // Polvo dorado flotante para √Åureo Amanecer - EFECTO DUAL
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-amber-200 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }

                case 'crimsonMist': {
                    // Niebla carmes√≠ para Cris√≥n Vespertino - EFECTO DUAL MEJORADO
                    const mist = Array.from({ length: 25 }).map(() => {
                        const duration = Math.random() * 30 + 15;
                        const size = Math.random() * 300 + 150;
                        const startX = Math.random() * 100;
                        const startY = Math.random() * 100;
                        return `<div class="particle absolute rounded-full" style="left: ${startX}%; top: ${startY}%; width: ${size}px; height: ${size}px; background: radial-gradient(circle, ${appState.theme.sunColor}08, transparent 70%); animation: drift ${duration}s linear infinite alternate; transform: translateZ(0);"></div>`;
                    }).join('');
                    
                    const sparkles = Array.from({ length: 100 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 2 + 1;
                        const duration = Math.random() * 6 + 3;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*3}px ${appState.theme.sunColor}80; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.5 + 0.2};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 180 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const pulse = Math.random() * 4 + 3;
                        return `<div class="absolute w-px h-px bg-rose-300 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: pulse ${pulse}s ease-in-out infinite;"></div>`;
                    }).join('');

                    return mist + sparkles + backgroundStars;
                }                case 'aquaFlow': {
                    // Flujo acu√°tico para Aguamarina Celeste - EFECTO OPTIMIZADO (mismo patr√≥n que Aureo)
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-cyan-200 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }                case 'royalAura': {
                    // Aura real para Violeta Real - EFECTO OPTIMIZADO (mismo patr√≥n que Aureo)
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-purple-100 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }

                default: return '';
            }
        }

        function updateDockGlider() {
            // El nuevo efecto es puramente CSS, no requiere JavaScript
        }/**
         * üéÆ Gestor de Event Listeners Mejorado
         * Maneja todos los eventos de la interfaz de usuario
         */
        function addEventListeners() {
            // Eventos de autenticaci√≥n
            document.querySelectorAll('.login-button').forEach(btn => 
                btn.addEventListener('click', e => appState.login(e.currentTarget.dataset.loginMethod))
            );
            
            // Navegaci√≥n del dock
            document.querySelectorAll('.nav-button').forEach(btn => 
                btn.addEventListener('click', (e) => appState.setView(e.currentTarget.dataset.view))
            );
            
            // Toggle de privacidad
            const privacyToggle = document.getElementById('privacy-toggle');
            if(privacyToggle) privacyToggle.addEventListener('click', () => appState.togglePrivacy());
            
            // Formato num√©rico autom√°tico
            document.querySelectorAll('.numeric-input').forEach(input => {
                input.addEventListener('input', e => {
                    const cursorPosition = e.target.selectionStart;
                    const originalLength = e.target.value.length;
                    const rawValue = e.target.value.replace(/\D/g, '');
                    e.target.value = formatNumberWithDots(rawValue);
                    const newLength = e.target.value.length;
                    e.target.setSelectionRange(cursorPosition + (newLength - originalLength), cursorPosition + (newLength - originalLength));
                });
            });            // üîí Formularios con protecci√≥n XSS y validaci√≥n visual
            const transactionForm = document.getElementById('transaction-form');
            if (transactionForm) {
                transactionForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(transactionForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    const transactionData = {
                        type: appState.activeView === 'income' ? 'income' : 'expense',
                        description: sanitizeHTML(e.target.elements.description.value),
                        category: e.target.elements.category ? sanitizeHTML(e.target.elements.category.value) : undefined,
                        amount: parseFormattedNumber(e.target.elements.amount.value)
                    };
                    
                    appState.addTransaction(transactionData);
                    e.target.reset();
                    
                    NotificationSystem.success('√âxito', 
                        `${transactionData.type === 'income' ? 'Ingreso' : 'Gasto'} agregado correctamente`);
                });
            }

            const investmentForm = document.getElementById('investment-form');
            if(investmentForm) {
                investmentForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(investmentForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    const initial = parseFormattedNumber(e.target.elements.initialAmount.value);
                    appState.addInvestment({ 
                        name: sanitizeHTML(e.target.elements.name.value), 
                        type: sanitizeHTML(e.target.elements.type.value), 
                        initialAmount: initial, 
                        currentAmount: initial 
                    });
                    e.target.reset();
                    NotificationSystem.success('√âxito', 'Inversi√≥n agregada correctamente');
                });
            }
            
            const goalForm = document.getElementById('goal-form');
            if (goalForm) {
                goalForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(goalForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    appState.addGoal({ 
                        name: sanitizeHTML(e.target.elements.name.value), 
                        target: parseFormattedNumber(e.target.elements.target.value) 
                    });
                    e.target.reset();
                    NotificationSystem.success('√âxito', 'Meta creada correctamente');
                });
            }
            
            const debtForm = document.getElementById('debt-form');
            if(debtForm) {
                debtForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(debtForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    appState.addDebt({ 
                        description: sanitizeHTML(e.target.elements.description.value), 
                        amount: parseFormattedNumber(e.target.elements.amount.value)
                    });
                    e.target.reset();
                    NotificationSystem.success('√âxito', 'Deuda registrada correctamente');
                });
            }
            
            // Botones de repetici√≥n
            const repeatButton = document.getElementById('repeat-month-button');
            if (repeatButton) {
                repeatButton.addEventListener('click', e => {
                    appState.repeatPreviousMonth(e.currentTarget.dataset.type);
                });
            }
            
            const repeatYearlyButton = document.getElementById('repeat-yearly-button');
            if (repeatYearlyButton) {
                repeatYearlyButton.addEventListener('click', e => {
                    appState.repeatYearlyFromCurrent(e.currentTarget.dataset.type);
                });
            }            // Event delegation para botones con data-action (para compatibilidad con m√≥dulos)
            document.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                const target = e.target.closest('[data-action]');
                
                if (!action || !target) return;
                
                switch(action) {
                    case 'edit-investment':
                        const investmentId = parseInt(target.dataset.investmentId);
                        if (window.NebulaInvestmentsModule) {
                            window.NebulaInvestmentsModule.editInvestment(investmentId);
                        }
                        break;
                    case 'delete-investment':
                        const delInvestmentId = parseInt(target.dataset.investmentId);
                        if (window.NebulaInvestmentsModule) {
                            window.NebulaInvestmentsModule.deleteInvestment(delInvestmentId);
                        } else {
                            // Fallback al m√©todo integrado
                            appState.deleteInvestment(delInvestmentId);
                            NotificationSystem.info('Eliminado', 'Inversi√≥n eliminada');
                            renderApp();
                        }
                        break;
                    case 'add-investment':
                        if (window.NebulaInvestmentsModule) {
                            window.NebulaInvestmentsModule.showAddInvestmentForm();
                        }
                        break;
                    case 'edit-goal':
                        const goalId = parseInt(target.dataset.goalId);
                        if (window.NebulaGoalsModule) {
                            window.NebulaGoalsModule.editGoal(goalId);
                        }
                        break;
                    case 'delete-goal':
                        const delGoalId = parseInt(target.dataset.goalId);
                        if (window.NebulaGoalsModule) {
                            window.NebulaGoalsModule.deleteGoal(delGoalId);
                        } else {
                            appState.deleteGoal(delGoalId);
                            NotificationSystem.info('Eliminado', 'Meta eliminada');
                            renderApp();
                        }
                        break;
                    case 'add-goal':
                        if (window.NebulaGoalsModule) {
                            window.NebulaGoalsModule.showAddGoalForm();
                        }
                        break;
                    case 'edit-debt':
                        const debtId = parseInt(target.dataset.debtId);
                        if (window.NebulaDebtsModule) {
                            window.NebulaDebtsModule.editDebt(debtId);
                        }
                        break;
                    case 'delete-debt':
                        const delDebtId = parseInt(target.dataset.debtId);
                        if (window.NebulaDebtsModule) {
                            window.NebulaDebtsModule.deleteDebt(delDebtId);
                        } else {
                            appState.deleteDebt(delDebtId);
                            NotificationSystem.info('Eliminado', 'Deuda eliminada');
                            renderApp();
                        }
                        break;
                    case 'add-debt':
                        if (window.NebulaDebtsModule) {
                            window.NebulaDebtsModule.showAddDebtForm();
                        }
                        break;
                }
            });

            // Eliminaci√≥n de elementos (legacy - mantenido para compatibilidad)
            document.querySelectorAll('.delete-transaction-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteTransaction(parseInt(e.currentTarget.dataset.transactionId));
                    NotificationSystem.info('Eliminado', 'Transacci√≥n eliminada');
                })
            );
            
            document.querySelectorAll('.investment-update-input').forEach(input => 
                input.addEventListener('input', e => 
                    appState.updateInvestment(parseInt(e.target.dataset.investmentId), parseFormattedNumber(e.target.value))
                )
            );
            
            document.querySelectorAll('.delete-investment-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteInvestment(parseInt(e.currentTarget.dataset.investmentId));
                    NotificationSystem.info('Eliminado', 'Inversi√≥n eliminada');
                })
            );
            
            document.querySelectorAll('.delete-goal-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteGoal(parseInt(e.currentTarget.dataset.goalId));
                    NotificationSystem.info('Eliminado', 'Meta eliminada');
                })
            );
            
            document.querySelectorAll('.delete-debt-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteDebt(parseInt(e.currentTarget.dataset.debtId));
                    NotificationSystem.info('Eliminado', 'Deuda eliminada');
                })
            );
            
            // Selecci√≥n de temas
            document.querySelectorAll('.theme-selector').forEach(btn => 
                btn.addEventListener('click', (e) => {
                    appState.setTheme(e.currentTarget.dataset.themeKey);
                    NotificationSystem.success('Tema cambiado', 
                        `Aplicado: ${THEMES[e.currentTarget.dataset.themeKey].name}`);
                })
            );
              // Navegaci√≥n de meses
            const monthPrev = document.getElementById('month-prev');
            if (monthPrev) monthPrev.addEventListener('click', () => appState.changeMonth(-1));
            
            const monthNext = document.getElementById('month-next');
            if (monthNext) monthNext.addEventListener('click', () => appState.changeMonth(1));
              const openShortcutsButton = document.getElementById('open-shortcuts-button');
            if (openShortcutsButton) openShortcutsButton.addEventListener('click', () => appState.openModal('shortcuts'));
            
            // üîß NUEVOS BOTONES DE CONFIGURACI√ìN
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {                logoutButton.addEventListener('click', async () => {
                    try {
                        // CloudSonnet4: Modal elegante para cerrar sesi√≥n
                        const confirmed = await showWarningModal(
                            '¬øCerrar sesi√≥n?',
                            'Tus datos se mantendr√°n guardados localmente de forma segura.',
                            { 
                                confirmText: 'Cerrar sesi√≥n',
                                cancelText: 'Permanecer' 
                            }
                        );
                        if (!confirmed) return;
                        
                        // Limpiar datos de sesi√≥n (pero no los datos financieros)
                        if (NebulaSecurityUtils) {
                            NebulaSecurityUtils.secureRemoveItem('user_session');
                            NebulaSecurityUtils.secureRemoveItem('auth_token');
                        }
                        
                        NotificationSystem.success('Sesi√≥n cerrada', 'Has cerrado sesi√≥n exitosamente');
                        
                        // Opcional: recargar la app para reinicializar
                        setTimeout(() => location.reload(), 1500);
                        
                    } catch (error) {
                        console.error('Error cerrando sesi√≥n:', error);
                        NotificationSystem.error('Error', 'No se pudo cerrar la sesi√≥n');
                    }
                });
            }
            
            const exportExcelButton = document.getElementById('export-excel-button');
            if (exportExcelButton) {
                exportExcelButton.addEventListener('click', async () => {
                    try {
                        NotificationSystem.info('Exportando...', 'Preparando tus datos financieros');
                        
                        // Crear array con todas las transacciones del estado actual
                        const allTransactions = [];
                        
                        // Obtener transacciones de todos los meses
                        Object.entries(appState.data.transactions).forEach(([monthKey, transactions]) => {
                            transactions.forEach(transaction => {
                                allTransactions.push({
                                    tipo: transaction.type === 'income' ? 'Ingreso' : 'Gasto',
                                    descripcion: transaction.description,
                                    monto: transaction.amount,
                                    fecha: transaction.date,
                                    categoria: transaction.category || '',
                                    mes: monthKey
                                });
                            });
                        });
                        
                        // Agregar inversiones
                        appState.data.investments.forEach(investment => {
                            allTransactions.push({
                                tipo: 'Inversi√≥n',
                                descripcion: investment.name,
                                monto: investment.currentValue || investment.initialAmount,
                                fecha: investment.date || new Date().toISOString().split('T')[0],
                                categoria: investment.type || '',
                                mes: ''
                            });
                        });
                        
                        // Agregar metas
                        appState.data.goals.forEach(goal => {
                            allTransactions.push({
                                tipo: 'Meta',
                                descripcion: goal.name,
                                monto: goal.targetAmount,
                                fecha: goal.targetDate || '',
                                categoria: '',
                                mes: ''
                            });
                        });
                        
                        // Agregar deudas
                        appState.data.debts.forEach(debt => {
                            allTransactions.push({
                                tipo: 'Deuda',
                                descripcion: debt.description,
                                monto: debt.amount,
                                fecha: debt.date || new Date().toISOString().split('T')[0],
                                categoria: debt.type || '',
                                mes: ''
                            });
                        });
                        
                        // Crear CSV
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Tipo,Descripci√≥n,Monto,Fecha,Categor√≠a,Mes\\n";
                        
                        allTransactions.forEach(item => {
                            csvContent += `"${item.tipo}","${item.descripcion}",${item.monto},"${item.fecha}","${item.categoria}","${item.mes}"\\n`;
                        });
                        
                        // Descargar archivo
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", `nebula_financial_${new Date().toISOString().split('T')[0]}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        NotificationSystem.success('¬°Exportado!', 'Tus datos se han descargado exitosamente');
                        
                    } catch (error) {
                        console.error('Error exportando datos:', error);
                        NotificationSystem.error('Error', 'No se pudieron exportar los datos');
                    }
                });
            }
            
            const clearAllDataButton = document.getElementById('clear-all-data-button');            if (clearAllDataButton) {
                clearAllDataButton.addEventListener('click', async () => {
                    try {
                        // CloudSonnet4: Primera confirmaci√≥n con modal elegante
                        const confirmed1 = await showDangerModal(
                            '‚ö†Ô∏è Eliminar todos los datos',
                            'Esta acci√≥n eliminar√° <strong>TODOS</strong> tus datos financieros.<br><br>¬øEst√°s absolutamente seguro?',
                            { 
                                confirmText: 'Continuar',
                                cancelText: 'Cancelar' 
                            }
                        );
                        if (!confirmed1) return;
                        
                        // CloudSonnet4: Segunda confirmaci√≥n cr√≠tica
                        const confirmed2 = await showDangerModal(
                            'üö® √öLTIMA CONFIRMACI√ìN',
                            `Se borrar√°n permanentemente:<br><br>
                            ‚Ä¢ <strong>Todos los ingresos</strong><br>
                            ‚Ä¢ <strong>Todos los gastos</strong><br>
                            ‚Ä¢ <strong>Todas las inversiones</strong><br>
                            ‚Ä¢ <strong>Todas las metas</strong><br>
                            ‚Ä¢ <strong>Todas las deudas</strong><br><br>
                            <span style="color: #ef4444; font-weight: bold;">Esta acci√≥n NO SE PUEDE DESHACER.</span><br><br>
                            ¬øContinuar con la eliminaci√≥n?`,
                            { 
                                confirmText: 'S√ç, BORRAR TODO',
                                cancelText: 'No, mantener datos' 
                            }
                        );
                        if (!confirmed2) return;
                        
                        // Limpiar todos los datos del estado
                        appState.data = {
                            transactions: {},
                            investments: [],
                            goals: [],
                            debts: []
                        };
                        
                        // Limpiar localStorage
                        if (NebulaSecurityUtils) {
                            NebulaSecurityUtils.secureRemoveItem('financialData');
                        } else {
                            localStorage.removeItem('financialData');
                        }
                        
                        // Guardar el estado vac√≠o
                        appState.saveState();
                        
                        NotificationSystem.success('Datos eliminados', 'Todos los datos financieros han sido borrados');
                        
                        // Recargar la app para mostrar estado limpio
                        setTimeout(() => renderApp(), 1000);
                        
                    } catch (error) {
                        console.error('Error borrando datos:', error);
                        NotificationSystem.error('Error', 'No se pudieron borrar los datos');
                    }
                });
            }// Actualizar glider al cargar eventos
            updateDockGlider();
            
            // Observer simple para cambios de tama√±o
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateDockGlider, 100);
            });
        }        function addModalEventListeners() {
            const modalContainer = document.querySelector('.modal-container');
            if(modalContainer) {
                modalContainer.addEventListener('click', (e) => {
                    if(e.target === modalContainer) appState.closeModal();
                });
                modalContainer.querySelector('.modal-close-button')?.addEventListener('click', () => appState.closeModal());
            }
        }
          // ===============================================
        // üöÄ FUNCIONES DE PERFORMANCE - Optimizaci√≥n de eventos
        /**
         * Debounce para optimizar eventos de input frecuentes
         * @param {Function} func - Funci√≥n a ejecutar
         * @param {number} wait - Tiempo de espera en ms
         * @returns {Function} Funci√≥n debounced
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Throttle para limitar ejecuci√≥n de funciones
         * @param {Function} func - Funci√≥n a ejecutar
         * @param {number} limit - L√≠mite en ms
         * @returns {Function} Funci√≥n throttled
         */
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        /**
         * Lazy loading para elementos que aparecen en viewport
         * @param {string} selector - Selector CSS de elementos
         * @param {Function} callback - Funci√≥n a ejecutar cuando sea visible
         */
        function observeIntersection(selector, callback) {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            callback(entry.target);
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll(selector).forEach(el => observer.observe(el));
            } else {
                // Fallback para navegadores sin IntersectionObserver
                document.querySelectorAll(selector).forEach(callback);
            }        }

        // ===============================================
        // üßÆ FUNCIONES DE C√ÅLCULO FINANCIERO
        // ===============================================
        
        function calculateSummary() {
            const currentTransactions = appState.data.transactions[appState.currentMonthKey] || [];
            const totalIncome = currentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = currentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const allTransactions = Object.values(appState.data.transactions).flat();
            const totalSavings = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0) - allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalInvestments = appState.data.investments.reduce((sum, i) => sum + i.currentAmount, 0);
            const totalDebts = appState.data.debts.reduce((sum, d) => sum + d.amount, 0);
            
            const balance = totalIncome - totalExpenses;
            const netWorth = totalSavings + totalInvestments - totalDebts;
            
            return { balance, netWorth, totalInvestments, totalDebts, totalIncome, totalExpenses };
        }

        // ===============================================
        // üöÄ SISTEMA DE ATAJOS DE TECLADO RESTAURADO
        // ===============================================
        
        /**
         * ÔøΩ Gestor de Atajos de Teclado Robusto
         * Sistema completo para manejar shortcuts en todos los navegadores
         */
        const ShortcutSystem = {
            shortcuts: new Map(),
            isActive: true,
            
            init() {
                this.registerDefaultShortcuts();
                this.attachListener();
                console.log('‚úÖ ShortcutSystem inicializado correctamente');
            },
            
            /**
             * Registra atajos por defecto de la aplicaci√≥n
             */
            registerDefaultShortcuts() {
                // Navegaci√≥n entre vistas
                this.register('d', () => appState.setView('dashboard'), 'Ir al Dashboard');
                this.register('i', () => appState.setView('income'), 'Ir a Ingresos');
                this.register('g', () => appState.setView('expenses'), 'Ir a Gastos');
                this.register('n', () => appState.setView('investments'), 'Ir a Inversiones');
                this.register('p', () => appState.setView('debts'), 'Ir a Deudas');
                this.register('m', () => appState.setView('goals'), 'Ir a Metas');
                this.register('a', () => appState.setView('settings'), 'Ir a Ajustes');
                
                // Navegaci√≥n temporal
                this.register('ArrowLeft', () => {
                    if (!appState.activeModal) appState.changeMonth(-1);
                }, 'Mes anterior');
                this.register('ArrowRight', () => {
                    if (!appState.activeModal) appState.changeMonth(1);
                }, 'Mes siguiente');
                  // Funciones especiales
                this.register('Escape', () => {
                    if (appState.activeModal) appState.closeModal();
                }, 'Cerrar modal');
                  // üìÖ Atajo para calendario minimalista
                this.register('c', () => {
                    if (!appState.activeModal && typeof openCalendar === 'function') {
                        openCalendar();
                    }
                }, 'Abrir Calendario Minimalista');
                
                this.register('h', () => {
                    if (!appState.activeModal) appState.openModal('shortcuts');
                }, 'Mostrar atajos');
                this.register('t', () => {
                    appState.togglePrivacy();
                    NotificationSystem.info('Privacidad', 
                        `Modo privado ${appState.isPrivate ? 'activado' : 'desactivado'}`);
                }, 'Alternar privacidad');
            },
            
            /**
             * Registra un nuevo atajo
             */
            register(key, callback, description = '') {
                this.shortcuts.set(key.toLowerCase(), { callback, description });
            },
            
            /**
             * Elimina un atajo
             */
            unregister(key) {
                this.shortcuts.delete(key.toLowerCase());
            },
            
            /**
             * Verifica si una tecla deber√≠a ser ignorada
             */
            shouldIgnoreEvent(event) {
                const activeElement = document.activeElement;
                const isInputField = activeElement && 
                    ['INPUT', 'TEXTAREA', 'SELECT'].includes(activeElement.tagName);
                const isContentEditable = activeElement && 
                    activeElement.contentEditable === 'true';
                
                return isInputField || isContentEditable;
            },
            
            /**
             * Maneja el evento de teclado
             */
            handleKeyDown(event) {
                if (!this.isActive || this.shouldIgnoreEvent(event)) {
                    return;
                }
                
                const key = event.key.toLowerCase();
                const shortcut = this.shortcuts.get(key);
                
                if (shortcut) {
                    event.preventDefault();
                    try {
                        shortcut.callback(event);
                    } catch (error) {
                        console.error('Error executing shortcut:', error);
                        NotificationSystem.error('Error', 'Error al ejecutar atajo de teclado');
                    }
                }
            },
            
            /**
             * Adjunta el listener de eventos
             */
            attachListener() {
                document.addEventListener('keydown', (event) => {
                    this.handleKeyDown(event);
                }, { passive: false });
            },
            
            /**
             * Obtiene lista de atajos registrados
             */
            getShortcutsList() {
                return Array.from(this.shortcuts.entries()).map(([key, data]) => ({
                    key: key.toUpperCase(),
                    description: data.description
                }));
            },
            
            /**
             * Activa/desactiva el sistema de shortcuts
             */            setActive(active) {
                this.isActive = active;
            }        };

        // üéØ DEBUG: Verificar que ShortcutSystem est√° definido
        console.log('üéØ SHORTCUT SYSTEM STATUS:', typeof ShortcutSystem !== 'undefined' ? '‚úÖ DEFINIDO' : '‚ùå NO DEFINIDO');

        // ===============================================
        // üöÄ INICIALIZACI√ìN MEJORADA PARA LIVE SERVER
        // ===============================================
        
        // Funci√≥n de inicializaci√≥n robusta
        function startNebula() {
            try {
                console.log('üöÄ Iniciando Nebula Financial...');
                
                // Verificar elementos DOM
                const elements = ['content-root', 'dock-root', 'parallax-bg', 'modal-root'];
                const domElements = elements.map(id => document.getElementById(id));
                
                if (domElements.some(el => !el)) {
                    console.error('‚ùå Elementos DOM faltantes:', elements.filter((_, i) => !domElements[i]));
                    throw new Error('Elementos DOM no encontrados');
                }
                
                // Asignar elementos a variables globales
                [contentRoot, dockRoot, parallaxBg, modalRoot] = domElements;
                  // Verificar objetos necesarios
                if (!THEMES || !ICONS || !appState) {
                    throw new Error('Objetos globales no definidos');
                }
                  // üåç EXPOSICI√ìN GLOBAL CR√çTICA - Para compatibilidad con m√≥dulos
                window.appState = appState;
                window.THEMES = THEMES;
                window.ICONS = ICONS;
                window.renderApp = renderApp;
                  // Funci√≥n global para aplicar autoformato num√©rico
                window.formatThousands = function(value) {
                    if (!value) return '';
                    // Remover todo excepto n√∫meros
                    const cleanValue = value.toString().replace(/[^\d]/g, '');
                    // Aplicar formato con puntos cada 3 d√≠gitos
                    return cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                };
                
                window.applyThousandsFormatting = function(input) {
                    if (!input) return;
                    
                    // Evento input para formateo en tiempo real
                    input.addEventListener('input', (e) => {
                        const cursorPosition = e.target.selectionStart;
                        const oldValue = e.target.value;
                        const newValue = window.formatThousands(oldValue);
                        
                        // Solo actualizar si cambi√≥ el valor
                        if (newValue !== oldValue) {
                            e.target.value = newValue;
                            
                            // Mantener posici√≥n del cursor
                            const newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
                            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                        }
                    });
                    
                    // Formatear valor inicial si existe
                    if (input.value) {
                        input.value = window.formatThousands(input.value);
                    }
                };
                
                window.applyNumericFormatting = function() {
                    // Aplicar formateo autom√°tico de miles a todos los inputs num√©ricos
                    document.querySelectorAll('.numeric-input').forEach(input => {
                        window.applyThousandsFormatting(input);
                    });
                    
                    // Tambi√©n aplicar a inputs de actualizaci√≥n de inversiones
                    document.querySelectorAll('.update-investment-input').forEach(input => {
                        window.applyThousandsFormatting(input);
                    });
                };
                
                console.log('‚úÖ Objetos globales expuestos correctamente');
                
                // Inicializar sistemas
                ShortcutSystem.init();
                NotificationSystem.init();
                
                // Renderizar aplicaci√≥n
                renderApp();
                  // Configurar dock
                setTimeout(() => {
                    if (typeof updateDockGlider === 'function') {
                        updateDockGlider();
                    }
                }, 200);
                
                // Mostrar mensaje de bienvenida si es la primera vez
                const isFirstVisit = NebulaSecurityUtils ? 
                    !NebulaSecurityUtils.secureGetItem('nebula_visited') :
                    !localStorage.getItem('nebula_visited');
                if (isFirstVisit) {
                    if (NebulaSecurityUtils) {
                        NebulaSecurityUtils.secureSetItem('nebula_visited', true);
                    } else {
                        localStorage.setItem('nebula_visited', 'true');
                    }
                    setTimeout(() => {
                        NotificationSystem.info('¬°Bienvenido!', 
                            'Presiona H para ver los atajos de teclado disponibles', 6000);
                    }, 2000);
                }
                
                console.log('‚úÖ Nebula iniciada correctamente');
                
                // üîê Inicializar sistema de autenticaci√≥n despu√©s de Firebase
                if (window.NebulaAuth) {
                    try {
                        window.NebulaAuth.initialize().then(() => {
                            console.log('üîê NebulaAuth inicializado correctamente');
                        }).catch(error => {
                            console.warn('‚ö†Ô∏è Error inicializando NebulaAuth:', error);
                        });
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error en inicializaci√≥n NebulaAuth:', error);
                    }
                } else {
                    console.warn('‚ö†Ô∏è NebulaAuth no disponible');
                }
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                
                // Mostrar p√°gina de error
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); color: white; font-family: 'Inter', Arial, sans-serif;">
                        <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.4); border-radius: 20px; backdrop-filter: blur(10px); max-width: 500px;">
                            <h1 style="font-size: 3rem; margin-bottom: 1rem;">üåå</h1>
                            <h2 style="font-size: 2rem; margin-bottom: 1rem; color: #e2e8f0;">Nebula Financial</h2>
                            <p style="margin-bottom: 1.5rem; color: #cbd5e1; font-size: 1.1rem;">Iniciando tu universo financiero...</p>
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 2rem; text-align: left;">
                                <small style="color: #fcd34d; font-family: monospace;">${error.message}</small>
                            </div>
                            <button onclick="location.reload()" style="background: linear-gradient(45deg, #22c55e, #16a34a); border: none; color: white; padding: 14px 28px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); transition: transform 0.2s; margin-right: 10px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üîÑ Recargar App
                            </button>
                            <button onclick="if(NebulaSecurityUtils) { NebulaSecurityUtils.clearSecurityData(); } else { localStorage.clear(); } location.reload()" style="background: linear-gradient(45deg, #f59e0b, #d97706); border: none; color: white; padding: 14px 28px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">>
                                üóëÔ∏è Limpiar Datos
                            </button>
                        </div>
                    </div>
                `;
            }
        }
          // Funci√≥n de espera para DOM con verificaci√≥n robusta
        function waitForDOM() {
            console.log('üìã Verificando estado DOM:', document.readyState);
            
            // Verificar que los elementos cr√≠ticos existan
            const criticalElements = ['app-container', 'content-root', 'dock-root', 'parallax-bg', 'modal-root'];
            const allElementsExist = criticalElements.every(id => {
                const element = document.getElementById(id);
                console.log(`üìã Elemento ${id}:`, element ? '‚úÖ Encontrado' : '‚ùå No encontrado');
                return element !== null;
            });
            
            if (document.readyState === 'complete' && allElementsExist) {
                console.log('‚úÖ DOM completamente cargado y elementos verificados');
                startNebula();
            } else if (document.readyState === 'interactive' && allElementsExist) {
                console.log('‚è≥ DOM interactivo, esperando 200ms...');
                setTimeout(() => {
                    const stillExist = criticalElements.every(id => document.getElementById(id));
                    if (stillExist) {
                        startNebula();
                    } else {
                        console.log('üîÑ Elementos no listos, esperando evento DOMContentLoaded...');
                        document.addEventListener('DOMContentLoaded', startNebula);
                    }
                }, 200);
            } else {
                console.log('üîÑ Esperando carga completa del DOM...');
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('üìã DOMContentLoaded disparado, reintentando...');
                    setTimeout(waitForDOM, 50);
                });
            }
        }// Iniciar aplicaci√≥n
        waitForDOM();        // üß™ SISTEMA DE VALIDACI√ìN AUTOM√ÅTICA MEJORADO
        function validateNebula() {
            setTimeout(() => {
                try {
                    console.log('üß™ Iniciando validaci√≥n autom√°tica de Nebula...');
                    
                    const validationResults = {
                        shortcuts: false,
                        notifications: false,
                        appState: false,
                        dom: false,
                        themes: false,
                        security: false,
                        inputValidation: false,
                        modules: false,
                        performance: false
                    };
                    
                    let criticalErrors = [];
                    let warnings = [];
                    
                    // Test ShortcutSystem
                    if (typeof ShortcutSystem !== 'undefined' && ShortcutSystem.init) {
                        console.log('‚úÖ ShortcutSystem: Definido y funcional');
                        validationResults.shortcuts = true;
                    } else {
                        const error = '‚ùå ShortcutSystem: No definido o no funcional';
                        console.error(error);
                        criticalErrors.push(error);
                    }
                    
                    // Test NotificationSystem
                    if (typeof NotificationSystem !== 'undefined' && NotificationSystem.success) {
                        console.log('‚úÖ NotificationSystem: Definido y funcional');
                        validationResults.notifications = true;
                        
                        // Test pr√°ctico del sistema de notificaciones
                        try {
                            NotificationSystem.info('üß™ Sistema validado', 'Validaci√≥n autom√°tica completada', 2000);
                        } catch (e) {
                            warnings.push('‚ö†Ô∏è NotificationSystem definido pero no funcional: ' + e.message);
                        }
                    } else {
                        const error = '‚ùå NotificationSystem: No definido o no funcional';
                        console.error(error);
                        criticalErrors.push(error);
                    }
                    
                    // Test appState
                    if (typeof appState !== 'undefined' && appState.activeView && appState.data) {
                        console.log('‚úÖ appState: Definido y funcional');
                        validationResults.appState = true;
                        
                        // Validar estructura de datos cr√≠ticos
                        const requiredData = ['income', 'expenses', 'investments', 'debts', 'goals'];
                        const missingData = requiredData.filter(key => !appState.data[key]);
                        if (missingData.length > 0) {
                            warnings.push(`‚ö†Ô∏è appState: Faltan datos iniciales para: ${missingData.join(', ')}`);
                        }
                    } else {
                        const error = '‚ùå appState: No definido o no funcional';
                        console.error(error, {
                            defined: typeof appState !== 'undefined',
                            hasActiveView: typeof appState !== 'undefined' && typeof appState.activeView !== 'undefined',
                            hasData: typeof appState !== 'undefined' && appState.data
                        });
                        criticalErrors.push(error);
                    }
                    
                    // Test DOM elements
                    const criticalIds = ['content-root', 'dock-root', 'parallax-bg', 'modal-root'];
                    let domErrors = [];
                    const domOk = criticalIds.every(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            console.log(`‚úÖ DOM ${id}: Encontrado`);
                            return true;
                        } else {
                            const error = `‚ùå DOM ${id}: No encontrado`;
                            console.error(error);
                            domErrors.push(error);
                            return false;
                        }
                    });
                    validationResults.dom = domOk;
                    if (!domOk) criticalErrors.push(...domErrors);
                    
                    // Test THEMES
                    if (typeof THEMES !== 'undefined' && THEMES.aureoAmanecer && THEMES.crisonVespertino) {
                        console.log('‚úÖ THEMES: Definido y funcional');
                        validationResults.themes = true;
                    } else {
                        const error = '‚ùå THEMES: No definido o no funcional';
                        console.error(error, {
                            defined: typeof THEMES !== 'undefined',
                            hasAureoAmanecer: typeof THEMES !== 'undefined' && THEMES.aureoAmanecer,
                            hasCrisonVespertino: typeof THEMES !== 'undefined' && THEMES.crisonVespertino
                        });
                        criticalErrors.push(error);
                    }
                    
                    // Test Security System
                    if (typeof NebulaSecurityUtils !== 'undefined' && NebulaSecurityUtils.encrypt) {
                        console.log('‚úÖ NebulaSecurityUtils: Definido y funcional');
                        validationResults.security = true;
                        
                        // Test b√°sico de cifrado
                        try {
                            const testData = 'test_validation';
                            const encrypted = NebulaSecurityUtils.encrypt(testData);
                            const decrypted = NebulaSecurityUtils.decrypt(encrypted);
                            if (decrypted !== testData) {
                                warnings.push('‚ö†Ô∏è Security: Cifrado/descifrado no funciona correctamente');
                            }
                        } catch (e) {
                            warnings.push('‚ö†Ô∏è Security: Error en test de cifrado: ' + e.message);
                        }
                    } else {
                        warnings.push('‚ö†Ô∏è NebulaSecurityUtils: No definido, usando localStorage b√°sico');
                        validationResults.security = false;
                    }
                    
                    // Test Input Validation
                    if (typeof NebulaInputValidator !== 'undefined' && NebulaInputValidator.validateNumber) {
                        console.log('‚úÖ NebulaInputValidator: Definido y funcional');
                        validationResults.inputValidation = true;
                    } else {
                        warnings.push('‚ö†Ô∏è NebulaInputValidator: No definido, validaci√≥n b√°sica activa');
                        validationResults.inputValidation = false;
                    }
                    
                    // Test Module Loader
                    if (window.nebulaModuleLoader && window.nebulaModuleLoader.loadedCount > 0) {
                        console.log('‚úÖ Module Loader: Funcional -', window.nebulaModuleLoader.loadedCount, 'm√≥dulos cargados');
                        validationResults.modules = true;
                    } else {
                        const error = '‚ùå Module Loader: No funcional o sin m√≥dulos cargados';
                        console.error(error);
                        criticalErrors.push(error);
                    }
                    
                    // Test Performance
                    const performanceData = {
                        loadTime: Date.now() - window.nebulaStartTime,
                        memoryUsage: navigator.memory ? navigator.memory.usedJSHeapSize : 'N/A'
                    };
                    console.log('üìä Performance:', performanceData);
                    validationResults.performance = performanceData.loadTime < 5000; // Menos de 5 segundos
                    
                    // üìä REPORTE FINAL
                    const totalTests = Object.keys(validationResults).length;
                    const passedTests = Object.values(validationResults).filter(Boolean).length;
                    const successRate = Math.round((passedTests / totalTests) * 100);
                    
                    console.log(`üìä REPORTE DE VALIDACI√ìN:`);
                    console.log(`‚úÖ Tests pasados: ${passedTests}/${totalTests} (${successRate}%)`);
                    console.log(`‚ùå Errores cr√≠ticos: ${criticalErrors.length}`);
                    console.log(`‚ö†Ô∏è Advertencias: ${warnings.length}`);
                    
                    if (criticalErrors.length > 0) {
                        console.error('üö® ERRORES CR√çTICOS DETECTADOS:');
                        criticalErrors.forEach(error => console.error(error));
                    }
                    
                    if (warnings.length > 0) {
                        console.warn('‚ö†Ô∏è ADVERTENCIAS:');
                        warnings.forEach(warning => console.warn(warning));
                    }
                    
                    // üéØ ESTABLECER ESTADO GLOBAL DE VALIDACI√ìN
                    window.nebulaValidationStatus = {
                        success: criticalErrors.length === 0,
                        score: successRate,
                        errors: criticalErrors,
                        warnings: warnings,
                        results: validationResults,
                        timestamp: new Date().toISOString()
                    };
                    
                    if (criticalErrors.length === 0) {
                        console.log('üéâ VALIDACI√ìN COMPLETADA CON √âXITO');
                        
                        // Limpiar contadores de reintentos si todo est√° bien
                        sessionStorage.removeItem('nebula_retry_count');
                        
                        // Notificar √©xito si el sistema de notificaciones funciona
                        if (validationResults.notifications) {
                            setTimeout(() => {
                                NotificationSystem.success('üß™ Validaci√≥n', 
                                    `Sistema validado: ${successRate}% de tests pasados`, 3000);
                            }, 2000);
                        }
                    } else {
                        console.error('üö® VALIDACI√ìN FALL√ì - Errores cr√≠ticos detectados');
                    }
                    
                } catch (validationError) {
                    console.error('‚ùå Error durante la validaci√≥n:', validationError);
                    window.nebulaValidationStatus = {
                        success: false,
                        error: validationError.message,
                        timestamp: new Date().toISOString()                    };
                }
            }, 1500); // Esperar 1.5 segundos para que todo est√© cargado
        }
        
        // üöÄ Registro del Service Worker para performance
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            console.log('üîÑ Nueva versi√≥n del SW disponible');
                        });
                    })
                    .catch(error => {
                        console.log('‚ùå Error registrando SW:', error);
                    });
            });
        }

    </script>
    
    <!-- üîß M√ìDULOS DE NEBULA FINANCIAL -->
    <script type="module">
        // Cargar m√≥dulos de forma as√≠ncrona
        import('./js/modules/investments.js').then(module => {
            console.log('‚úÖ M√≥dulo de Inversiones cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de inversiones:', error);
        });
        
        import('./js/modules/goals.js').then(module => {
            console.log('‚úÖ M√≥dulo de Metas cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de metas:', error);
        });
        
        import('./js/modules/debts.js').then(module => {
            console.log('‚úÖ M√≥dulo de Deudas cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de deudas:', error);
        });
        
        import('./js/modules/income.js').then(module => {
            // Asegurarse de que el m√≥dulo est√© disponible globalmente
            if (!window.NebulaIncomeModule && window.IncomeModule) {
                window.NebulaIncomeModule = window.IncomeModule;
            }
            console.log('‚úÖ M√≥dulo de Ingresos cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de ingresos:', error);
        });
        
        import('./js/modules/expenses.js').then(module => {
            // Asegurarse de que el m√≥dulo est√© disponible globalmente
            if (!window.NebulaExpensesModule && window.ExpensesModule) {
                window.NebulaExpensesModule = window.ExpensesModule;
            }
            console.log('‚úÖ M√≥dulo de Gastos cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de gastos:', error);
        });
    </script>
</body>
</html>
