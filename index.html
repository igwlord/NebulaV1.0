<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
    
    <!-- üöÄ OPTIMIZACI√ìN NUCLEAR - Cache Busting Inteligente -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- üåå NEBULA IDENTITY - SEO Optimizado -->
    <title>üåå Nebula Financial - Tu Universo Financiero √âpico</title>
    <meta name="description" content="La experiencia financiera m√°s avanzada del universo. Gestiona ingresos, gastos, inversiones y deudas con inteligencia gal√°ctica.">
    <meta name="keywords" content="finanzas personales, gesti√≥n financiera, presupuesto, inversiones, nebula">
    <meta name="author" content="Nebula Financial Team">
    
    <!-- üéØ PERFORMANCE CRITICAL - Recursos Prioritarios -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
    
    <!-- üöÄ FUENTES - Carga Optimizada -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" as="style">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"></noscript>
    
    <!-- üé® ICONOS Y MANIFEST -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåå</text></svg>">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#FCD34D">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nebula Financial">
    
    <!-- üéØ CSS CR√çTICO - Inline para LCP √©pico -->
    <style>
        /* üöÄ CRITICAL CSS - Primera Impresi√≥n √âpica */
        :root {
            --nebula-primary: #1e40af;
            --nebula-secondary: #7c3aed;
            --nebula-accent: #fcd34d;
            --nebula-gold: #ffd700;
            --nebula-dark: #0f0f23;
            --nebula-darker: #0a0a1a;
            --nebula-glass: rgba(255, 255, 255, 0.1);
            --nebula-glow: 0 0 20px rgba(252, 211, 77, 0.5);
            --nebula-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--nebula-dark);
            color: var(--nebula-accent);
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* üåå LOADING √âPICO - Primera Impresi√≥n */
        .nebula-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .nebula-loading.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        .nebula-logo {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(45deg, #fcd34d, #ffd700, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            animation: nebulaGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes nebulaGlow {
            from { filter: drop-shadow(0 0 10px rgba(252, 211, 77, 0.5)); }
            to { filter: drop-shadow(0 0 25px rgba(252, 211, 77, 0.8)); }
        }
        
        .nebula-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid transparent;
            border-top: 3px solid var(--nebula-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* üéØ LAYOUT CR√çTICO */
        #app-container {
            min-height: 100vh;
            position: relative;
        }
        
        #content-root {
            position: relative;
            z-index: 10;
            padding-bottom: 6rem;
            min-height: 100vh;
        }
        
        #dock-root {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 20;
        }
        
        #parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            perspective: 1000px;
            pointer-events: none;
        }
        
        /* üöÄ ANIMACIONES √âPICAS */
        .nebula-fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .nebula-slide-up {
            animation: slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* üé® GLASSMORPHISM √âPICO */
        .nebula-glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
        }
        
        /* üî• HOVER EFFECTS √âPICOS */
        .nebula-hover {
            transition: var(--nebula-transition);
            cursor: pointer;
        }
        
        .nebula-hover:hover {
            transform: translateY(-2px);
            box-shadow: var(--nebula-glow);
        }
          /* üì± RESPONSIVE √âPICO */
        @media (max-width: 768px) {
            .nebula-logo { font-size: 3rem; }
            #content-root { padding-bottom: 5rem; }
        }
        
        /* üé® CSS EXTENDIDO - Animaciones para efectos de part√≠culas */
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.5); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }
        
        @keyframes glow {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.4); }
        }
        
        @keyframes drift {
            0% { transform: translateX(0px) translateY(0px); opacity: 0.1; }
            50% { transform: translateX(100px) translateY(-50px); opacity: 0.3; }
            100% { transform: translateX(200px) translateY(0px); opacity: 0.1; }
        }
        
        @keyframes wave {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.1; }
            50% { transform: scale(1.2) rotate(180deg); opacity: 0.3; }
        }
          @keyframes orbit {
            0% { transform: rotate(0deg) translateX(var(--radius)) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(var(--radius)) rotate(-360deg); }
        }
        
        /* üé® SISTEMA DE VALIDACI√ìN VISUAL */
        .input-error {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 1px #ef4444 !important;
        }
        
        .field-error-message {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.25rem;
            color: #ef4444;
            font-size: 0.75rem;
            font-weight: 500;
            animation: slideInError 0.3s ease-out;
        }
        
        @keyframes slideInError {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .field-error-message svg {
            width: 0.875rem;
            height: 0.875rem;
            flex-shrink: 0;
        }
          .input-success {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 1px #10b981 !important;
        }

        /* üé≠ SISTEMA DE MODALES ELEGANTE */
        .nebula-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .nebula-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .nebula-modal {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 16px;
            padding: 2rem;
            min-width: 320px;
            max-width: 500px;
            width: 90%;
            position: relative;
            transform: scale(0.8) translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(15px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .nebula-modal-overlay.active .nebula-modal {
            transform: scale(1) translateY(0);
        }

        .nebula-modal-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .nebula-modal-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nebula-modal-icon.warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .nebula-modal-icon.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .nebula-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
        }

        .nebula-modal-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        .nebula-modal-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .nebula-modal-button {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.875rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nebula-modal-button.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nebula-modal-button.secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
        }

        .nebula-modal-button.primary {
            background: #3b82f6;
            color: white;
        }

        .nebula-modal-button.primary:hover {
            background: #2563eb;
        }

        .nebula-modal-button.danger {
            background: #ef4444;
            color: white;
        }

        .nebula-modal-button.danger:hover {
            background: #dc2626;
        }

        @media (max-width: 640px) {
            .nebula-modal {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .nebula-modal-actions {
                flex-direction: column-reverse;
            }
            
            .nebula-modal-button {
                width: 100%;
                justify-content: center;
            }
        }

        /* üîê AUTHENTICATION STYLES - Email/Password Forms */
        .auth-tab {
            color: rgba(255, 255, 255, 0.6);
            background: transparent;
            border: none;
            cursor: pointer;
        }
        
        .auth-tab.active {
            color: #fcd34d !important;
            background: rgba(252, 211, 77, 0.15) !important;
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.2);
        }
        
        .auth-form input {
            transition: all 0.3s ease;
        }
        
        .auth-form input:focus {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: #fcd34d !important;
            box-shadow: 0 0 20px rgba(252, 211, 77, 0.3) !important;
        }
        
        .login-card {
            background: transparent !important;
        }
        
        /* Mejoras para el contenedor de login */
        .login-card > div {
            backdrop-filter: blur(25px) !important;
            -webkit-backdrop-filter: blur(25px) !important;
        }
        
        /* Logo glow effect */
        .logo-glow {
            animation: logoGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes logoGlow {
            0% { text-shadow: 0 0 20px rgba(252, 211, 77, 0.5); }
            100% { text-shadow: 0 0 30px rgba(252, 211, 77, 0.8), 0 0 40px rgba(252, 211, 77, 0.3); }
        }
        
        .auth-form input:focus {
            outline: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(252, 211, 77, 0.3);
        }
        
        .auth-form input::placeholder {
            transition: color 0.3s ease;
        }
        
        .auth-form input:focus::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }
        
        /* Animaci√≥n suave para mostrar/ocultar formularios */
        .auth-form {
            transition: all 0.3s ease;
        }
        
        .auth-form.hidden {
            opacity: 0;
            transform: translateY(10px);
            pointer-events: none;
        }
        
        /* Estilo para el aviso de verificaci√≥n de email */
        #email-verification-notice {
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Hover effects para botones de auth */
        .auth-form button[type="submit"] {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .auth-form button[type="submit"]:hover {
            box-shadow: 0 8px 25px rgba(252, 211, 77, 0.4);
        }
        
        .auth-form button[type="submit"]:active {
            transform: translateY(1px);
        }
        
        /* Loading state para botones */
        .auth-form button[type="submit"]:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
        }
    </style>
    
    <!-- üîê CARGA DE VARIABLES DE ENTORNO - PRIMER SCRIPT -->
    <script>
        // üîê Cargar variables de entorno antes que cualquier otra cosa
        console.log('üîê Iniciando carga de variables de entorno...');
        
        // Funci√≥n para cargar env-loader
        async function loadEnvironmentVariables() {
            try {
                // Importar env-loader
                const envModule = await import('./env-loader.js');
                
                // Cargar variables de entorno
                await window.NebulaEnv.loadEnvironment();
                
                console.log('‚úÖ Variables de entorno cargadas correctamente');
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Error cargando variables de entorno:', error);
                return false;
            }
        }
        
        // Cargar inmediatamente
        loadEnvironmentVariables().then(success => {
            if (success) {
                console.log('üîê Sistema de variables de entorno listo');
            } else {
                console.log('‚ö†Ô∏è Usando configuraci√≥n por defecto');
            }
        });
    </script>

    <!-- üî• FIREBASE SDK - Carga Prioritaria para Autenticaci√≥n -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- üîê FIREBASE CONFIGURATION - Carga de Configuraci√≥n Segura -->
    <script src="./config/firebase-config.js"></script>
    
    <!-- üîê FIREBASE AUTHENTICATION MODULE - Sistema de Autenticaci√≥n -->
    <script src="./js/auth/firebase-auth.js"></script>
    
    <!-- üéØ TAILWIND - Sin configuraci√≥n problem√°tica -->
      <!-- üöÄ TAILWIND CDN - Carga Diferida Inteligente -->
    <script>
        // üî• SUPER CACHE-BUSTING PARA DEPURACI√ìN
        const CACHE_BUSTER = Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        console.log('üî• Cache-Buster activo:', CACHE_BUSTER);
        
        // üéØ CARGA INTELIGENTE DE TAILWIND
        const loadTailwind = () => {
            if (!document.getElementById('tailwind-css')) {
                const script = document.createElement('script');
                script.id = 'tailwind-css';
                script.src = 'https://cdn.tailwindcss.com';
                script.async = true;
                script.onload = () => {
                    console.log('‚úÖ Tailwind CSS cargado exitosamente');
                };
                script.onerror = () => {
                    console.error('‚ùå Error cargando Tailwind CSS');
                };
                document.head.appendChild(script);
                console.log('üé® Tailwind CSS cargado din√°micamente');
            }
        };
        
        // Cargar Tailwind cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadTailwind);
        } else {
            loadTailwind();
        }
    </script>
    
    <!-- üìä CHART.JS - Carga S√∫per Diferida -->
    <script>
        // üöÄ CARGA CHARTS SOLO CUANDO SEA NECESARIO
        window.loadChartJS = function() {
            return new Promise((resolve, reject) => {
                if (window.Chart) {
                    resolve(window.Chart);
                    return;
                }
                
                console.log('üìä Cargando Chart.js din√°micamente...');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js';
                script.async = true;
                script.onload = () => {
                    console.log('‚úÖ Chart.js cargado exitosamente');
                    resolve(window.Chart);
                };
                script.onerror = () => {
                    console.error('‚ùå Error cargando Chart.js');
                    reject(new Error('Failed to load Chart.js'));
                };
                document.head.appendChild(script);
            });
        };
        
        // üéØ PRECARGAR CHART.JS EN BACKGROUND DESPU√âS DE 2 SEGUNDOS
        setTimeout(() => {
            if (!window.Chart) {
                window.loadChartJS().catch(console.error);
            }
        }, 2000);
    </script>
    
    <!-- üé® CSS EXTERNO - Carga Optimizada -->
    <script>
        // üöÄ CARGA DIFERIDA DE CSS NO CR√çTICO
        const loadCSS = (href, id) => {
            if (!document.getElementById(id)) {
                const link = document.createElement('link');
                link.id = id;
                link.rel = 'stylesheet';
                link.href = href;
                link.media = 'print';
                link.onload = function() { 
                    this.media = 'all'; 
                    console.log(`üé® CSS ${id} cargado`);
                };
                document.head.appendChild(link);
            }
        };
        
        // Cargar CSS no cr√≠tico despu√©s del DOM
        document.addEventListener('DOMContentLoaded', () => {
            loadCSS('css/styles.css', 'styles-css');
            // loadCSS('css/optimized.css', 'optimized-css'); // Archivo no existe
        });
    </script>
</head>
<body>
    <!-- üåå LOADING SCREEN √âPICO -->
    <div id="nebula-loading" class="nebula-loading">
        <div class="text-center">
            <div class="nebula-logo">üåå Nebula</div>
            <div class="text-lg font-medium text-nebula-300 mt-4">Inicializando tu universo financiero...</div>
            <div class="nebula-spinner mx-auto"></div>        </div>
    </div>

    <!-- üåå APLICACI√ìN PRINCIPAL - Container √âpico -->
    <div id="app-container">
        <div id="parallax-bg" class="fixed inset-0 z-0 perspective-[1000px]"></div>
        <main id="content-root" class="relative z-10 pb-24 nebula-fade-in" aria-label="Contenido principal de la aplicaci√≥n"></main>
        <div id="dock-root" class="fixed bottom-0 left-0 right-0 z-20"></div>
        <div id="modal-root" class="fixed inset-0 z-50 pointer-events-none"></div>

        <!-- üé≠ SISTEMA DE MODALES ELEGANTE -->
        <div id="nebula-modal-overlay" class="nebula-modal-overlay">
            <div class="nebula-modal">
                <div class="nebula-modal-header">
                    <div id="nebula-modal-icon" class="nebula-modal-icon">
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    </div>
                    <h3 id="nebula-modal-title" class="nebula-modal-title">Confirmaci√≥n</h3>
                </div>
                <div id="nebula-modal-content" class="nebula-modal-content">
                    ¬øEst√°s seguro de que deseas realizar esta acci√≥n?
                </div>
                <div class="nebula-modal-actions">
                    <button id="nebula-modal-cancel" class="nebula-modal-button secondary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        Cancelar
                    </button>
                    <button id="nebula-modal-confirm" class="nebula-modal-button primary">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
        <div id="notification-container" class="notification-container"></div>
    </div>

    <!-- üîí SEGURIDAD CR√çTICA - Carga Prioritaria -->
    <script src="js/utils/security.js"></script>
    <script src="js/utils/input-validation.js"></script>
    
    <!-- üöÄ SISTEMA DE CARGA MODULAR √âPICO -->
    <script>
        // üéØ M√ìDULOS NEBULA - Configuraci√≥n Inteligente
        const NEBULA_MODULES = {
            // üî• CR√çTICOS - Carga inmediata
            critical: [
                'js/modules/dashboard.js',
                'js/modules/dock-navigation.js'
            ],
            // ‚ö° IMPORTANTES - Carga r√°pida
            important: [
                'js/modules/settings.js',
                'js/modules/grid-cards.js'
            ],            // üåü FUNCIONALES - Carga diferida
            functional: [
                'js/modules/income-new.js',
                'js/modules/expenses-new.js',
                'js/modules/goals-new.js',
                'js/modules/investments-new.js',
                'js/modules/debts-new.js'
            ],
            // üé® EXTRAS - Carga bajo demanda
            extras: [
                'js/modules/calendar.js'
            ]
        };
        
        // üöÄ CARGADOR MODULAR INTELIGENTE
        class NebulaModuleLoader {
            constructor() {
                this.loaded = new Set();
                this.loading = new Map();
                this.totalModules = Object.values(NEBULA_MODULES).flat().length;
                this.loadedCount = 0;
            }
              async loadModule(src) {
                if (this.loaded.has(src)) return true;
                if (this.loading.has(src)) return this.loading.get(src);
                
                const promise = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    // üî• CACHE-BUST AGRESIVO
                    script.src = `${src}?v=${Date.now()}&cb=${Math.random()}`;
                    script.async = true;
                    
                    script.onload = () => {
                        this.loaded.add(src);
                        this.loadedCount++;
                        this.updateProgress();
                        console.log(`‚úÖ ${src.split('/').pop()} cargado (${this.loadedCount}/${this.totalModules})`);
                        resolve(true);
                    };
                    
                    script.onerror = () => {
                        console.error(`‚ùå Error cargando ${src}`);
                        reject(new Error(`Failed to load ${src}`));
                    };
                    
                    document.head.appendChild(script);
                });
                
                this.loading.set(src, promise);
                return promise;
            }
            
            async loadModuleGroup(group, groupName) {
                console.log(`üöÄ Cargando grupo ${groupName}...`);
                const promises = group.map(src => this.loadModule(src));
                
                try {
                    await Promise.all(promises);
                    console.log(`‚úÖ Grupo ${groupName} completado`);
                    return true;
                } catch (error) {
                    console.error(`‚ùå Error en grupo ${groupName}:`, error);
                    return false;
                }
            }
            
            updateProgress() {
                const progress = (this.loadedCount / this.totalModules) * 100;
                const progressText = document.querySelector('#nebula-loading .text-lg');
                if (progressText) {
                    progressText.textContent = `Cargando m√≥dulos... ${Math.round(progress)}%`;
                }
                
                // Ocultar loading cuando est√© completo
                if (this.loadedCount === this.totalModules) {
                    setTimeout(() => this.hideLoading(), 500);
                }
            }
            
            hideLoading() {
                const loading = document.getElementById('nebula-loading');
                if (loading) {
                    loading.classList.add('hidden');
                    setTimeout(() => loading.remove(), 500);
                }
                console.log('üéâ Todos los m√≥dulos cargados - UI lista');
            }
            
            async loadAll() {
                try {
                    // üî• Fase 1: M√≥dulos cr√≠ticos (paralelo)
                    await this.loadModuleGroup(NEBULA_MODULES.critical, 'CR√çTICO');
                    
                    // ‚ö° Fase 2: M√≥dulos importantes (paralelo)
                    await this.loadModuleGroup(NEBULA_MODULES.important, 'IMPORTANTE');
                    
                    // üåü Fase 3: M√≥dulos funcionales (paralelo con delay)
                    setTimeout(() => {
                        this.loadModuleGroup(NEBULA_MODULES.functional, 'FUNCIONAL');
                    }, 100);
                    
                    // üé® Fase 4: M√≥dulos extras (bajo demanda)
                    setTimeout(() => {
                        this.loadModuleGroup(NEBULA_MODULES.extras, 'EXTRAS');
                    }, 500);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Error cr√≠tico cargando m√≥dulos:', error);
                    return false;
                }
            }
        }
        
        // üöÄ INICIALIZAR CARGA INTELIGENTE
        const moduleLoader = new NebulaModuleLoader();
        window.nebulaModuleLoader = moduleLoader; // Disponible globalmente
        
        // Iniciar carga cuando DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => moduleLoader.loadAll());
        } else {
            moduleLoader.loadAll();
        }
    </script>
      <!-- üåå APLICACI√ìN PRINCIPAL - Motor de Inicializaci√≥n -->
    <script type="module">
        // üöÄ NEBULA FINANCIAL v3.0 - LABORATORIO √âPICO
        console.log('üåå Iniciando Nebula Financial v3.0 - LABORATORIO √âPICO');
        
        // üåü FUNCIONES GLOBALES CR√çTICAS - Exponer ANTES de cargar m√≥dulos
        const formatNumberWithDots = (value) => {
            if (!value) return '';
            const numStr = value.toString().replace(/\D/g, '');
            return numStr.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        };
        
        const formatCurrency = (value) => value != null ? `$${formatNumberWithDots(value)}` : '$0';
        
        // Exponer globalmente INMEDIATAMENTE
        window.formatCurrency = formatCurrency;
        window.formatNumberWithDots = formatNumberWithDots;
        window.parseNumberWithDots = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        };
        
        console.log('‚úÖ Funciones globales cr√≠ticas expuestas');
        
        // üîí INICIALIZAR SEGURIDAD CR√çTICA
        if (typeof NebulaSecurityUtils !== 'undefined') {
            NebulaSecurityUtils.init();
            console.log('üîí Sistema de seguridad Nebula inicializado');
        }
        
        if (typeof NebulaInputValidator !== 'undefined') {
            console.log('üîí Sistema de validaci√≥n de entrada inicializado');
        }
        
        // üéØ TIMESTAMP Y VERSION TRACKING
        const buildTimestamp = Date.now();
        console.log('üïê TIMESTAMP CARGA:', new Date().toISOString(), 'Cache-bust activo');
        console.log('üîÑ VERSION C√ìDIGO:', `v3.0_LAB_EPIC_${buildTimestamp}`);
        console.log('üöÄ OPTIMIZACIONES √âPICAS APLICADAS');
        
        // üåü FUNCI√ìN DE ESPERA INTELIGENTE PARA M√ìDULOS
        const waitForModules = () => {
            return new Promise((resolve) => {
                const checkModules = () => {
                    if (window.nebulaModuleLoader && window.nebulaModuleLoader.loadedCount >= 4) {
                        resolve();
                    } else {
                        setTimeout(checkModules, 50);
                    }
                };
                checkModules();
            });
        };        // üöÄ INICIALIZACI√ìN √âPICA DE LA APLICACI√ìN
        const initNebulaEpic = async () => {
            try {
                console.log('‚è≥ Esperando m√≥dulos cr√≠ticos...');
                await waitForModules();
                
                // üéØ IMPORTAR SOLO THEMES (appState ya est√° embebido)
                const { THEMES } = await import('./js/utils/helpers.js');
                
                // üåç HACER THEMES DISPONIBLE PARA startNebula
                window.THEMES = THEMES;
                
                console.log('‚úÖ THEMES cargado, iniciando aplicaci√≥n...');
                
                // üöÄ INICIALIZAR APLICACI√ìN - startNebula har√° el resto (solo si no est√° inicializada)
                if (!window.nebulaInitialized) {
                    startNebula();
                }
                
                console.log('üéâ Nebula Financial inicializado correctamente');
                
                // ÔøΩ EFECTOS VISUALES √âPICOS POST-CARGA
                document.body.classList.add('nebula-loaded');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                
                // üÜò FALLBACK INTELIGENTE
                console.log('üîÑ Activando fallback a versi√≥n estable...');
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 2000);
            }
        };
        
        // üéØ INICIALIZAR CUANDO TODO EST√â LISTO
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initNebulaEpic);
        } else {
            initNebulaEpic();
        }
        
        // üîí FUNCIONES DE SEGURIDAD - Protecci√≥n XSS
        /**
         * Sanitiza strings para prevenir ataques XSS
         * @param {string} str - String a sanitizar
         * @returns {string} String sanitizado
         */        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
        
        // Exponer sanitizeHTML globalmente para los m√≥dulos
        window.sanitizeHTML = sanitizeHTML;

        /**
         * Sanitiza objetos con propiedades de texto
         * @param {object} obj - Objeto a sanitizar
         * @returns {object} Objeto sanitizado
         */
        function sanitizeObject(obj) {
            if (!obj || typeof obj !== 'object') return obj;
            const sanitized = {};
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'string') {
                    sanitized[key] = sanitizeHTML(value);
                } else if (typeof value === 'object') {
                    sanitized[key] = sanitizeObject(value);
                } else {
                    sanitized[key] = value;
                }
            }
            return sanitized;
        }

        /**
         * Establece innerHTML de forma segura
         * @param {Element} element - Elemento DOM
         * @param {string} html - HTML a insertar (ser√° sanitizado si contiene entrada de usuario)
         * @param {boolean} trusted - Si el HTML viene de c√≥digo confiable (default: true)
         */
        function safeSetInnerHTML(element, html, trusted = true) {
            if (!element) return;
            if (trusted) {
                element.innerHTML = html; // HTML confiable del c√≥digo de la app
            } else {
                element.textContent = html; // Entrada de usuario - solo texto
            }
        }

        /**
         * üé® DEFINICI√ìN DE TEMAS VISUALES
         * Cada tema define colores, gradientes y efectos de part√≠culas √∫nicos
         * Todos centrados alrededor del SOL como estrella principal de la aplicaci√≥n
         */
        const THEMES = {            aureoAmanecer: { 
                name: '√Åureo Amanecer', 
                gradient: 'radial-gradient(ellipse at center, #1a1a2e 0%, #16213e 40%, #0f1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ffd700\' fill-opacity=\'0.1\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-amber-300', 
                accentBg: 'bg-amber-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,191,36,0.8)]', 
                accentColor: '#FCD34D', 
                accentBorder: 'border-amber-300', 
                accentRing: 'focus:ring-amber-300', 
                positive: 'text-emerald-300', 
                negative: 'text-rose-300', 
                surface: 'bg-black/20 border-amber-200/30 backdrop-blur-md', 
                textPrimary: 'text-amber-50', 
                textSecondary: 'text-amber-200/80', 
                particleType: 'goldenDust',
                sunColor: '#FFD700'
            },            crisonVespertino: { 
                name: 'Cris√≥n Vespertino', 
                gradient: 'radial-gradient(ellipse at center, #2d1b3d 0%, #4a1942 40%, #1a0f1a 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23ff6b9d\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-rose-300', 
                accentBg: 'bg-rose-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(251,113,133,0.8)]', 
                accentColor: '#FB7185', 
                accentBorder: 'border-rose-300', 
                accentRing: 'focus:ring-rose-300', 
                positive: 'text-teal-300', 
                negative: 'text-orange-300', 
                surface: 'bg-black/20 border-rose-200/30 backdrop-blur-md', 
                textPrimary: 'text-rose-50', 
                textSecondary: 'text-rose-200/80', 
                particleType: 'crimsonMist',
                sunColor: '#FF4C6A'
            },            aguamarinaCeleste: { 
                name: 'Aguamarina Celeste', 
                gradient: 'radial-gradient(ellipse at center, #0f2027 0%, #203a43 40%, #0c1419 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%2367e8f9\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-cyan-300', 
                accentBg: 'bg-cyan-400', 
                accentGlow: 'shadow-[0_0_25px_rgba(103,232,249,0.8)]', 
                accentColor: '#67E8F9', 
                accentBorder: 'border-cyan-300', 
                accentRing: 'focus:ring-cyan-300', 
                positive: 'text-lime-300', 
                negative: 'text-amber-300', 
                surface: 'bg-black/20 border-cyan-200/30 backdrop-blur-md', 
                textPrimary: 'text-cyan-50', 
                textSecondary: 'text-cyan-200/80', 
                particleType: 'aquaFlow',
                sunColor: '#00CED1'
            },            violetaReal: { 
                name: 'Violeta Real', 
                gradient: 'radial-gradient(ellipse at center, #1e1b4b 0%, #312e81 40%, #111827 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23a855f7\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-purple-300', 
                accentBg: 'bg-purple-500', 
                accentGlow: 'shadow-[0_0_25px_rgba(168,85,247,0.8)]', 
                accentColor: '#A855F7', 
                accentBorder: 'border-purple-300', 
                accentRing: 'focus:ring-purple-300', 
                positive: 'text-green-300', 
                negative: 'text-red-300', 
                surface: 'bg-black/20 border-purple-200/30 backdrop-blur-md', 
                textPrimary: 'text-purple-50', 
                textSecondary: 'text-purple-200/80', 
                particleType: 'royalAura',
                sunColor: '#8B5CF6'
            },            esmeraldaBosque: { 
                name: 'Esmeralda Bosque', 
                gradient: 'radial-gradient(ellipse at center, #0c2e1a 0%, #1a472a 40%, #0a1a0f 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%2322c55e\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-green-300', 
                accentBg: 'bg-green-500', 
                accentGlow: 'shadow-[0_0_25px_rgba(34,197,94,0.8)]', 
                accentColor: '#22C55E', 
                accentBorder: 'border-green-300', 
                accentRing: 'focus:ring-green-300', 
                positive: 'text-emerald-300', 
                negative: 'text-red-300', 
                surface: 'bg-black/20 border-green-200/30 backdrop-blur-md', 
                textPrimary: 'text-green-50', 
                textSecondary: 'text-green-200/80', 
                particleType: 'forestMist',
                sunColor: '#10B981'
            },            rosaAurora: { 
                name: 'Rosa Aurora', 
                gradient: 'radial-gradient(ellipse at center, #3d1a2e 0%, #5a1e42 40%, #2a0f1a 100%), url("data:image/svg+xml,%3Csvg width=\'60\' height=\'60\' viewBox=\'0 0 60 60\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cg fill=\'none\' fill-rule=\'evenodd\'%3E%3Cg fill=\'%23f43f5e\' fill-opacity=\'0.08\'%3E%3Ccircle cx=\'7\' cy=\'7\' r=\'1\'/%3E%3Ccircle cx=\'27\' cy=\'27\' r=\'1\'/%3E%3Ccircle cx=\'47\' cy=\'47\' r=\'1\'/%3E%3Ccircle cx=\'17\' cy=\'37\' r=\'0.5\'/%3E%3Ccircle cx=\'37\' cy=\'17\' r=\'0.5\'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E")', 
                accent: 'text-pink-300', 
                accentBg: 'bg-pink-500', 
                accentGlow: 'shadow-[0_0_25px_rgba(244,63,94,0.8)]', 
                accentColor: '#F43F5E', 
                accentBorder: 'border-pink-300', 
                accentRing: 'focus:ring-pink-300', 
                positive: 'text-emerald-300', 
                negative: 'text-orange-300', 
                surface: 'bg-black/20 border-pink-200/30 backdrop-blur-md', 
                textPrimary: 'text-pink-50', 
                textSecondary: 'text-pink-200/80', 
                particleType: 'auroraGlow',
                sunColor: '#EC4899'
            }
        };/**
         * üéØ ICONOS SVG VECTORIALES
         * Conjunto de iconos optimizados para la interfaz
         */
        const ICONS = {            dashboard: `<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/>`,
            income: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4-4 4 4"/><path d="M12 8v8"/>`,
            expenses: `<circle cx="12" cy="12" r="10"/><path d="m8 12 4 4 4-4"/><path d="M12 8v8"/>`,
            goals: `<circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/><circle cx="12" cy="12" r="1"/>`,
            investments: `<path d="M3 3v18h18"/><path d="m4 14 4-4 4 4 6-6"/>`,
            debts: `<rect x="1" y="4" width="22" height="16" rx="3" ry="3"/><line x1="1" y1="10" x2="23" y2="10"/>`,
            achievements: `<path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>`,
            settings: `<circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>`,
            plus: `<path d="M12 5v14m-7-7h14" />`,
            trash: `<path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>`,
            eye: `<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>`,
            eyeOff: `<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 11 8 11 8a18.35 18.35 0 0 1-2.18 3.2M3.5 12a10.43 10.43 0 0 1 2.22-3.2"/><path d="M1 1l22 22"/>`,
            chevronLeft: `<path d="m15 18-6-6 6-6"/>`,
            chevronRight: `<path d="m9 18 6-6-6-6"/>`,
            history: `<path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>`,
            mail: `<rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/>`,
            zap: `<path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>`,
            x: `<path d="M18 6 6 18M6 6l12 12"/>`,
            // Nuevos iconos para notificaciones y calendario
            calendar: `<rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>`,
            check: `<polyline points="20 6 9 17 4 12"/>`,
            alertCircle: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/>`,
            info: `<circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12" y2="8"/>`,
            alertTriangle: `<path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12" y2="17"/>`,
            repeat: `<polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>`,
            copy: `<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>`,
            logOut: `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>`,
            download: `<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>`,
            userX: `<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="m17 8 5 5"/><path d="m22 8-5 5"/>`
        };
        
        /**
         * üìÇ CATEGOR√çAS DE GASTOS DISPONIBLES
         * Lista predefinida para categorizaci√≥n de transacciones
         */
        const CATEGORIES = ['Comida', 'Transporte', 'Ocio', 'Hogar', 'Salud', 'Educaci√≥n', 'Regalos', 'Varios'];        // ===============================================
        // üîî SISTEMA DE NOTIFICACIONES MODERNO
        // ===============================================
        
        /**
         * üì¢ Gestor de Notificaciones
         * Sistema completo para mostrar mensajes al usuario de forma no invasiva
         */
        const NotificationSystem = {
            container: null,
            
            init() {
                this.container = document.getElementById('notification-container');
            },
            
            /**
             * Muestra una notificaci√≥n
             * @param {string} type - Tipo: 'success', 'error', 'warning', 'info'
             * @param {string} title - T√≠tulo de la notificaci√≥n
             * @param {string} message - Mensaje descriptivo
             * @param {number} duration - Duraci√≥n en ms (default: 4000)
             */
            show(type = 'info', title = '', message = '', duration = 4000) {
                if (!this.container) this.init();
                
                const id = Date.now().toString();
                const iconMap = {
                    success: ICONS.check,
                    error: ICONS.alertCircle,
                    warning: ICONS.alertTriangle,
                    info: ICONS.info
                };
                
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.id = `notification-${id}`;
                  notification.innerHTML = `
                    <button class="notification-close" onclick="NotificationSystem.remove('${id}')" aria-label="Cerrar notificaci√≥n" role="button">
                        ${createIcon(ICONS.x, 'w-4 h-4')}
                    </button>
                    <div class="notification-header">
                        ${createIcon(iconMap[type] || iconMap.info, 'w-5 h-5')}
                        <span>${title}</span>
                    </div>
                    <div class="notification-body">${message}</div>
                `;
                
                this.container.appendChild(notification);
                
                // Trigger animation
                requestAnimationFrame(() => {
                    notification.classList.add('show');
                });
                
                // Auto remove
                if (duration > 0) {
                    setTimeout(() => this.remove(id), duration);
                }
                
                return id;
            },
            
            remove(id) {
                const notification = document.getElementById(`notification-${id}`);
                if (notification) {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 400);
                }
            },
            
            // M√©todos convenientes
            success(title, message, duration) {
                return this.show('success', title, message, duration);
            },
            
            error(title, message, duration) {
                return this.show('error', title, message, duration);
            },
            
            warning(title, message, duration) {
                return this.show('warning', title, message, duration);
            },
            
            info(title, message, duration) {
                return this.show('info', title, message, duration);
            }
        };
        
        // üåê Exponer NotificationSystem globalmente INMEDIATAMENTE
        window.NotificationSystem = NotificationSystem;
        console.log('‚úÖ NotificationSystem expuesto globalmente');
        
        /**
         * üéÆ GESTOR CENTRAL DEL ESTADO
         * Maneja toda la l√≥gica de negocio y persistencia de datos
         */
        const appState = {
            // --- Estado de Usuario y Sesi√≥n ---
            user: null, // Inicialmente null para mostrar login
            isLoading: false,
            activeView: 'dashboard',
            activeModal: null,
              // --- Configuraci√≥n y Preferencias ---
            isPrivate: (() => {
                try {
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('isPrivateMode', true) :
                        JSON.parse(localStorage.getItem('isPrivateMode')) ?? true;
                } catch { return true; }
            })(),
            themeKey: (() => {
                try {
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('financialTheme', 'aureoAmanecer') :
                        localStorage.getItem('financialTheme') || 'aureoAmanecer';
                } catch { return 'aureoAmanecer'; }
            })(),
            
            // --- Estado Temporal de Navegaci√≥n ---
            currentDate: new Date(),
            calendarViewYear: new Date().getFullYear(),
              // --- Datos Financieros Principales ---
            data: (() => {
                try {
                    const defaultData = { transactions: {}, goals: [], investments: [], debts: [] };
                    return NebulaSecurityUtils ? 
                        NebulaSecurityUtils.secureGetItem('financialData', defaultData) :
                        JSON.parse(localStorage.getItem('financialData')) || defaultData;
                } catch { 
                    return { transactions: {}, goals: [], investments: [], debts: [] }; 
                }
            })(),
              // --- Getters Computados ---
            get theme() { 
                return THEMES[this.themeKey]; 
            },
            
            get currentMonthKey() { 
                return `${this.currentDate.getFullYear()}-${String(this.currentDate.getMonth() + 1).padStart(2, '0')}`; 
            },
            
            // üé® M√©todo para obtener tema actual (compatibilidad con m√≥dulos)
            getCurrentTheme() {
                return this.theme;
            },
              // --- Persistencia de Datos ---
            saveState() {
                try {
                    if (NebulaSecurityUtils) {
                        // Usar almacenamiento seguro cifrado
                        NebulaSecurityUtils.secureSetItem('financialTheme', this.themeKey);
                        NebulaSecurityUtils.secureSetItem('financialData', this.data);
                        NebulaSecurityUtils.secureSetItem('isPrivateMode', this.isPrivate);
                        console.log('üîí Estado guardado de forma segura');
                    } else {
                        // Fallback a localStorage normal
                        localStorage.setItem('financialTheme', this.themeKey);
                        localStorage.setItem('financialData', JSON.stringify(this.data));
                        localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                        console.log('‚ö†Ô∏è Estado guardado sin cifrado (fallback)');
                    }
                } catch (error) {
                    console.error('‚ùå Error guardando estado:', error);
                    // √öltimo recurso: localStorage directo
                    localStorage.setItem('financialTheme', this.themeKey);
                    localStorage.setItem('financialData', JSON.stringify(this.data));
                    localStorage.setItem('isPrivateMode', JSON.stringify(this.isPrivate));
                }
            },
            
            // --- Autenticaci√≥n ---
            async login(method) {
                console.log(`üîê Iniciando login con m√©todo: ${method}`);
                console.log('üîç NebulaAuth disponible:', !!window.NebulaAuth);
                
                this.isLoading = true; 
                renderApp();
                
                try {
                    if (!window.NebulaAuth) {
                        console.log('‚ö†Ô∏è NebulaAuth no disponible, usando fallback offline directo');
                        throw new Error('Sistema de autenticaci√≥n no disponible');
                    }
                    
                    let user = null;
                    
                    switch (method) {
                        case 'google':
                            console.log('üîç Llamando a NebulaAuth.signInWithGoogle()...');
                            user = await window.NebulaAuth.signInWithGoogle();
                            break;
                        case 'guest':
                            console.log('üîç Llamando a NebulaAuth.signInAnonymously()...');
                            user = await window.NebulaAuth.signInAnonymously();
                            break;
                        default:
                            throw new Error('M√©todo de autenticaci√≥n no soportado');
                    }
                    
                    // Firebase Auth se encarga de actualizar el estado autom√°ticamente
                    // a trav√©s del listener onAuthStateChanged
                    console.log('‚úÖ Login exitoso con m√©todo:', method);
                    
                } catch (error) {
                    console.error('‚ùå Error en login:', error);
                    
                    // Fallback para modo offline si Firebase falla
                    console.log('üîÑ Activando modo offline para m√©todo:', method);
                    this.user = { 
                        name: method === 'google' ? 'Usuario Google (Offline)' : 'Invitado (Offline)',
                        isOffline: true 
                    };
                    sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                    this.isLoading = false;
                    renderApp();
                    
                    // Mostrar notificaci√≥n de modo offline
                    if (window.NotificationSystem) {
                        window.NotificationSystem.warning(
                            'Modo Offline', 
                            'Funcionando sin sincronizaci√≥n en la nube'
                        );
                    }
                }
            },
            
            // Funci√≥n para manejar cambios de estado de Firebase Auth
            handleFirebaseAuthChange(user) {
                if (user) {
                    this.user = {
                        uid: user.uid,
                        name: user.displayName || user.email || 'Usuario',
                        email: user.email,
                        photoURL: user.photoURL,
                        isAnonymous: user.isAnonymous,
                        emailVerified: user.emailVerified,
                        isOffline: false
                    };
                    sessionStorage.setItem('financialUser', JSON.stringify(this.user));
                } else {
                    this.user = null;
                    sessionStorage.removeItem('financialUser');
                }
                
                this.isLoading = false;
                renderApp();
            },
            
            // Funci√≥n para cerrar sesi√≥n
            async logout() {
                try {
                    if (window.NebulaAuth && window.NebulaAuth.isAuthenticated()) {
                        await window.NebulaAuth.signOut();
                    } else {
                        // Logout offline
                        this.user = null;
                        sessionStorage.removeItem('financialUser');
                        renderApp();
                    }
                } catch (error) {
                    console.error('‚ùå Error en logout:', error);
                    // Forzar logout local aunque falle Firebase
                    this.user = null;
                    sessionStorage.removeItem('financialUser');
                    renderApp();
                }
            },
            
            // --- Configuraci√≥n Visual ---
            setTheme(key) { 
                this.themeKey = key; 
                this.saveState(); 
                renderApp(); 
            },
            
            setView(view) { 
                this.activeView = view; 
                renderApp(); 
            },
            
            togglePrivacy() { 
                this.isPrivate = !this.isPrivate; 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Navegaci√≥n Temporal ---
            changeMonth(direction) { 
                this.currentDate.setMonth(this.currentDate.getMonth() + direction); 
                renderApp(); 
            },
            
            setCalendarDate(monthIndex) {
                this.currentDate = new Date(this.calendarViewYear, monthIndex, 1);
                this.closeModal(true);
            },
            
            // --- Gesti√≥n de Modales ---
            openModal(modalType) {
                if (modalType === 'calendar') {
                    this.calendarViewYear = this.currentDate.getFullYear();
                }
                this.activeModal = modalType;
                renderModal();
            },
            
            closeModal(shouldRenderAppAfter = false) {
                const modalContainer = document.querySelector('.modal-container');
                if (modalContainer) {
                    modalContainer.classList.remove('modal-enter');
                    modalContainer.classList.add('modal-leave');
                    modalContainer.addEventListener('animationend', () => {
                        this.activeModal = null;
                        renderModal(); 
                        if (shouldRenderAppAfter) renderApp();
                    }, { once: true });
                } else {
                     this.activeModal = null;
                     if (shouldRenderAppAfter) renderApp();
                }
            },
              // --- Navegaci√≥n de Calendario Mejorada ---
            changeCalendarYear(direction) { 
                const newYear = this.calendarViewYear + direction;
                
                // Validar rango de a√±os
                if (newYear >= 1900 && newYear <= 2100) {
                    this.calendarViewYear = newYear;
                    renderModal();
                    
                    // Feedback visual suave
                    const yearInput = document.getElementById('calendar-year-input');
                    if (yearInput) {
                        yearInput.style.transform = 'scale(1.05)';
                        setTimeout(() => {
                            yearInput.style.transform = 'scale(1)';
                        }, 150);
                    }
                } else {
                    // Feedback para l√≠mites alcanzados
                    if (window.NotificationSystem) {
                        const limitMessage = newYear < 1900 ? 
                            'Has alcanzado el a√±o m√≠nimo (1900)' : 
                            'Has alcanzado el a√±o m√°ximo (2100)';
                        window.NotificationSystem.warning('L√≠mite de navegaci√≥n', limitMessage);
                    }
                }
            },
            
            setCalendarYear(year) { 
                if (year >= 1900 && year <= 2100) {
                    this.calendarViewYear = year;
                    renderModal();
                    
                    // Feedback positivo
                    if (window.NotificationSystem) {
                        window.NotificationSystem.info('Calendario', `Navegando a ${year}`);
                    }
                } else {
                    // Feedback de error para a√±os fuera de rango
                    if (window.NotificationSystem) {
                        window.NotificationSystem.error('A√±o inv√°lido', 'Por favor ingresa un a√±o entre 1900 y 2100');
                    }
                    
                    // Restaurar el valor v√°lido en el input
                    const yearInput = document.getElementById('calendar-year-input');
                    if (yearInput) {
                        yearInput.value = this.calendarViewYear;
                    }
                }
            },
            
            goToday() { 
                this.currentDate = new Date(); 
                this.calendarViewYear = this.currentDate.getFullYear(); 
                this.closeModal(true);
                
                // Feedback de navegaci√≥n
                if (window.NotificationSystem) {
                    const today = new Date();
                    const monthName = today.toLocaleString('es-ES', { month: 'long' });
                    window.NotificationSystem.success('Calendario', `Navegando a ${monthName} ${today.getFullYear()}`);
                }
            },// --- Gesti√≥n de Transacciones ---
            addTransaction(t) {
                const key = this.currentMonthKey;
                if (!this.data.transactions[key]) this.data.transactions[key] = [];
                this.data.transactions[key].push({ 
                    ...t, 
                    id: Date.now(), 
                    date: new Date().toISOString() 
                });
                this.saveState();
                renderApp();
            },
            
            deleteTransaction(id) {
                const key = this.currentMonthKey;
                if(this.data.transactions[key]) {
                    this.data.transactions[key] = this.data.transactions[key].filter(t => t.id !== id);
                    this.saveState();
                    renderApp();
                }
            },
              repeatPreviousMonth(type) {
                const prevDate = new Date(this.currentDate);
                prevDate.setMonth(prevDate.getMonth() - 1);
                const prevKey = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
                const prevTransactions = this.data.transactions[prevKey] || [];
                const transactionsToCopy = prevTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length > 0) {
                    transactionsToCopy.forEach(t => this.addTransaction({ 
                        ...t, 
                        date: new Date().toISOString() 
                    }));
                    NotificationSystem.success('√âxito', 
                        `Se copiaron ${transactionsToCopy.length} transacciones del mes anterior`);
                } else {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones del mes anterior para copiar');
                }
            },
            
            /**
             * üìÖ Repite transacciones actuales hasta fin de a√±o
             * @param {string} type - Tipo de transacci√≥n ('income' o 'expense')
             */
            repeatYearlyFromCurrent(type) {
                const currentTransactions = this.data.transactions[this.currentMonthKey] || [];
                const transactionsToCopy = currentTransactions.filter(t => t.type === type);
                
                if (transactionsToCopy.length === 0) {
                    NotificationSystem.warning('Sin datos', 
                        'No hay transacciones en el mes actual para copiar');
                    return;
                }
                
                const currentYear = this.currentDate.getFullYear();
                const currentMonth = this.currentDate.getMonth();
                let totalCopied = 0;
                
                // Copiar a todos los meses restantes del a√±o
                for (let month = currentMonth + 1; month < 12; month++) {
                    const targetKey = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                    
                    if (!this.data.transactions[targetKey]) {
                        this.data.transactions[targetKey] = [];
                    }
                    
                    transactionsToCopy.forEach(t => {
                        const newTransaction = {
                            ...t,
                            id: Date.now() + Math.random(), // ID √∫nico
                            date: new Date(currentYear, month, new Date(t.date).getDate()).toISOString()
                        };
                        this.data.transactions[targetKey].push(newTransaction);
                        totalCopied++;
                    });
                }
                
                if (totalCopied > 0) {
                    this.saveState();
                    NotificationSystem.success('√âxito', 
                        `Se copiaron ${totalCopied} transacciones hasta fin de a√±o`);
                } else {
                    NotificationSystem.info('Sin cambios', 
                        'Ya es diciembre o no hay meses restantes');
                }
            },
            
            // --- Gesti√≥n de Metas ---
            addGoal(g) { 
                this.data.goals.push({ 
                    ...g, 
                    id: Date.now(), 
                    saved: 0 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteGoal(id) { 
                this.data.goals = this.data.goals.filter(goal => goal.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            // --- Gesti√≥n de Inversiones ---
            addInvestment(i) { 
                this.data.investments.push({ 
                    ...i, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteInvestment(id) { 
                this.data.investments = this.data.investments.filter(inv => inv.id !== id); 
                this.saveState(); 
                renderApp(); 
            },
            
            updateInvestment(id, newAmount) {
                const investment = this.data.investments.find(inv => inv.id === id);
                if (investment) investment.currentAmount = newAmount;
                this.saveState();
                if(this.activeView === 'investments') {
                    document.querySelector('#content-root > main').innerHTML = renderInvestmentsView();
                }
            },
            
            // --- Gesti√≥n de Deudas ---
            addDebt(d) { 
                this.data.debts.push({ 
                    ...d, 
                    id: Date.now() 
                }); 
                this.saveState(); 
                renderApp(); 
            },
            
            deleteDebt(id) { 
                this.data.debts = this.data.debts.filter(debt => debt.id !== id); 
                this.saveState(); 
                renderApp(); 
            }        };
        
        // üåê Exponer appState globalmente INMEDIATAMENTE
        window.appState = appState;
        console.log('‚úÖ appState expuesto globalmente');

        // ===============================================
        // üîß UTILIDADES Y FUNCIONES AUXILIARES
        // ===============================================
        /**
         * üî¢ Convierte n√∫mero formateado a n√∫mero plano
         * @param {string} value - Valor formateado con puntos
         * @returns {number} N√∫mero sin formato
         */
        const parseFormattedNumber = (value) => parseFloat(String(value).replace(/\./g, '')) || 0;
          // Exponer funciones adicionales globalmente
        window.parseFormattedNumber = parseFormattedNumber;
        
        /**
         * üé® SISTEMA DE VALIDACI√ìN VISUAL
         * CloudSonnet4: Sistema modular para mensajes de error elegantes
         */
        
        // Funci√≥n para mostrar error en campo espec√≠fico
        function showFieldError(inputElement, message) {
            if (!inputElement) return;
            
            // Remover error previo
            clearFieldError(inputElement);
            
            // Agregar clase de error al input
            inputElement.classList.add('input-error');
            inputElement.setAttribute('aria-invalid', 'true');
            
            // Crear mensaje de error
            const errorElement = document.createElement('div');
            errorElement.className = 'field-error-message';
            errorElement.id = `${inputElement.id || inputElement.name}-error`;
            errorElement.setAttribute('role', 'alert');
            errorElement.innerHTML = `
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                ${message}
            `;
            
            // Insertar despu√©s del input
            inputElement.parentNode.insertBefore(errorElement, inputElement.nextSibling);
            
            // Configurar aria-describedby
            inputElement.setAttribute('aria-describedby', errorElement.id);
            
            // Auto-clear cuando el usuario escriba
            const clearOnInput = () => {
                clearFieldError(inputElement);
                inputElement.removeEventListener('input', clearOnInput);
            };
            inputElement.addEventListener('input', clearOnInput);
        }
        
        // Funci√≥n para limpiar error de campo
        function clearFieldError(inputElement) {
            if (!inputElement) return;
            
            inputElement.classList.remove('input-error');
            inputElement.classList.add('input-success');
            inputElement.removeAttribute('aria-invalid');
            
            // Remover mensaje de error
            const errorId = `${inputElement.id || inputElement.name}-error`;
            const errorElement = document.getElementById(errorId);
            if (errorElement) {
                errorElement.remove();
            }
            
            // Limpiar aria-describedby
            inputElement.removeAttribute('aria-describedby');
            
            // Remover clase success despu√©s de un tiempo
            setTimeout(() => {
                inputElement.classList.remove('input-success');
            }, 2000);
        }
        
        // Funci√≥n para validar campo obligatorio
        function validateField(inputElement, fieldName) {
            const value = inputElement.value.trim();
            if (!value) {
                showFieldError(inputElement, `Por favor ingresa ${fieldName}`);
                return false;
            }
            clearFieldError(inputElement);
            return true;
        }
        
        // Funci√≥n para validar formulario completo
        function validateForm(formElement) {
            const requiredFields = formElement.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                const fieldName = field.getAttribute('data-field-name') || 
                                 field.previousElementSibling?.textContent || 
                                 'este campo';
                
                if (!validateField(field, fieldName)) {
                    isValid = false;
                }
            });
            
            return isValid;
        }
          // CloudSonnet4: Exponer funciones globalmente para uso en m√≥dulos
        window.showFieldError = showFieldError;
        window.clearFieldError = clearFieldError;
        window.validateField = validateField;
        window.validateForm = validateForm;

        /**
         * üé≠ SISTEMA DE MODALES ELEGANTE
         * CloudSonnet4: Reemplazo profesional para alert() y confirm()
         */
        
        // Funci√≥n para mostrar modal de confirmaci√≥n
        function showConfirmModal(title, content, type = 'warning', options = {}) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('nebula-modal-overlay');
                const modalTitle = document.getElementById('nebula-modal-title');
                const modalContent = document.getElementById('nebula-modal-content');
                const modalIcon = document.getElementById('nebula-modal-icon');
                const cancelButton = document.getElementById('nebula-modal-cancel');
                const confirmButton = document.getElementById('nebula-modal-confirm');
                
                // Configurar contenido
                modalTitle.textContent = title;
                modalContent.innerHTML = content;
                
                // Configurar icono seg√∫n tipo
                modalIcon.className = `nebula-modal-icon ${type}`;
                if (type === 'danger') {
                    modalIcon.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                    `;
                } else {
                    modalIcon.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    `;
                }
                
                // Configurar botones
                cancelButton.textContent = options.cancelText || 'Cancelar';
                confirmButton.textContent = options.confirmText || 'Confirmar';
                
                // Configurar estilo del bot√≥n de confirmar
                confirmButton.className = `nebula-modal-button ${type === 'danger' ? 'danger' : 'primary'}`;
                
                // Funci√≥n para cerrar modal
                const closeModal = () => {
                    overlay.classList.remove('active');
                    document.removeEventListener('keydown', handleKeydown);
                };
                
                // Manejar teclas
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        resolve(false);
                    } else if (e.key === 'Enter') {
                        closeModal();
                        resolve(true);
                    }
                };
                
                // Event listeners
                const handleCancel = () => {
                    closeModal();
                    resolve(false);
                };
                
                const handleConfirm = () => {
                    closeModal();
                    resolve(true);
                };
                
                // Limpiar listeners previos
                cancelButton.removeEventListener('click', handleCancel);
                confirmButton.removeEventListener('click', handleConfirm);
                
                // A√±adir listeners
                cancelButton.addEventListener('click', handleCancel);
                confirmButton.addEventListener('click', handleConfirm);
                document.addEventListener('keydown', handleKeydown);
                
                // Cerrar al hacer clic fuera del modal
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        closeModal();
                        resolve(false);
                    }
                });
                
                // Mostrar modal
                overlay.classList.add('active');
                
                // Focus en el bot√≥n de cancelar para accesibilidad
                setTimeout(() => cancelButton.focus(), 100);
            });
        }
        
        // Funciones de conveniencia para diferentes tipos de modales
        const showWarningModal = (title, content, options = {}) => 
            showConfirmModal(title, content, 'warning', options);
            
        const showDangerModal = (title, content, options = {}) => 
            showConfirmModal(title, content, 'danger', options);
        
        // CloudSonnet4: Exponer funciones globalmente
        window.showConfirmModal = showConfirmModal;
        window.showWarningModal = showWarningModal;
        window.showDangerModal = showDangerModal;
        
        /**
         * üé® Crea elemento SVG de icono
         * @param {string} path - Path del icono SVG
         * @param {string} className - Clases CSS adicionales
         * @returns {string} HTML del icono SVG
         */
        const createIcon = (path, className = "w-6 h-6") => 
            `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">${path}</svg>`;

        // ===============================================
        // üèóÔ∏è REFERENCIAS DOM PRINCIPALES        // ===============================================
        // üéØ REFERENCIAS A ELEMENTOS DEL DOM (se inicializan m√°s tarde)
        // ===============================================
        
        let contentRoot, dockRoot, parallaxBg, modalRoot;// ===============================================
        // üñºÔ∏è FUNCIONES DE RENDERIZADO PRINCIPAL
        // ===============================================
          /**
         * üéØ RENDERIZADOR PRINCIPAL DE LA APLICACI√ìN
         * Controla el flujo de renderizado seg√∫n el estado actual
         */        function renderApp() {
            console.log('üñºÔ∏è renderApp llamado - Estado usuario:', !!appState.user);
            console.log('üñºÔ∏è appState.isLoading:', appState.isLoading);
            
            // Las part√≠culas de fondo se manejan directamente en parallax-bg
            parallaxBg.innerHTML = renderParallaxBackground();
            
            if (appState.isLoading) {
                console.log('üñºÔ∏è Renderizando pantalla de carga...');
                contentRoot.innerHTML = renderLoadingScreen();
                dockRoot.innerHTML = '';
            } else if (!appState.user) {
                console.log('üñºÔ∏è Renderizando vista de login...');
                contentRoot.innerHTML = renderLoginView();
                dockRoot.innerHTML = '';
            } else {
                console.log('üñºÔ∏è Renderizando dashboard - usuario logueado');
                let viewHTML = '';
                
                // Agregar selector de mes para vistas que lo requieren
                if(!['settings', 'achievements', 'goals', 'investments', 'debts'].includes(appState.activeView)) {
                   viewHTML += renderMonthSelector();
                }                // Renderizar vista seg√∫n selecci√≥n activa
                switch (appState.activeView) {
                    case 'dashboard': 
                        viewHTML += window.NebulaDashboardModule ? window.NebulaDashboardModule.render() : renderDashboard(); 
                        break;
                    case 'income': 
                        viewHTML += window.NebulaIncomeModule ? window.NebulaIncomeModule.render() : renderTransactionsView('income'); 
                        break;
                    case 'expenses': 
                        viewHTML += window.NebulaExpensesModule ? window.NebulaExpensesModule.render() : renderTransactionsView('expense'); 
                        break;
                    case 'goals': 
                        viewHTML += window.NebulaGoalsModule ? window.NebulaGoalsModule.render() : renderGoalsView(); 
                        break;
                    case 'investments': 
                        viewHTML += window.NebulaInvestmentsModule ? window.NebulaInvestmentsModule.render() : renderInvestmentsView(); 
                        break;
                    case 'debts': 
                        viewHTML += window.NebulaDebtsModule ? window.NebulaDebtsModule.render() : renderDebtsView(); 
                        break;
                    case 'settings': 
                        viewHTML += window.NebulaSettingsModule ? window.NebulaSettingsModule.render() : renderSettingsView(); 
                        break;
                    default: 
                        viewHTML += renderComingSoon(appState.activeView);
                }
                
                contentRoot.innerHTML = `<main class="p-4 sm:p-6 md:p-8 max-w-7xl mx-auto w-full view-transition">${viewHTML}</main>`;
                dockRoot.innerHTML = renderDock();
            }
            
            addEventListeners();
            
            // ÔøΩüîß ASEGURAR QUE LOS FORMULARIOS DE AUTH EST√âN DISPONIBLES
            // Solo si estamos en la vista de login (usuario no autenticado)
            if (!appState.user) {
                console.log('üîß Configurando auth listeners despu√©s del renderizado...');
                setTimeout(() => {
                    // Forzar reconfiguraci√≥n para asegurar que los elementos DOM existen
                    authListenersRegistered = false;
                    setupAuthListeners();
                }, 100); // Aumentado el delay para asegurar que el DOM est√© listo
            }
            
            // Actualizar glider despu√©s del renderizado
            setTimeout(() => updateDockGlider(), 100);
        }

        // üöÄ CloudSonnet4 - Funci√≥n global para cargar secciones (para uso de m√≥dulos)
        window.loadSection = function(sectionName) {
            if (sectionName && sectionName !== appState.activeView) {
                appState.activeView = sectionName;
            }
            window.currentSection = appState.activeView; // Para que los m√≥dulos sepan en qu√© secci√≥n est√°n
            renderApp();
        };

          // ===============================================
        // üé≠ FUNCIONES DE RENDERIZADO DE VISTAS ESPECIALES
        // ===============================================
        
        /**
         * üîê Vista de Login/Autenticaci√≥n - Versi√≥n Simple
         */
        function renderLoginView() {
            return `
                <div class="flex flex-col items-center justify-center h-screen p-4 relative" style="z-index: 10;">
                    <!-- Logo y T√≠tulo -->
                    <div class="text-center mb-12">
                        <h1 class="text-6xl font-black logo-glow mb-4">üåå Nebula</h1>
                        <p class="text-xl font-medium text-white/60">Tu universo financiero personal</p>
                    </div>

                    <!-- Card Principal Ultra Simple -->
                    <div class="backdrop-blur-lg rounded-2xl p-8 w-full max-w-sm relative z-10" 
                         style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);">
                        
                        <div class="space-y-4">
                            <!-- Google Login -->
                            <button id="google-login-btn" class="login-button w-full py-4 rounded-xl flex items-center justify-center gap-3 text-lg font-semibold transition-all" 
                                    style="background: rgba(255, 255, 255, 0.95); color: #1f2937;">
                                <svg class="w-6 h-6" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                    <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                    <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                    <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                </svg>
                                INGRESAR CON GOOGLE
                            </button>
                            
                            <!-- Guest Login -->
                            <button id="guest-login-btn" class="login-button w-full py-4 rounded-xl flex items-center justify-center gap-3 text-lg font-semibold transition-all" 
                                    style="background: rgba(255, 255, 255, 0.08); color: white; border: 1px solid rgba(255, 255, 255, 0.2);">
                                <span class="text-2xl">üë§</span>
                                ENTRAR COMO INVITADO
                            </button>
                            
                            <!-- Email Registration -->
                            <button id="email-register-btn" class="login-button w-full py-4 rounded-xl flex items-center justify-center gap-3 text-lg font-semibold transition-all" 
                                    style="background: transparent; color: #fcd34d; border: 1px solid rgba(252, 211, 77, 0.4);">
                                <span class="text-2xl">‚úâÔ∏è</span>
                                CREAR CUENTA CON OTRO CORREO
                            </button>
                        </div>
                        
                        <!-- Footer text -->
                        <div class="mt-6 text-center">
                            <p class="text-white/40 text-sm">
                                Al continuar aceptas nuestros t√©rminos de uso
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para crear cuenta con email -->
                <div id="email-register-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
                    <div class="backdrop-blur-lg rounded-2xl p-8 w-full max-w-md" style="background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255, 255, 255, 0.15);">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-white">Crear Cuenta</h2>
                            <button id="close-register-modal" class="text-white/60 hover:text-white text-2xl">√ó</button>
                        </div>
                        
                        <form id="email-register-form" class="space-y-4">
                            <div>
                                <input type="text" id="register-name" placeholder="Tu nombre completo"
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all" required>
                            </div>
                            <div>
                                <input type="email" id="register-email" placeholder="tu@email.com"
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all" required>
                            </div>
                            <div>
                                <input type="password" id="register-password" placeholder="Contrase√±a (m√≠n. 6 caracteres)"
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all" required>
                            </div>
                            
                            <button type="submit" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-slate-900 font-bold py-3 rounded-xl hover:from-yellow-500 hover:to-yellow-600 transition-all transform hover:scale-105">
                                ‚ú® Crear Cuenta
                            </button>
                        </form>
                        
                        <div class="mt-4 text-center">
                            <button id="switch-to-login" class="text-yellow-400 hover:text-yellow-300 text-sm underline">
                                ¬øYa tienes cuenta? Inicia sesi√≥n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Modal de login con email -->
                <div id="email-login-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
                    <div class="backdrop-blur-lg rounded-2xl p-8 w-full max-w-md" style="background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255, 255, 255, 0.15);">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-white">Iniciar Sesi√≥n</h2>
                            <button id="close-login-modal" class="text-white/60 hover:text-white text-2xl">√ó</button>
                        </div>
                        
                        <form id="email-login-form" class="space-y-4">
                            <div>
                                <input type="email" id="login-email" placeholder="tu@email.com"
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all" required>
                            </div>
                            <div>
                                <input type="password" id="login-password" placeholder="Contrase√±a"
                                       class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all" required>
                            </div>
                            
                            <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-3 rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all transform hover:scale-105">
                                üöÄ Iniciar Sesi√≥n
                            </button>
                        </form>
                        
                        <div class="mt-4 text-center space-y-2">
                            <button id="forgot-password" class="block w-full text-white/60 hover:text-yellow-400 text-sm">
                                ¬øOlvidaste tu contrase√±a?
                            </button>
                            <button id="switch-to-register" class="text-yellow-400 hover:text-yellow-300 text-sm underline">
                                ¬øNo tienes cuenta? Crear una
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * üìß Formulario de Autenticaci√≥n con Email
         */
        function renderAuthForm() {
            return `
                <div class="auth-form-container">
                    <!-- Tabs Login/Registro -->
                    <div class="flex bg-white/10 rounded-xl p-1 mb-6 backdrop-blur-sm">
                        <button id="login-tab" class="auth-tab flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all active" style="background: rgba(252, 211, 77, 0.15); color: #fcd34d;">
                            Ingresar
                        </button>
                        <button id="register-tab" class="auth-tab flex-1 py-3 px-4 rounded-lg text-sm font-medium transition-all" style="color: rgba(255, 255, 255, 0.6);">
                            Crear Cuenta
                        </button>
                    </div>
                    
                    <!-- Formulario Login -->
                    <form id="login-form" class="auth-form space-y-4">
                        <div class="space-y-4">
                            <div>
                                <input type="email" 
                                       id="login-email" 
                                       placeholder="tu@email.com"
                                       class="w-full bg-white/8 border border-white/15 rounded-xl px-4 py-4 text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all backdrop-blur-sm"
                                       required>
                            </div>
                            <div>
                                <input type="password" 
                                       id="login-password" 
                                       placeholder="Contrase√±a"
                                       class="w-full bg-white/8 border border-white/15 rounded-xl px-4 py-4 text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all backdrop-blur-sm"
                                       required>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-yellow-400 to-yellow-500 text-slate-900 font-bold py-4 px-4 rounded-xl hover:from-yellow-500 hover:to-yellow-600 transition-all transform hover:scale-105 hover:shadow-lg text-lg">
                            üöÄ Ingresar
                        </button>
                        
                        <button type="button" id="forgot-password-btn" class="w-full text-sm ${appState.theme.textSecondary} hover:text-yellow-400 transition-colors py-2">
                            ¬øOlvidaste tu contrase√±a?
                        </button>
                    </form>
                    
                    <!-- Formulario Registro -->
                    <form id="register-form" class="auth-form space-y-4 hidden">
                        <div class="space-y-4">
                            <div>
                                <input type="text" 
                                       id="register-name" 
                                       placeholder="Tu nombre completo"
                                       class="w-full bg-white/8 border border-white/15 rounded-xl px-4 py-4 text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all backdrop-blur-sm">
                            </div>
                            <div>
                                <input type="email" 
                                       id="register-email" 
                                       placeholder="tu@email.com"
                                       class="w-full bg-white/8 border border-white/15 rounded-xl px-4 py-4 text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all backdrop-blur-sm"
                                       required>
                            </div>
                            <div>
                                <input type="password" 
                                       id="register-password" 
                                       placeholder="Contrase√±a (m√≠n. 6 caracteres)"
                                       class="w-full bg-white/8 border border-white/15 rounded-xl px-4 py-4 text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all backdrop-blur-sm"
                                       required>
                            </div>
                            <div>
                                <input type="password" 
                                       id="register-confirm-password" 
                                       placeholder="Confirmar contrase√±a"
                                       class="w-full bg-white/8 border border-white/15 rounded-xl px-4 py-4 text-white placeholder-white/50 focus:ring-2 focus:ring-yellow-400 focus:border-yellow-400 focus:outline-none transition-all backdrop-blur-sm"
                                       required>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-green-400 to-green-500 text-slate-900 font-bold py-4 px-4 rounded-xl hover:from-green-500 hover:to-green-600 transition-all transform hover:scale-105 hover:shadow-lg text-lg">
                            ‚ú® Crear Cuenta
                        </button>
                        
                        <div class="text-xs ${appState.theme.textSecondary} text-center py-2">
                            Al crear una cuenta aceptas nuestros t√©rminos de uso
                        </div>
                    </form>
                    
                    <!-- Mensaje de verificaci√≥n de email -->
                    <div id="email-verification-notice" class="hidden mt-4 p-4 bg-blue-500/20 border border-blue-400/30 rounded-xl backdrop-blur-sm">
                        <div class="text-sm text-blue-300 text-center">
                            üìß Hemos enviado un email de verificaci√≥n.<br>
                            <button id="resend-verification" class="text-yellow-400 hover:text-yellow-300 underline mt-2">
                                Reenviar email
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * ‚è≥ Pantalla de Carga con Animaci√≥n Orbital
         */
        function renderLoadingScreen() {
            return `
                <div class="fixed inset-0 flex flex-col items-center justify-center text-white z-50">
                    <div class="w-64 h-64 relative mb-8">
                        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 bg-yellow-400 rounded-full ${appState.theme.accentGlow}"></div>
                        <div class="absolute inset-0 animate-[spin_20s_linear_infinite]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-4 h-4 bg-red-500 rounded-full"></div>
                        </div>
                        <div class="absolute inset-4 animate-[spin_30s_linear_infinite_reverse]">
                            <div class="absolute top-0 left-1/2 -translate-x-1/2 w-6 h-6 bg-blue-500 rounded-full"></div>
                        </div>
                        <div class="absolute inset-10 animate-[spin_45s_linear_infinite]">
                            <div class="absolute bottom-0 right-1/2 translate-x-1/2 w-5 h-5 bg-green-500 rounded-full"></div>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-white mb-2">Alineando las estrellas...</h1>
                    <p class="${appState.theme.textSecondary}">Cargando tu universo financiero.</p>
                </div>
            `;
        }
          /**
         * üìÖ Selector de Mes con Calendario Desplegable
         */        function renderMonthSelector() {
            const today = new Date();
            const currentDate = appState.currentDate;
            const monthName = currentDate.toLocaleString('es-ES', { month: 'long' });
            const year = currentDate.getFullYear();
            
            // Determinar si es pasado, presente o futuro
            let timeLabel = '';
            if (currentDate.getFullYear() < today.getFullYear() || 
                (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() < today.getMonth())) {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full bg-amber-500/20 text-amber-300 font-medium backdrop-blur-sm border border-amber-400/30">‚ú® PASADO</span>`;
            } else if (currentDate.getFullYear() > today.getFullYear() || 
                      (currentDate.getFullYear() === today.getFullYear() && currentDate.getMonth() > today.getMonth())) {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full bg-cyan-500/20 text-cyan-300 font-medium backdrop-blur-sm border border-cyan-400/30">üöÄ FUTURO</span>`;
            } else {
                timeLabel = `<span class="text-xs px-3 py-1 rounded-full ${appState.theme.accentBg}/20 ${appState.theme.accent} font-medium backdrop-blur-sm border ${appState.theme.accentBorder}/30">üåü ACTUAL</span>`;
            }
            
            return `
                <div class="text-center mb-8 relative">
                    <!-- T√≠tulo principal centrado con efectos -->
                    <div class="flex flex-col items-center gap-3 mb-6">
                        <h1 class="text-3xl sm:text-4xl font-black ${appState.theme.textPrimary} capitalize relative">
                            <span class="relative z-10 bg-gradient-to-r from-${appState.theme.accent.replace('text-', '')} to-${appState.theme.accent.replace('text-', '')} bg-clip-text text-transparent filter drop-shadow-lg">
                                ${monthName} ${year}
                            </span>
                            <!-- Efecto de brillo sutil -->
                            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent blur-sm opacity-30 animate-pulse"></div>
                            <!-- Sombra de resplandor -->
                            <div class="absolute inset-0 ${appState.theme.accentGlow} opacity-20 blur-lg"></div>
                        </h1>
                        ${timeLabel}
                    </div>
                    
                    <!-- Controles de navegaci√≥n centrados -->
                    <div class="flex items-center justify-center gap-4">                        <button id="month-prev" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Mes anterior (‚Üê)" aria-label="Ir al mes anterior" role="button">
                            ${createIcon(ICONS.chevronLeft, "w-6 h-6")}
                        </button>
                        
                        <div class="relative">
                            <button id="calendar-dropdown-button" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Seleccionar mes (C)" aria-label="Abrir selector de mes" role="button" aria-haspopup="true" aria-expanded="false">
                                ${createIcon(ICONS.calendar, "w-6 h-6")}
                            </button>
                            
                            <div id="calendar-dropdown" class="hidden absolute left-1/2 transform -translate-x-1/2 top-14 z-50 backdrop-blur-md rounded-xl shadow-lg p-4 ${appState.theme.surface} w-64">
                                <div class="grid grid-cols-3 gap-2">
                                    ${Array.from({length: 12}, (_, i) => {
                                        const monthKey = `${year}-${String(i + 1).padStart(2, '0')}`;
                                        const hasData = appState.data.transactions[monthKey] && 
                                                       Object.values(appState.data.transactions[monthKey]).length > 0;
                                        const isCurrentMonth = i === currentDate.getMonth();
                                        const isToday = i === today.getMonth() && year === today.getFullYear();
                                        
                                        let classes = 'month-dropdown-item p-2 rounded-lg text-sm font-medium transition-all hover:bg-black/10 cursor-pointer text-center backdrop-blur-sm';
                                        
                                        if (isCurrentMonth) {
                                            classes += ` ring-2 ${appState.theme.accentRing} ${appState.theme.accent} ${appState.theme.accentGlow}`;
                                        } else if (isToday) {
                                            classes += ` ${appState.theme.accentBg} text-slate-900`;
                                        } else if (hasData) {
                                            classes += ` bg-black/20 ${appState.theme.textPrimary} backdrop-blur-md`;
                                        } else {
                                            classes += ` ${appState.theme.textSecondary}`;
                                        }
                                        
                                        return `<div class="${classes}" data-month="${i}">${new Date(year, i).toLocaleString('es-ES', {month: 'short'})}</div>`;
                                    }).join('')}
                                </div>
                                
                                <div class="mt-4 pt-3 border-t border-white/10 flex justify-between items-center">
                                    <button id="today-shortcut" class="text-xs ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-2 py-1 rounded">
                                        üè† Ir a hoy
                                    </button>
                                    <div class="flex items-center gap-2 text-xs ${appState.theme.textSecondary}">
                                        <span class="w-2 h-2 rounded-full ${appState.theme.accentBg}"></span>Hoy
                                        <span class="w-2 h-2 rounded-full bg-white/20"></span>Con datos
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button id="month-next" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-3 rounded-full transition-all hover:scale-110 ${appState.theme.surface} backdrop-blur-sm" title="Mes siguiente (‚Üí)">
                            ${createIcon(ICONS.chevronRight, "w-6 h-6")}
                        </button>
                    </div>
                </div>
            `;
        }
          // ===============================================
        // ü™ü SISTEMA DE MODALES
        // ===============================================
        
        /**
         * üé≠ Renderizador Principal de Modales
         * Controla qu√© modal mostrar seg√∫n el estado activo
         */
        function renderModal() {
            modalRoot.innerHTML = '';
            
            if (appState.activeModal === 'calendar') {
                modalRoot.innerHTML = renderCalendarModal();
            } else if (appState.activeModal === 'shortcuts') {
                modalRoot.innerHTML = renderShortcutsModal();
            }
            
            if (appState.activeModal) {
                addModalEventListeners();
            }
        }

        /**
         * üìÖ Modal de Calendario con Navegaci√≥n Anual
         */
        function renderCalendarModal() {
            const months = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const today = new Date();
            const currentSelectedDate = appState.currentDate;

            const monthsHTML = months.map((month, index) => {
                const monthKey = `${appState.calendarViewYear}-${String(index + 1).padStart(2, '0')}`;
                let monthClass = 'bg-black/20 backdrop-blur-sm';
                
                // Indicador visual para meses con datos
                if (appState.data.transactions[monthKey] && Object.values(appState.data.transactions[monthKey]).length > 0) {
                    const density = Math.min(Object.values(appState.data.transactions[monthKey]).length / 10, 1);
                    monthClass = `bg-black/30 opacity-${Math.floor(density * 10) * 10 + 30} backdrop-blur-md`;
                }
                
                // Destacar mes seleccionado actualmente
                if(appState.calendarViewYear === currentSelectedDate.getFullYear() && index === currentSelectedDate.getMonth()) {
                     monthClass += ` ring-2 ${appState.theme.accentRing}`;
                }
                
                // Destacar mes actual
                if(appState.calendarViewYear === today.getFullYear() && index === today.getMonth()) {
                    monthClass = `${appState.theme.accentBg} text-slate-900`;
                }
                
                return `<button data-month-index="${index}" class="month-button p-4 rounded-lg text-lg font-semibold transition-transform duration-200 hover:scale-110 ${monthClass}" title="${new Date(appState.calendarViewYear, index).toLocaleString('es-ES', {month:'long'})}">${month}</button>`;
            }).join('');
            
            return `
                <div class="modal-container fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm modal-enter p-4">
                    <div class="modal-content relative backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} w-full max-w-md mx-4">
                        <button class="modal-close-button absolute top-3 right-3 p-2 ${appState.theme.textSecondary} hover:${appState.theme.accent} rounded-full">
                            ${createIcon(ICONS.x, 'w-6 h-6')}
                        </button>                        <div class="flex items-center justify-between mb-6">
                            <button id="calendar-year-prev" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-2 rounded-full transition-all hover:scale-110" title="A√±o anterior (‚Üê)">
                                ${createIcon(ICONS.chevronLeft, "w-8 h-8")}
                            </button>
                            <div class="flex flex-col items-center gap-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-sm ${appState.theme.textSecondary}">A√±o:</span>
                                    <input type="number" id="calendar-year-input" value="${appState.calendarViewYear}" class="text-2xl font-bold ${appState.theme.textPrimary} bg-white/10 w-24 text-center focus:outline-none focus:bg-white/20 rounded-lg backdrop-blur-md border border-white/20 focus:border-white/40 transition-all px-2 py-1" aria-label="A√±o del calendario" min="1900" max="2100" title="Escribe un a√±o o usa las flechas">
                                </div>
                                <div class="text-xs ${appState.theme.textSecondary}">
                                    ${(() => {
                                        // Contar meses con datos en el a√±o actual
                                        let monthsWithData = 0;
                                        for (let i = 1; i <= 12; i++) {
                                            const monthKey = `${appState.calendarViewYear}-${String(i).padStart(2, '0')}`;
                                            if (appState.data.transactions[monthKey] && Object.values(appState.data.transactions[monthKey]).length > 0) {
                                                monthsWithData++;
                                            }
                                        }
                                        return monthsWithData > 0 ? `üìä ${monthsWithData} meses con datos` : 'üì≠ Sin datos registrados';
                                    })()}
                                </div>
                            </div>
                            <button id="calendar-year-next" class="${appState.theme.textSecondary} hover:${appState.theme.accent} p-2 rounded-full transition-all hover:scale-110" title="A√±o siguiente (‚Üí)">
                                ${createIcon(ICONS.chevronRight, "w-8 h-8")}
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-4 gap-4 text-center">${monthsHTML}</div>
                          <div class="flex items-center justify-between mt-6">
                            <button id="today-button" class="py-2 px-4 rounded-lg ${appState.theme.textSecondary} hover:${appState.theme.accent} font-bold text-sm transition-all hover:scale-105">
                                üìÖ Volver a Hoy
                            </button>
                            <div class="flex items-center gap-4 text-xs ${appState.theme.textSecondary}">
                               <div class="flex items-center gap-1">
                                   <span class="w-3 h-3 rounded-full ${appState.theme.accentBg}"></span>Actual
                               </div>
                               <div class="flex items-center gap-1">
                                   <span class="w-3 h-3 rounded-full bg-white/20"></span>Con Datos
                               </div>
                            </div>
                       </div>
                       
                       <!-- Indicadores de navegaci√≥n -->
                       <div class="mt-4 text-center text-xs ${appState.theme.textSecondary} border-t border-white/10 pt-3">
                           <p>üí° <strong>Navegaci√≥n:</strong> ‚Üê ‚Üí para cambiar a√±o ‚Ä¢ Click en mes para seleccionar</p>
                           <p class="mt-1">üìÖ Rango disponible: 1900 - 2100</p>
                       </div>
                    </div>
                </div>
            `;
        }
          /**
         * ‚å®Ô∏è Modal de Atajos de Teclado Actualizado
         */
        function renderShortcutsModal() {
            const shortcutsList = ShortcutSystem.getShortcutsList();
            
            const shortcutsHTML = shortcutsList.map(s => `
                <li class="flex justify-between items-center p-3 bg-black/20 rounded-lg backdrop-blur-md">
                    <span class="${appState.theme.textSecondary}">${s.description}</span>
                    <kbd class="px-3 py-1.5 text-sm font-semibold ${appState.theme.textPrimary} ${appState.theme.surface} border ${appState.theme.accentBorder} rounded-md">${s.key}</kbd>
                </li>
            `).join('');

            return `
                 <div class="modal-container fixed inset-0 z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm modal-enter p-4">
                    <div class="modal-content relative backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto">
                        <button class="modal-close-button absolute top-3 right-3 p-2 ${appState.theme.textSecondary} hover:${appState.theme.accent} rounded-full">
                            ${createIcon(ICONS.x, 'w-6 h-6')}
                        </button>
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">Atajos de Teclado</h2>
                        <ul class="space-y-3">${shortcutsHTML}</ul>
                        
                        <div class="mt-6 pt-4 border-t border-white/10">
                            <p class="text-xs ${appState.theme.textSecondary} text-center">
                                Los atajos no funcionan cuando est√°s escribiendo en campos de texto.
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }// ===============================================
        // üìä VISTAS PRINCIPALES DE LA APLICACI√ìN
        // ===============================================
        
        /**
         * üè† Vista Principal del Dashboard
         * Muestra resumen financiero con orbe central interactivo
         */
        function renderDashboard() {
            const { balance, netWorth } = calculateSummary();
            const firstGoal = appState.data.goals[0];
            let monthsToGoal = "Sin metas";
            
            if(firstGoal) {
                const allTransactions = Object.values(appState.data.transactions).flat();
                const globalIncome = allTransactions.filter(t=>t.type==='income').reduce((sum,t)=>sum+t.amount,0);
                const globalExpenses = allTransactions.filter(t=>t.type==='expense').reduce((sum,t)=>sum+t.amount,0);
                const firstDate = allTransactions.length > 0 ? new Date(allTransactions.reduce((min, t) => Math.min(min, new Date(t.date).getTime()), Date.now())) : new Date();
                const monthsDiff = Math.max(1, (new Date().getFullYear() - firstDate.getFullYear()) * 12 + (new Date().getMonth() - firstDate.getMonth()) + 1);
                const monthlySavings = (globalIncome-globalExpenses)/monthsDiff;
                monthsToGoal = monthlySavings > 0 ? `${Math.ceil((firstGoal.target - firstGoal.saved)/monthlySavings)} meses` : '‚àû';
            }            const infoHTML = appState.isPrivate ? `
                <div class="flex flex-col items-center justify-center ${appState.theme.textPrimary} p-10 rounded-full cursor-pointer" id="privacy-toggle">
                    ${createIcon(ICONS.eyeOff, "w-20 h-20")}
                    <p class="font-semibold mt-2">Informaci√≥n Oculta</p>
                </div>
            ` : `
                <div class="flex flex-col items-center justify-center text-slate-900 w-full h-full">
                    <div class="relative mb-4">
                        <div class="flex items-center gap-2">
                            <p class="text-sm font-medium opacity-70">Patrimonio Neto</p>                            <button id="privacy-toggle" class="text-slate-900/50 hover:text-slate-900 transition-colors" title="Ocultar informaci√≥n" aria-label="Alternar modo privacidad" aria-pressed="${appState.privacyMode}" role="button">
                                ${createIcon(ICONS.eye, "w-5 h-5")}
                            </button>
                        </div>
                        <p class="text-4xl font-bold">${formatCurrency(netWorth)}</p>
                    </div>
                    <div class="flex justify-around w-full text-sm">
                        <div>
                            <p class="font-medium opacity-70">Balance (Mes)</p>
                            <p class="font-semibold text-lg">${formatCurrency(balance)}</p>
                        </div>
                        <div class="border-l border-slate-900/30"></div>
                        <div>
                            <p class="font-medium opacity-70">Pr√≥xima Meta</p>
                            <p class="font-semibold text-lg">${monthsToGoal}</p>
                        </div>
                    </div>
                </div>
            `;            return `
                <div class="flex flex-col items-center justify-center h-[calc(100vh-250px)] relative">
                    <div class="w-80 h-80 sm:w-96 sm:h-96 rounded-full flex items-center justify-center text-center transition-all duration-500" 
                         style="background: radial-gradient(circle at 30% 30%, ${appState.theme.sunColor || appState.theme.accentColor}, ${appState.theme.accentColor}aa 60%, ${appState.theme.accentColor}44 100%); 
                                box-shadow: 0 0 40px 10px ${appState.theme.sunColor || appState.theme.accentColor}60, 
                                           0 0 80px 30px ${appState.theme.sunColor || appState.theme.accentColor}30, 
                                           0 0 120px 50px ${appState.theme.sunColor || appState.theme.accentColor}20,
                                           inset 0 0 30px ${appState.theme.sunColor || appState.theme.accentColor}20;">
                        ${infoHTML}
                    </div>
                    
                    <!-- Rayos de sol sutiles -->
                    <div class="absolute inset-0 pointer-events-none">
                        ${Array.from({length: 8}, (_, i) => `
                            <div class="absolute w-1 h-20 origin-bottom animate-pulse" 
                                 style="background: linear-gradient(to top, ${appState.theme.sunColor || appState.theme.accentColor}20, transparent);
                                        left: 50%; top: 50%; 
                                        transform: translate(-50%, -100%) rotate(${i * 45}deg);
                                        animation-delay: ${i * 0.2}s;
                                        opacity: 0.6;">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }        /**
         * üí∞ Vista de Gesti√≥n de Transacciones (Ingresos/Gastos)
         * @param {string} type - Tipo de transacci√≥n ('income' o 'expense')
         */
        function renderTransactionsView(type) {
            const title = type === 'income' ? 'Ingresos' : 'Gastos';
            const isExpense = type === 'expense';
            const currentMonthTransactions = appState.data.transactions[appState.currentMonthKey] || [];              // Renderizar lista de transacciones del mes actual
            const transactionsHTML = currentMonthTransactions
                .filter(t => t.type === type)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .map(t => `
                    <li class="border border-white/10 p-4 rounded-lg flex justify-between items-center transition-all hover:bg-white/5">
                        <div>
                            <p class="font-semibold ${appState.theme.textPrimary}">${t.description}</p>
                            <div class="flex items-center gap-2 mt-1">
                                ${ isExpense && t.category ? `<p class="text-xs font-medium px-2 py-0.5 rounded-full" style="background-color:${appState.theme.accentColor}30; color:${appState.theme.accentColor}">${t.category}</p>` : '' }
                                <p class="text-xs ${appState.theme.textSecondary}">${new Date(t.date).toLocaleDateString()}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <p class="font-bold text-lg ${type === 'income' ? appState.theme.positive : appState.theme.negative}">
                                ${formatCurrency(t.amount)}
                            </p>
                            <button class="delete-transaction-button text-red-500/70 hover:text-red-500 transition-colors" data-transaction-id="${t.id}" title="Eliminar transacci√≥n">
                                ${createIcon(ICONS.trash, 'w-5 h-5')}
                            </button>
                        </div>
                    </li>
                `).join('');

            // Opciones de categor√≠as para gastos
            const categoryOptionsHTML = CATEGORIES.map(cat => 
                `<option class="bg-slate-800" value="${cat}">${cat}</option>`
            ).join('');            // Campo de categor√≠a (solo para gastos)
            const categoryFieldHTML = isExpense ? `
                <div>
                    <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Categor√≠a</label>
                    <select name="category" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required>
                        ${categoryOptionsHTML}
                    </select>
                </div>
            ` : '';return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">üí∞ Gesti√≥n de ${title}</h2>
                        
                        <div class="flex flex-col sm:flex-row gap-2">
                            <button id="repeat-month-button" data-type="${type}" class="flex items-center gap-2 text-sm ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-3 py-2 rounded-lg hover:bg-white/5" title="Copia las transacciones del mes anterior">
                               ${createIcon(ICONS.history, 'w-4 h-4')} Repetir Mes Anterior
                            </button>
                            <button id="repeat-yearly-button" data-type="${type}" class="flex items-center gap-2 text-sm ${appState.theme.textSecondary} hover:${appState.theme.accent} transition-colors px-3 py-2 rounded-lg hover:bg-white/5" title="Copia estas transacciones hasta fin de a√±o">
                               ${createIcon(ICONS.repeat, 'w-4 h-4')} Repetir Anualmente
                            </button>
                        </div>
                    </div>
                    
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-${isExpense ? '4' : '2'} gap-4 mb-8 items-end">                        <div class="${isExpense ? 'md:col-span-2' : ''}">
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Descripci√≥n</label>
                            <input type="text" name="description" placeholder="${type === 'income' ? 'Ej: Sueldo de presidente' : 'Ej: Comida para la expedici√≥n'}" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="la descripci√≥n" />
                        </div>
                        
                        ${categoryFieldHTML}                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto</label>
                            <input type="text" inputmode="numeric" name="amount" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el monto" />
                        </div>

                        <div class="md:col-span-full">
                            <button type="submit" class="w-full mt-2 ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-opacity ${appState.theme.accentGlow} flex items-center justify-center gap-2">
                                ${createIcon(ICONS.plus)} Agregar ${title.slice(0,-1)}
                            </button>
                        </div>
                    </form>
                    
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">Historial del Mes</h3>
                        <ul class="space-y-3">                            ${transactionsHTML || `<p class="${appState.theme.textSecondary} text-center py-4">No hay transacciones a√∫n.</p>`}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        // ‚úÖ EXPOSICI√ìN GLOBAL INMEDIATA - Para m√≥dulos
        window.renderTransactionsView = renderTransactionsView;
        
        function renderInvestmentsView() {
            const { totalInvestments } = calculateSummary();
            const totalInitial = appState.data.investments.reduce((sum, i) => sum + i.initialAmount, 0);
            const portfolioPerformance = totalInitial === 0 ? 0 : ((totalInvestments - totalInitial) / totalInitial) * 100;
            const performanceClass = portfolioPerformance >= 0 ? appState.theme.positive : appState.theme.negative;            const investmentsHTML = appState.data.investments.map(inv => {
                const performance = inv.initialAmount === 0 ? 0 : ((inv.currentAmount - inv.initialAmount) / inv.initialAmount) * 100;
                return `
                    <div class="border border-white/10 p-4 rounded-lg flex flex-col justify-between">
                        <div class="flex justify-between items-start">                           <div>
                                <p class="font-bold text-lg ${appState.theme.textPrimary}">${inv.name}</p>
                                <p class="text-sm ${appState.theme.textSecondary}">${inv.type}</p>
                           </div>
                           <div class="flex space-x-2">
                               <button data-action="edit-investment" data-investment-id="${inv.id}" class="p-2 bg-blue-500/20 hover:bg-blue-500 rounded-lg transition-all duration-200 text-blue-300 hover:text-white" title="Editar inversi√≥n">
                                   ${createIcon(ICONS.edit, 'w-4 h-4')}
                               </button>
                               <button data-action="delete-investment" data-investment-id="${inv.id}" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition-all duration-200 text-red-300 hover:text-white" title="Eliminar inversi√≥n">
                                   ${createIcon(ICONS.trash, 'w-4 h-4')}
                               </button>
                           </div>
                        </div>
                        <div class="mt-4">
                            <label class="text-xs ${appState.theme.textSecondary}">Valor Actual</label>
                            <input type="text" inputmode="numeric" data-investment-id="${inv.id}" value="${formatNumberWithDots(inv.currentAmount)}" placeholder="0" class="numeric-input investment-update-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" />
                            <p class="mt-2 text-right text-sm font-semibold ${performance >= 0 ? appState.theme.positive : appState.theme.negative}">${performance.toFixed(2)}%</p>
                        </div>
                    </div>
                `;
            }).join('');            return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6 mb-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-4">Resumen de Cartera</h2>
                    <div class="flex justify-between items-center">
                        <div><p class="text-sm ${appState.theme.textSecondary}">Valor Total</p><p class="text-3xl font-bold ${appState.theme.textPrimary}">${formatCurrency(totalInvestments)}</p></div>
                        <div class="text-right"><p class="text-sm ${appState.theme.textSecondary}">Rendimiento</p><div class="text-3xl font-bold flex items-center gap-2 ${performanceClass}"><span>${portfolioPerformance > 0 ? '+':''}${portfolioPerformance.toFixed(2)}%</span></div></div>
                    </div>                </div>
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">Inversiones</h2>
                        <button data-action="add-investment" class="px-4 py-2 ${appState.theme.accentBg} text-white rounded-lg hover:opacity-90 transition-all duration-200 ${appState.theme.accentGlow} font-medium">
                            + Nueva Inversi√≥n
                        </button>
                    </div>
                    <form id="investment-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 items-end">
                        <div class="md:col-span-2"><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Activo</label><input name="name" type="text" placeholder="Ej: Acciones de Adamantium..." class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el nombre del activo" /></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Tipo</label><select name="type" class="w-full border border-white/20 text-white rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent"><option class="bg-slate-800">Acciones</option><option class="bg-slate-800">Cripto</option><option class="bg-slate-800">Fondos</option><option class="bg-slate-800">Otro</option></select></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Inversi√≥n Inicial</label><input name="initialAmount" type="text" inputmode="numeric" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="la inversi√≥n inicial" /></div>
                        <div class="md:col-span-4"><button type="submit" class="w-full mt-2 ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-opacity ${appState.theme.accentGlow} flex items-center justify-center gap-2">${createIcon(ICONS.plus)}A√±adir Inversi√≥n</button></div>
                    </form>
                    <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mt-8 mb-4">Mis Activos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${investmentsHTML || `<p class="${appState.theme.textSecondary} text-center py-4 col-span-full">Tu cartera de inversiones est√° vac√≠a.</p>`}</div>
                </div>
            `;
        }
          function renderGoalsView() {
             const goalsHTML = appState.data.goals.map(goal => `
                <div class="border border-white/10 p-4 rounded-lg">                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold ${appState.theme.textPrimary}">${goal.name}</p>
                            <p class="text-sm ${appState.theme.textSecondary} mt-1">${formatCurrency(goal.saved)} / ${formatCurrency(goal.target)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button data-action="edit-goal" data-goal-id="${goal.id}" class="p-2 bg-blue-500/20 hover:bg-blue-500 rounded-lg transition-all duration-200 text-blue-300 hover:text-white" title="Editar meta">
                                ${createIcon(ICONS.edit, 'w-4 h-4')}
                            </button>
                            <button data-action="delete-goal" data-goal-id="${goal.id}" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition-all duration-200 text-red-300 hover:text-white" title="Eliminar meta">
                                ${createIcon(ICONS.trash, 'w-4 h-4')}
                            </button>
                        </div>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                        <div class="${appState.theme.accentBg} h-2.5 rounded-full" style="width: ${((goal.saved / goal.target) * 100)}%"></div>
                    </div>
                </div>
            `).join('');            return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">Metas de Ahorro</h2>
                        <button data-action="add-goal" class="px-4 py-2 ${appState.theme.accentBg} text-white rounded-lg hover:opacity-90 transition-all duration-200 ${appState.theme.accentGlow} font-medium">
                            + Nueva Meta
                        </button>
                    </div>
                    <form id="goal-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Nombre de la Meta</label><input type="text" name="name" placeholder="Ej: Viaje a Marte" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el nombre de la meta" /></div>
                        <div><label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto Objetivo</label><input type="text" inputmode="numeric" name="target" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el monto objetivo" /></div>
                        <div class="self-end"><button type="submit" class="w-full ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-colors ${appState.theme.accentGlow} flex items-center justify-center gap-2">${createIcon(ICONS.plus)}Crear Meta</button></div>
                    </form>
                    <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mt-8 mb-4">Mis Metas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${goalsHTML || `<p class="${appState.theme.textSecondary} col-span-full text-center py-4">A√∫n no has definido metas.</p>`}</div>
                </div>
            `;
        }        function renderDebtsView() {
            const debtsHTML = appState.data.debts.map(debt => `
                <li class="border border-white/10 rounded-lg flex justify-between items-center p-4">
                    <div><p class="font-semibold ${appState.theme.textPrimary}">${debt.description}</p></div>                    <div class="flex items-center gap-4">
                        <p class="font-bold text-lg ${appState.theme.negative}">${formatCurrency(debt.amount)}</p>
                        <div class="flex space-x-2">
                            <button data-action="edit-debt" data-debt-id="${debt.id}" class="p-2 bg-blue-500/20 hover:bg-blue-500 rounded-lg transition-all duration-200 text-blue-300 hover:text-white" title="Editar deuda">
                                ${createIcon(ICONS.edit, 'w-4 h-4')}
                            </button>
                            <button data-action="delete-debt" data-debt-id="${debt.id}" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-lg transition-all duration-200 text-red-300 hover:text-white" title="Eliminar deuda">
                                ${createIcon(ICONS.trash, 'w-4 h-4')}
                            </button>
                        </div>
                    </div>
                </li>
            `).join('');            return `
                <div class="border border-white/10 rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold ${appState.theme.textPrimary}">üí≥ Gesti√≥n de Deudas</h2>
                        <button data-action="add-debt" class="px-4 py-2 ${appState.theme.accentBg} text-white rounded-lg hover:opacity-90 transition-all duration-200 ${appState.theme.accentGlow} font-medium">
                            + Nueva Deuda
                        </button>
                    </div>
                    <form id="debt-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 items-end">                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Descripci√≥n</label>
                            <input type="text" name="description" placeholder="Ej: Pr√©stamo de Mercado Plasma" class="w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="la descripci√≥n de la deuda" />
                        </div>                        <div>
                            <label class="block text-sm font-medium ${appState.theme.textSecondary} mb-1">Monto Total</label>
                            <input type="text" inputmode="numeric" name="amount" placeholder="0" class="numeric-input w-full border border-white/20 ${appState.theme.textPrimary} rounded-md p-2 focus:ring-2 ${appState.theme.accentRing} focus:outline-none bg-transparent" required data-field-name="el monto total" />
                        </div>
                        <div class="self-end">
                            <button type="submit" class="w-full ${appState.theme.accentBg} text-slate-900 font-bold py-3 px-4 rounded-md hover:opacity-90 transition-all ${appState.theme.accentGlow} flex items-center justify-center gap-2 transform hover:scale-105">
                                ${createIcon(ICONS.plus)} Agregar Deuda
                            </button>
                        </div>
                    </form>
                    <div class="mt-6">
                        <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">Deudas Actuales</h3>
                        <ul class="space-y-3">
                            ${debtsHTML || `<div class="text-center py-8"><p class="${appState.theme.textSecondary}">üéâ ¬°No tienes deudas registradas!</p></div>`}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function renderSettingsView() {
            const themesHTML = Object.entries(THEMES).map(([key, theme]) => `
                <button data-theme-key="${key}" class="theme-selector p-4 rounded-lg border-2 transition-all ${appState.themeKey === key ? `${theme.accentBorder} scale-105 shadow-lg` : 'border-transparent opacity-70 hover:opacity-100'}">
                    <div class="w-full h-16 rounded-md mb-2" style="background: ${theme.gradient}"></div>
                    <p class="${appState.theme.textPrimary}">${theme.name}</p>
                </button>
            `).join('');            return `
                <div class="${appState.theme.surface} rounded-2xl shadow-lg p-6">
                    <h2 class="text-2xl font-bold ${appState.theme.textPrimary} mb-6">‚öôÔ∏è Ajustes y Personalizaci√≥n</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">üé® Tema Visual</h3>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${themesHTML}</div>
                        </div>                        <div>
                            <h3 class="text-xl font-semibold ${appState.theme.textPrimary} mb-4">üõ†Ô∏è Herramientas</h3>
                             <button id="open-shortcuts-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md mb-3">
                                ${createIcon(ICONS.zap, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">‚ö° Atajos de Teclado</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Navega m√°s r√°pido por la aplicaci√≥n.</p>
                                </div>
                            </button>
                            
                            <button id="logout-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md mb-3">
                                ${createIcon(ICONS.logOut, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">üö™ Cerrar Sesi√≥n</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Salir de tu cuenta de Nebula Financial.</p>
                                </div>
                            </button>
                            
                            <button id="export-excel-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-black/10 p-4 rounded-lg transition-colors backdrop-blur-md mb-3">
                                ${createIcon(ICONS.download, `w-6 h-6 ${appState.theme.accent}`)}
                                <div>
                                    <p class="font-bold ${appState.theme.textPrimary}">üìä Exportar a Excel</p>
                                    <p class="text-sm ${appState.theme.textSecondary}">Descarga todos tus datos financieros.</p>
                                </div>
                            </button>
                            
                            <button id="clear-all-data-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-red-500/20 p-4 rounded-lg transition-colors backdrop-blur-md border border-red-500/30 mb-3">
                                ${createIcon(ICONS.trash, `w-6 h-6 text-red-400`)}
                                <div>
                                    <p class="font-bold text-red-400">üóëÔ∏è Borrar Todos los Datos</p>
                                    <p class="text-sm text-red-300">‚ö†Ô∏è Esta acci√≥n no se puede deshacer.</p>
                                </div>
                            </button>
                            
                            <button id="delete-account-button" class="w-full text-left flex items-center gap-3 ${appState.theme.surface} hover:bg-red-600/20 p-4 rounded-lg transition-colors backdrop-blur-md border border-red-600/50">
                                ${createIcon(ICONS.userX, `w-6 h-6 text-red-500`)}
                                <div>
                                    <p class="font-bold text-red-500">‚ö†Ô∏è Eliminar Cuenta Completa</p>
                                    <p class="text-sm text-red-400">Elimina tu cuenta de Firebase y todos los datos.</p>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderComingSoon(section = 'Esta secci√≥n') {
            const label = { achievements: 'Logros' }[section] || 'Esta secci√≥n';
            return `
                <div class="backdrop-blur-md rounded-2xl shadow-lg p-6 ${appState.theme.surface} text-center h-[calc(100vh-200px)] flex flex-col justify-center items-center">
                    <div class="w-24 h-24 text-cyan-400 mb-4 animate-pulse">${createIcon(ICONS.settings)}</div>
                    <h2 class="text-3xl font-bold ${appState.theme.textPrimary}">${label} en Construcci√≥n</h2>
                    <p class="mt-4 ${appState.theme.textSecondary}">¬°Estamos explorando esta galaxia! Vuelve pronto.</p>
                </div>
            `;
        }        function renderDock() {
            const navItems = [
                { id: 'dashboard', label: 'Resumen', icon: ICONS.dashboard, key: 'D' },
                { id: 'income', label: 'Ingresos', icon: ICONS.income, key: 'I' },
                { id: 'expenses', label: 'Gastos', icon: ICONS.expenses, key: 'G' },
                { id: 'investments', label: 'Inversiones', icon: ICONS.investments, key: 'N' },
                { id: 'debts', label: 'Deudas', icon: ICONS.debts, key: 'P' },
                { id: 'goals', label: 'Metas', icon: ICONS.goals, key: 'M' },
                { id: 'settings', label: 'Ajustes', icon: ICONS.settings, key: 'A' }
            ];

            const navButtonsHTML = navItems.map(item => `
                <button data-view="${item.id}" aria-label="${item.label}" 
                        class="nav-button p-3 w-16 h-16 flex items-center justify-center
                               ${appState.activeView === item.id ? `text-white active` : `${appState.theme.textSecondary} hover:text-white`}" 
                        title="${item.label} (${item.key})">
                    ${createIcon(item.icon, "w-6 h-6")}
                </button>
            `).join('');            return `
                <nav class="p-4 backdrop-blur-lg bg-black/20">
                    <div class="dock-container w-full max-w-md mx-auto flex justify-between items-center">
                        ${navButtonsHTML}
                    </div>
                </nav>`;
        }        function renderParallaxBackground() {
            if (parallaxBg.children.length > 0 && parallaxBg.dataset.theme === appState.themeKey) return '';
            parallaxBg.dataset.theme = appState.themeKey;

            // üé® EFECTOS DE PART√çCULAS OPTIMIZADOS
            // Todos los temas ahora usan el mismo patr√≥n eficiente de "Aureo Amancer"
            // para mejorar el rendimiento y reducir los tiempos de carga
            switch(appState.theme.particleType) {
                case 'goldenDust': {
                    // Polvo dorado flotante para √Åureo Amanecer - EFECTO DUAL
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-amber-200 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }

                case 'crimsonMist': {
                    // Niebla carmes√≠ para Cris√≥n Vespertino - EFECTO DUAL MEJORADO
                    const mist = Array.from({ length: 25 }).map(() => {
                        const duration = Math.random() * 30 + 15;
                        const size = Math.random() * 300 + 150;
                        const startX = Math.random() * 100;
                        const startY = Math.random() * 100;
                        return `<div class="particle absolute rounded-full" style="left: ${startX}%; top: ${startY}%; width: ${size}px; height: ${size}px; background: radial-gradient(circle, ${appState.theme.sunColor}08, transparent 70%); animation: drift ${duration}s linear infinite alternate; transform: translateZ(0);"></div>`;
                    }).join('');
                    
                    const sparkles = Array.from({ length: 100 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 2 + 1;
                        const duration = Math.random() * 6 + 3;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*3}px ${appState.theme.sunColor}80; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.5 + 0.2};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 180 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const pulse = Math.random() * 4 + 3;
                        return `<div class="absolute w-px h-px bg-rose-300 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: pulse ${pulse}s ease-in-out infinite;"></div>`;
                    }).join('');

                    return mist + sparkles + backgroundStars;
                }                case 'aquaFlow': {
                    // Flujo acu√°tico para Aguamarina Celeste - EFECTO OPTIMIZADO (mismo patr√≥n que Aureo)
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-cyan-200 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }                case 'royalAura': {
                    // Aura real para Violeta Real - EFECTO OPTIMIZADO (mismo patr√≥n que Aureo)
                    const particles = Array.from({ length: 120 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const size = Math.random() * 3 + 1;
                        const duration = Math.random() * 8 + 4;
                        return `<div class="particle absolute rounded-full" style="left: ${leftPos}%; top: ${topPos}%; width: ${size}px; height: ${size}px; background: ${appState.theme.sunColor}; box-shadow: 0 0 ${size*2}px ${appState.theme.sunColor}60; animation: float ${duration}s ease-in-out infinite alternate; opacity: ${Math.random() * 0.4 + 0.1};"></div>`;
                    }).join('');

                    const backgroundStars = Array.from({ length: 150 }).map(() => {
                        const leftPos = Math.random() * 100;
                        const topPos = Math.random() * 100;
                        const twinkle = Math.random() * 3 + 2;
                        return `<div class="absolute w-px h-px bg-purple-100 rounded-full" style="left:${leftPos}%; top:${topPos}%; animation: twinkle ${twinkle}s ease-in-out infinite alternate;"></div>`;
                    }).join('');

                    return particles + backgroundStars;
                }

                default: return '';
            }
        }

        function updateDockGlider() {
            // El nuevo efecto es puramente CSS, no requiere JavaScript
        }        /**
         * üéÆ Gestor de Event Listeners Mejorado
         * Maneja todos los eventos de la interfaz de usuario
         * ‚úÖ Con protecci√≥n contra registros duplicados
         */
        let listenersRegistered = false;
        
        function addEventListeners() {
            // ‚ö†Ô∏è PROTECCI√ìN CONTRA REGISTROS DUPLICADOS
            if (listenersRegistered) {
                console.log('‚ö†Ô∏è Event listeners ya registrados, evitando duplicaci√≥n');
                return;
            }
            
            // Eventos de autenticaci√≥n tradicionales (Google, Guest)
            document.querySelectorAll('.login-button').forEach(btn => 
                btn.addEventListener('click', e => appState.login(e.currentTarget.dataset.loginMethod))
            );
            
            // üìß NUEVOS EVENT LISTENERS PARA AUTENTICACI√ìN CON EMAIL
            // ====================================================
            // SOLO agregar si estamos en la p√°gina de login (usuario no autenticado)
            setupAuthListeners();
            
            // Marcar como registrados
            listenersRegistered = true;
            console.log('‚úÖ Event listeners registrados una sola vez');
            
            // Configurar el resto de listeners
            setupAdditionalListeners();
        }

        let authListenersRegistered = false;
        
        function setupAuthListeners() {
            // Verificar si estamos en el login (no hay elementos de auth si el usuario est√° logueado)
            if (appState.user) {
                console.log('‚ö†Ô∏è Usuario logueado, omitiendo setup de auth listeners');
                return;
            }
            
            // Verificar que los elementos principales de login existen
            const googleBtn = document.getElementById('google-login-btn');
            const guestBtn = document.getElementById('guest-login-btn');
            const emailBtn = document.getElementById('email-register-btn');
            
            if (!googleBtn || !guestBtn || !emailBtn) {
                console.log('‚ö†Ô∏è Elementos de login no encontrados, reintentando en 200ms...', {
                    google: !!googleBtn,
                    guest: !!guestBtn, 
                    email: !!emailBtn
                });
                setTimeout(() => setupAuthListeners(), 200);
                return;
            }
            
            console.log('üéØ Elementos de login encontrados, configurando listeners...');
            
            // ‚ö†Ô∏è PROTECCI√ìN ADICIONAL: Verificar si ya tienen listeners
            if (googleBtn && googleBtn.hasAttribute('data-listener-attached')) {
                console.log('‚ö†Ô∏è Botones de login ya tienen listeners, evitando duplicaci√≥n');
                authListenersRegistered = true;
                return;
            }
            
            // Google Login
            if (googleBtn && !googleBtn.hasAttribute('data-listener-attached')) {
                googleBtn.addEventListener('click', async () => {
                    try {
                        console.log('üîê Iniciando login con Google...');
                        if (window.NotificationSystem) {
                            window.NotificationSystem.info('Login', 'Iniciando sesi√≥n con Google...');
                        }
                        await appState.login('google');
                    } catch (error) {
                        console.error('Error en Google login:', error);
                        if (window.NotificationSystem) {
                            window.NotificationSystem.error('Error', 'Error al iniciar sesi√≥n con Google');
                        }
                    }
                });
                googleBtn.setAttribute('data-listener-attached', 'true');
            }
            
            // Guest Login
            if (guestBtn && !guestBtn.hasAttribute('data-listener-attached')) {
                guestBtn.addEventListener('click', async () => {
                    try {
                        console.log('üîê Iniciando login como invitado...');
                        if (window.NotificationSystem) {
                            window.NotificationSystem.info('Login', 'Entrando como invitado...');
                        }
                        await appState.login('guest');
                    } catch (error) {
                        console.error('Error en guest login:', error);
                        if (window.NotificationSystem) {
                            window.NotificationSystem.error('Error', 'Error al entrar como invitado');
                        }
                    }
                });
                guestBtn.setAttribute('data-listener-attached', 'true');
            }
            
            // Bot√≥n para abrir modal de registro con email
            if (emailBtn && !emailBtn.hasAttribute('data-listener-attached')) {
                emailBtn.addEventListener('click', () => {
                    const emailModal = document.getElementById('email-register-modal');
                    if (emailModal) {
                        emailModal.classList.remove('hidden');
                        emailModal.classList.add('flex');
                    }
                });
                emailBtn.setAttribute('data-listener-attached', 'true');
            }
            
            // Gesti√≥n de modales
            const emailRegisterModal = document.getElementById('email-register-modal');
            const emailLoginModal = document.getElementById('email-login-modal');
            
            if (emailRegisterModal && emailLoginModal && !emailRegisterModal.hasAttribute('data-listeners-attached')) {
                // Cerrar modales
                const closeRegisterModal = document.getElementById('close-register-modal');
                const closeLoginModal = document.getElementById('close-login-modal');
                
                if (closeRegisterModal) {
                    closeRegisterModal.addEventListener('click', () => {
                        emailRegisterModal.classList.add('hidden');
                        emailRegisterModal.classList.remove('flex');
                    });
                }
                
                if (closeLoginModal) {
                    closeLoginModal.addEventListener('click', () => {
                        emailLoginModal.classList.add('hidden');
                        emailLoginModal.classList.remove('flex');
                    });
                }
                
                // Cambiar entre modales
                const switchToLogin = document.getElementById('switch-to-login');
                const switchToRegister = document.getElementById('switch-to-register');
                
                if (switchToLogin) {
                    switchToLogin.addEventListener('click', () => {
                        emailRegisterModal.classList.add('hidden');
                        emailRegisterModal.classList.remove('flex');
                        emailLoginModal.classList.remove('hidden');
                        emailLoginModal.classList.add('flex');
                    });
                }
                
                if (switchToRegister) {
                    switchToRegister.addEventListener('click', () => {
                        emailLoginModal.classList.add('hidden');
                        emailLoginModal.classList.remove('flex');
                        emailRegisterModal.classList.remove('hidden');
                        emailRegisterModal.classList.add('flex');
                    });
                }
                
                // Cerrar al hacer click en backdrop
                emailRegisterModal.addEventListener('click', (e) => {
                    if (e.target === emailRegisterModal) {
                        emailRegisterModal.classList.add('hidden');
                        emailRegisterModal.classList.remove('flex');
                    }
                });
                
                emailLoginModal.addEventListener('click', (e) => {
                    if (e.target === emailLoginModal) {
                        emailLoginModal.classList.add('hidden');
                        emailLoginModal.classList.remove('flex');
                    }
                });
            }
            
            // Formularios
            const registerForm = document.getElementById('email-register-form');
            const loginForm = document.getElementById('email-login-form');
            
            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('register-name')?.value;
                    const email = document.getElementById('register-email')?.value;
                    const password = document.getElementById('register-password')?.value;
                    
                    if (password && password.length < 6) {
                        showNotification('La contrase√±a debe tener al menos 6 caracteres', 'error');
                        return;
                    }
                    
                    if (email && password && name) {
                        try {
                            showNotification('Creando cuenta...', 'info');
                            await NebulaAuth.signUpWithEmail(email, password, name);
                            emailRegisterModal.classList.add('hidden');
                            emailRegisterModal.classList.remove('flex');
                        } catch (error) {
                            console.error('Error en registro:', error);
                            showNotification('Error al crear la cuenta', 'error');
                        }
                    }
                });
            }
            
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('login-email')?.value;
                    const password = document.getElementById('login-password')?.value;
                    
                    if (email && password) {
                        try {
                            showNotification('Iniciando sesi√≥n...', 'info');
                            await NebulaAuth.signInWithEmail(email, password);
                            emailLoginModal.classList.add('hidden');
                            emailLoginModal.classList.remove('flex');
                        } catch (error) {
                            console.error('Error en login:', error);
                            showNotification('Error al iniciar sesi√≥n', 'error');
                        }
                    }
                });
            }
            
            // Bot√≥n de olvid√© contrase√±a
            const forgotPassword = document.getElementById('forgot-password');
            if (forgotPassword) {
                forgotPassword.addEventListener('click', () => {
                    showNotification('Funci√≥n de recuperaci√≥n pr√≥ximamente', 'info');
                });
            }
            
            // Efectos de hover para botones
            const loginButtons = document.querySelectorAll('.login-button');
            loginButtons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    button.style.transform = 'translateY(-2px)';
                });
                
                button.addEventListener('mouseleave', () => {
                    button.style.transform = 'translateY(0)';
                });
            });
            
            // Marcar formularios como procesados
            const authForms = document.querySelectorAll('#email-register-form, #email-login-form');
            authForms.forEach(form => {
                if (form) form.setAttribute('data-listeners-attached', 'true');
            });
            
            // Marcar modales como procesados
            if (emailRegisterModal) emailRegisterModal.setAttribute('data-listeners-attached', 'true');
            if (emailLoginModal) emailLoginModal.setAttribute('data-listeners-attached', 'true');
            
            // Marcar auth listeners como registrados
            authListenersRegistered = true;
            console.log('‚úÖ Listeners de auth ultra simple configurados (una sola vez)');
        }

        function setupAdditionalListeners() {
            // ====================================================
            // RESTO DE EVENT LISTENERS EXISTENTES
            // ====================================================
            
            // Navegaci√≥n del dock
            document.querySelectorAll('.nav-button').forEach(btn => 
                btn.addEventListener('click', (e) => appState.setView(e.currentTarget.dataset.view))
            );
            
            // Toggle de privacidad
            const privacyToggle = document.getElementById('privacy-toggle');
            if(privacyToggle) privacyToggle.addEventListener('click', () => appState.togglePrivacy());
            
            // Formato num√©rico autom√°tico
            document.querySelectorAll('.numeric-input').forEach(input => {
                input.addEventListener('input', e => {
                    const cursorPosition = e.target.selectionStart;
                    const originalLength = e.target.value.length;
                    const rawValue = e.target.value.replace(/\D/g, '');
                    e.target.value = formatNumberWithDots(rawValue);
                    const newLength = e.target.value.length;
                    e.target.setSelectionRange(cursorPosition + (newLength - originalLength), cursorPosition + (newLength - originalLength));
                });
            });            // üîí Formularios con protecci√≥n XSS y validaci√≥n visual
            const transactionForm = document.getElementById('transaction-form');
            if (transactionForm) {
                transactionForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(transactionForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    const transactionData = {
                        type: appState.activeView === 'income' ? 'income' : 'expense',
                        description: sanitizeHTML(e.target.elements.description.value),
                        category: e.target.elements.category ? sanitizeHTML(e.target.elements.category.value) : undefined,
                        amount: parseFormattedNumber(e.target.elements.amount.value)
                    };
                    
                    appState.addTransaction(transactionData);
                    e.target.reset();
                    
                    NotificationSystem.success('√âxito', 
                        `${transactionData.type === 'income' ? 'Ingreso' : 'Gasto'} agregado correctamente`);
                });
            }

            const investmentForm = document.getElementById('investment-form');
            if(investmentForm) {
                investmentForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(investmentForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    const initial = parseFormattedNumber(e.target.elements.initialAmount.value);
                    appState.addInvestment({ 
                        name: sanitizeHTML(e.target.elements.name.value), 
                        type: sanitizeHTML(e.target.elements.type.value), 
                        initialAmount: initial, 
                        currentAmount: initial 
                    });
                    e.target.reset();
                    NotificationSystem.success('√âxito', 'Inversi√≥n agregada correctamente');
                });
            }
            
            const goalForm = document.getElementById('goal-form');
            if (goalForm) {
                goalForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(goalForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    appState.addGoal({ 
                        name: sanitizeHTML(e.target.elements.name.value), 
                        target: parseFormattedNumber(e.target.elements.target.value) 
                    });
                    e.target.reset();
                    NotificationSystem.success('√âxito', 'Meta creada correctamente');
                });
            }
            
            const debtForm = document.getElementById('debt-form');
            if(debtForm) {
                debtForm.addEventListener('submit', e => {
                    e.preventDefault();
                    
                    // CloudSonnet4: validaci√≥n visual campo obligatorio
                    if (!validateForm(debtForm)) {
                        return; // No proceder si hay errores
                    }
                    
                    appState.addDebt({ 
                        description: sanitizeHTML(e.target.elements.description.value), 
                        amount: parseFormattedNumber(e.target.elements.amount.value)
                    });
                    e.target.reset();
                    NotificationSystem.success('√âxito', 'Deuda registrada correctamente');
                });
            }
            
            // Botones de repetici√≥n
            const repeatButton = document.getElementById('repeat-month-button');
            if (repeatButton) {
                repeatButton.addEventListener('click', e => {
                    appState.repeatPreviousMonth(e.currentTarget.dataset.type);
                });
            }
            
            const repeatYearlyButton = document.getElementById('repeat-yearly-button');
            if (repeatYearlyButton) {
                repeatYearlyButton.addEventListener('click', e => {
                    appState.repeatYearlyFromCurrent(e.currentTarget.dataset.type);
                });
            }            // Event delegation para botones con data-action (para compatibilidad con m√≥dulos)
            document.addEventListener('click', (e) => {
                const action = e.target.closest('[data-action]')?.dataset.action;
                const target = e.target.closest('[data-action]');
                
                if (!action || !target) return;
                
                switch(action) {
                    case 'edit-investment':
                        const investmentId = parseInt(target.dataset.investmentId);
                        if (window.NebulaInvestmentsModule) {
                            window.NebulaInvestmentsModule.editInvestment(investmentId);
                        }
                        break;
                    case 'delete-investment':
                        const delInvestmentId = parseInt(target.dataset.investmentId);
                        if (window.NebulaInvestmentsModule) {
                            window.NebulaInvestmentsModule.deleteInvestment(delInvestmentId);
                        } else {
                            // Fallback al m√©todo integrado
                            appState.deleteInvestment(delInvestmentId);
                            NotificationSystem.info('Eliminado', 'Inversi√≥n eliminada');
                            renderApp();
                        }
                        break;
                    case 'add-investment':
                        if (window.NebulaInvestmentsModule) {
                            window.NebulaInvestmentsModule.showAddInvestmentForm();
                        }
                        break;
                    case 'edit-goal':
                        const goalId = parseInt(target.dataset.goalId);
                        if (window.NebulaGoalsModule) {
                            window.NebulaGoalsModule.editGoal(goalId);
                        }
                        break;
                    case 'delete-goal':
                        const delGoalId = parseInt(target.dataset.goalId);
                        if (window.NebulaGoalsModule) {
                            window.NebulaGoalsModule.deleteGoal(delGoalId);
                        } else {
                            appState.deleteGoal(delGoalId);
                            NotificationSystem.info('Eliminado', 'Meta eliminada');
                            renderApp();
                        }
                        break;
                    case 'add-goal':
                        if (window.NebulaGoalsModule) {
                            window.NebulaGoalsModule.showAddGoalForm();
                        }
                        break;
                    case 'edit-debt':
                        const debtId = parseInt(target.dataset.debtId);
                        if (window.NebulaDebtsModule) {
                            window.NebulaDebtsModule.editDebt(debtId);
                        }
                        break;
                    case 'delete-debt':
                        const delDebtId = parseInt(target.dataset.debtId);
                        if (window.NebulaDebtsModule) {
                            window.NebulaDebtsModule.deleteDebt(delDebtId);
                        } else {
                            appState.deleteDebt(delDebtId);
                            NotificationSystem.info('Eliminado', 'Deuda eliminada');
                            renderApp();
                        }
                        break;
                    case 'add-debt':
                        if (window.NebulaDebtsModule) {
                            window.NebulaDebtsModule.showAddDebtForm();
                        }
                        break;
                }
            });

            // Eliminaci√≥n de elementos (legacy - mantenido para compatibilidad)
            document.querySelectorAll('.delete-transaction-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteTransaction(parseInt(e.currentTarget.dataset.transactionId));
                    NotificationSystem.info('Eliminado', 'Transacci√≥n eliminada');
                })
            );
            
            document.querySelectorAll('.investment-update-input').forEach(input => 
                input.addEventListener('input', e => 
                    appState.updateInvestment(parseInt(e.target.dataset.investmentId), parseFormattedNumber(e.target.value))
                )
            );
            
            document.querySelectorAll('.delete-investment-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteInvestment(parseInt(e.currentTarget.dataset.investmentId));
                    NotificationSystem.info('Eliminado', 'Inversi√≥n eliminada');
                })
            );
            
            document.querySelectorAll('.delete-goal-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteGoal(parseInt(e.currentTarget.dataset.goalId));
                    NotificationSystem.info('Eliminado', 'Meta eliminada');
                })
            );
            
            document.querySelectorAll('.delete-debt-button').forEach(btn => 
                btn.addEventListener('click', e => {
                    appState.deleteDebt(parseInt(e.currentTarget.dataset.debtId));
                    NotificationSystem.info('Eliminado', 'Deuda eliminada');
                })
            );
            
            // Selecci√≥n de temas
            document.querySelectorAll('.theme-selector').forEach(btn => 
                btn.addEventListener('click', (e) => {
                    appState.setTheme(e.currentTarget.dataset.themeKey);
                    NotificationSystem.success('Tema cambiado', 
                        `Aplicado: ${THEMES[e.currentTarget.dataset.themeKey].name}`);
                })
            );
            
            // Navegaci√≥n de meses
            const monthPrev = document.getElementById('month-prev');
            if (monthPrev) monthPrev.addEventListener('click', () => appState.changeMonth(-1));
            
            const monthNext = document.getElementById('month-next');
            if (monthNext) monthNext.addEventListener('click', () => appState.changeMonth(1));
            
            // Calendario desplegable
            const calendarDropdownButton = document.getElementById('calendar-dropdown-button');
            const calendarDropdown = document.getElementById('calendar-dropdown');
            
            if (calendarDropdownButton && calendarDropdown) {
                calendarDropdownButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    calendarDropdown.classList.toggle('hidden');
                });
                
                // Cerrar dropdown al hacer click fuera
                document.addEventListener('click', (e) => {
                    if (!calendarDropdown.contains(e.target) && !calendarDropdownButton.contains(e.target)) {
                        calendarDropdown.classList.add('hidden');
                    }
                });
                
                // Selecci√≥n de mes
                document.querySelectorAll('.month-dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const monthIndex = parseInt(e.target.dataset.month);
                        appState.currentDate = new Date(appState.currentDate.getFullYear(), monthIndex, 1);
                        calendarDropdown.classList.add('hidden');
                        renderApp();
                    });
                });
                
                // Bot√≥n "ir a hoy"
                const todayShortcut = document.getElementById('today-shortcut');
                if (todayShortcut) {
                    todayShortcut.addEventListener('click', () => {
                        appState.currentDate = new Date();
                        calendarDropdown.classList.add('hidden');
                        renderApp();
                        NotificationSystem.info('Navegaci√≥n', 'Has regresado al mes actual');
                    });
                }
            }
              // Modal calendar (mantenido para compatibilidad)
            const openCalendarButton = document.getElementById('open-calendar-button');
            if(openCalendarButton) openCalendarButton.addEventListener('click', () => appState.openModal('calendar'));
              const openShortcutsButton = document.getElementById('open-shortcuts-button');
            if (openShortcutsButton) openShortcutsButton.addEventListener('click', () => appState.openModal('shortcuts'));
            
            // üîß NUEVOS BOTONES DE CONFIGURACI√ìN
            const logoutButton = document.getElementById('logout-button');
            if (logoutButton) {
                logoutButton.addEventListener('click', async () => {
                    try {
                        // Verificar si hay usuario autenticado
                        if (!appState.user) {
                            NotificationSystem.info('Info', 'No hay sesi√≥n activa');
                            return;
                        }
                        
                        // Modal elegante para cerrar sesi√≥n
                        const confirmed = await showWarningModal(
                            'üö™ ¬øCerrar sesi√≥n?',
                            `¬øQuieres cerrar sesi√≥n de <strong>${appState.user.email}</strong>?<br><br>
                            Tus datos financieros se mantendr√°n guardados de forma segura.`,
                            { 
                                confirmText: 'Cerrar sesi√≥n',
                                cancelText: 'Permanecer' 
                            }
                        );
                        if (!confirmed) return;
                        
                        NotificationSystem.info('Cerrando sesi√≥n...', 'Desconectando de tu cuenta');
                        
                        // Usar Firebase Auth para cerrar sesi√≥n
                        if (window.NebulaAuth && window.NebulaAuth.signOut) {
                            await window.NebulaAuth.signOut();
                        } else {
                            // Fallback: limpiar datos localmente
                            appState.user = null;
                            
                            // Limpiar datos de sesi√≥n (pero no los datos financieros)
                            if (NebulaSecurityUtils) {
                                NebulaSecurityUtils.secureRemoveItem('user_session');
                                NebulaSecurityUtils.secureRemoveItem('auth_token');
                            }
                        }
                        
                        NotificationSystem.success('Sesi√≥n cerrada', 'Has cerrado sesi√≥n exitosamente');
                        
                        // Opcional: recargar la app para reinicializar
                        setTimeout(() => location.reload(), 1500);
                        
                    } catch (error) {
                        console.error('Error cerrando sesi√≥n:', error);
                        NotificationSystem.error('Error', 'No se pudo cerrar la sesi√≥n');
                    }
                });
            }
            
            const exportExcelButton = document.getElementById('export-excel-button');
            if (exportExcelButton) {
                exportExcelButton.addEventListener('click', async () => {
                    try {
                        NotificationSystem.info('Exportando...', 'Preparando tus datos financieros');
                        
                        // Crear array con todas las transacciones del estado actual
                        const allTransactions = [];
                        
                        // Obtener transacciones de todos los meses
                        Object.entries(appState.data.transactions).forEach(([monthKey, transactions]) => {
                            transactions.forEach(transaction => {
                                allTransactions.push({
                                    tipo: transaction.type === 'income' ? 'Ingreso' : 'Gasto',
                                    descripcion: transaction.description,
                                    monto: transaction.amount,
                                    fecha: transaction.date,
                                    categoria: transaction.category || '',
                                    mes: monthKey
                                });
                            });
                        });
                        
                        // Agregar inversiones
                        appState.data.investments.forEach(investment => {
                            allTransactions.push({
                                tipo: 'Inversi√≥n',
                                descripcion: investment.name,
                                monto: investment.currentValue || investment.initialAmount,
                                fecha: investment.date || new Date().toISOString().split('T')[0],
                                categoria: investment.type || '',
                                mes: ''
                            });
                        });
                        
                        // Agregar metas
                        appState.data.goals.forEach(goal => {
                            allTransactions.push({
                                tipo: 'Meta',
                                descripcion: goal.name,
                                monto: goal.targetAmount,
                                fecha: goal.targetDate || '',
                                categoria: '',
                                mes: ''
                            });
                        });
                        
                        // Agregar deudas
                        appState.data.debts.forEach(debt => {
                            allTransactions.push({
                                tipo: 'Deuda',
                                descripcion: debt.description,
                                monto: debt.amount,
                                fecha: debt.date || new Date().toISOString().split('T')[0],
                                categoria: debt.type || '',
                                mes: ''
                            });
                        });
                        
                        // Crear CSV
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Tipo,Descripci√≥n,Monto,Fecha,Categor√≠a,Mes\\n";
                        
                        allTransactions.forEach(item => {
                            csvContent += `"${item.tipo}","${item.descripcion}",${item.monto},"${item.fecha}","${item.categoria}","${item.mes}"\\n`;
                        });
                        
                        // Descargar archivo
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", `nebula_financial_${new Date().toISOString().split('T')[0]}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        NotificationSystem.success('¬°Exportado!', 'Tus datos se han descargado exitosamente');
                        
                    } catch (error) {
                        console.error('Error exportando datos:', error);
                        NotificationSystem.error('Error', 'No se pudieron exportar los datos');
                    }
                });
            }
            
            const clearAllDataButton = document.getElementById('clear-all-data-button');            if (clearAllDataButton) {
                clearAllDataButton.addEventListener('click', async () => {
                    try {
                        // CloudSonnet4: Primera confirmaci√≥n con modal elegante
                        const confirmed1 = await showDangerModal(
                            '‚ö†Ô∏è Eliminar todos los datos',
                            'Esta acci√≥n eliminar√° <strong>TODOS</strong> tus datos financieros.<br><br>¬øEst√°s absolutamente seguro?',
                            { 
                                confirmText: 'Continuar',
                                cancelText: 'Cancelar' 
                            }
                        );
                        if (!confirmed1) return;
                        
                        // CloudSonnet4: Segunda confirmaci√≥n cr√≠tica
                        const confirmed2 = await showDangerModal(
                            'üö® √öLTIMA CONFIRMACI√ìN',
                            `Se borrar√°n permanentemente:<br><br>
                            ‚Ä¢ <strong>Todos los ingresos</strong><br>
                            ‚Ä¢ <strong>Todos los gastos</strong><br>
                            ‚Ä¢ <strong>Todas las inversiones</strong><br>
                            ‚Ä¢ <strong>Todas las metas</strong><br>
                            ‚Ä¢ <strong>Todas las deudas</strong><br><br>
                            <span style="color: #ef4444; font-weight: bold;">Esta acci√≥n NO SE PUEDE DESHACER.</span><br><br>
                            ¬øContinuar con la eliminaci√≥n?`,
                            { 
                                confirmText: 'S√ç, BORRAR TODO',
                                cancelText: 'No, mantener datos' 
                            }
                        );
                        if (!confirmed2) return;
                        
                        // Limpiar todos los datos del estado
                        appState.data = {
                            transactions: {},
                            investments: [],
                            goals: [],
                            debts: []
                        };
                        
                        // Limpiar localStorage
                        if (NebulaSecurityUtils) {
                            NebulaSecurityUtils.secureRemoveItem('financialData');
                        } else {
                            localStorage.removeItem('financialData');
                        }
                        
                        // Guardar el estado vac√≠o
                        appState.saveState();
                        
                        NotificationSystem.success('Datos eliminados', 'Todos los datos financieros han sido borrados');
                        
                        // Recargar la app para mostrar estado limpio
                        setTimeout(() => renderApp(), 1000);
                        
                    } catch (error) {
                        console.error('Error borrando datos:', error);
                        NotificationSystem.error('Error', 'No se pudieron borrar los datos');
                    }
                });
            }
            
            // üö® BOT√ìN ELIMINAR CUENTA COMPLETA
            const deleteAccountButton = document.getElementById('delete-account-button');
            if (deleteAccountButton) {
                deleteAccountButton.addEventListener('click', async () => {
                    try {
                        // Verificar que el usuario est√© autenticado
                        if (!appState.user) {
                            NotificationSystem.error('Error', 'Debes estar autenticado para eliminar tu cuenta');
                            return;
                        }
                        
                        // Triple confirmaci√≥n para eliminar cuenta
                        const confirmed1 = await showDangerModal(
                            '‚ö†Ô∏è Eliminar Cuenta Completa',
                            `¬øEst√°s seguro de que quieres eliminar tu cuenta de Nebula Financial?<br><br>
                            <strong>Esto eliminar√°:</strong><br>
                            ‚Ä¢ Tu cuenta de Firebase<br>
                            ‚Ä¢ Todos tus datos financieros<br>
                            ‚Ä¢ Tu acceso a la aplicaci√≥n<br><br>
                            ¬øContinuar?`,
                            { 
                                confirmText: 'Continuar',
                                cancelText: 'Cancelar' 
                            }
                        );
                        if (!confirmed1) return;
                        
                        // Segunda confirmaci√≥n m√°s espec√≠fica
                        const confirmed2 = await showDangerModal(
                            'üö® CONFIRMACI√ìN CR√çTICA',
                            `<strong style="color: #ef4444;">ATENCI√ìN: Esta acci√≥n es IRREVERSIBLE</strong><br><br>
                            Al eliminar tu cuenta:<br><br>
                            ‚Ä¢ Se borrar√° tu cuenta de Firebase permanentemente<br>
                            ‚Ä¢ Perder√°s todos tus datos financieros<br>
                            ‚Ä¢ No podr√°s recuperar esta informaci√≥n<br>
                            ‚Ä¢ Tendr√°s que crear una nueva cuenta para volver a usar la app<br><br>
                            ¬øEst√°s 100% seguro de que quieres continuar?`,
                            { 
                                confirmText: 'S√ç, ELIMINAR CUENTA',
                                cancelText: 'No, mantener cuenta' 
                            }
                        );
                        if (!confirmed2) return;
                        
                        // Tercera confirmaci√≥n final
                        const confirmed3 = await showDangerModal(
                            'üíÄ ELIMINACI√ìN FINAL',
                            `<div style="background: #7f1d1d; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
                                <strong style="color: #fca5a5;">‚ö†Ô∏è √öLTIMA OPORTUNIDAD ‚ö†Ô∏è</strong><br><br>
                                Est√°s a punto de eliminar permanentemente:<br>
                                <strong>üìß ${appState.user.email}</strong><br><br>
                                <span style="color: #ef4444; font-weight: bold;">Esta acci√≥n NO SE PUEDE DESHACER JAM√ÅS.</span>
                            </div>
                            ¬øProceder con la eliminaci√≥n definitiva?`,
                            { 
                                confirmText: 'üíÄ ELIMINAR DEFINITIVAMENTE',
                                cancelText: 'üõ°Ô∏è Conservar mi cuenta' 
                            }
                        );
                        if (!confirmed3) return;
                        
                        // Mostrar progreso
                        NotificationSystem.info('Eliminando...', 'Procesando eliminaci√≥n de cuenta...');
                        
                        // 1. Limpiar todos los datos locales primero
                        appState.data = {
                            transactions: {},
                            investments: [],
                            goals: [],
                            debts: []
                        };
                        
                        // 2. Limpiar localStorage
                        if (NebulaSecurityUtils) {
                            NebulaSecurityUtils.secureRemoveItem('financialData');
                            NebulaSecurityUtils.secureRemoveItem('user_session');
                            NebulaSecurityUtils.secureRemoveItem('auth_token');
                            NebulaSecurityUtils.secureRemoveItem('nebula_visited');
                        } else {
                            localStorage.clear();
                        }
                        
                        // 3. Eliminar cuenta de Firebase
                        if (window.NebulaAuth && window.NebulaAuth.deleteUserAccount) {
                            await window.NebulaAuth.deleteUserAccount();
                        } else {
                            // Fallback: cerrar sesi√≥n si no est√° disponible la funci√≥n de eliminar
                            if (window.NebulaAuth && window.NebulaAuth.signOut) {
                                await window.NebulaAuth.signOut();
                            }
                            NotificationSystem.warning('Cuenta cerrada', 'Se cerr√≥ la sesi√≥n. La eliminaci√≥n completa requiere verificaci√≥n manual.');
                        }
                        
                        // 4. Resetear estado de la app
                        appState.user = null;
                        appState.isLoading = false;
                        
                        NotificationSystem.success('Cuenta eliminada', 'Tu cuenta y datos han sido eliminados permanentemente');
                        
                        // 5. Recargar la app para mostrar p√°gina de login
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                        
                    } catch (error) {
                        console.error('Error eliminando cuenta:', error);
                        NotificationSystem.error('Error', `No se pudo eliminar la cuenta: ${error.message}`);
                    }
                });
            }
            
            // Actualizar glider al cargar eventos
            updateDockGlider();
            
            // Observer simple para cambios de tama√±o
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(updateDockGlider, 100);
            });
        }

        function addModalEventListeners() {
            const modalContainer = document.querySelector('.modal-container');
            if(modalContainer) {
                modalContainer.addEventListener('click', (e) => {
                    if(e.target === modalContainer) appState.closeModal();
                });
                modalContainer.querySelector('.modal-close-button')?.addEventListener('click', () => appState.closeModal());
            }            if (appState.activeModal === 'calendar') {
                document.getElementById('calendar-year-prev')?.addEventListener('click', () => appState.changeCalendarYear(-1));
                document.getElementById('calendar-year-next')?.addEventListener('click', () => appState.changeCalendarYear(1));
                document.getElementById('today-button')?.addEventListener('click', () => appState.goToday());
                
                const yearInput = document.getElementById('calendar-year-input');
                if (yearInput) {
                    yearInput.addEventListener('change', e => appState.setCalendarYear(parseInt(e.target.value)));
                    
                    // Navegaci√≥n con teclado para el a√±o
                    yearInput.addEventListener('keydown', (e) => {
                        if (e.key === 'ArrowUp' || e.key === 'ArrowRight') {
                            e.preventDefault();
                            appState.changeCalendarYear(1);
                        } else if (e.key === 'ArrowDown' || e.key === 'ArrowLeft') {
                            e.preventDefault();
                            appState.changeCalendarYear(-1);
                        }
                    });
                }
                
                // Navegaci√≥n global del modal con teclado
                document.addEventListener('keydown', function calendarKeyHandler(e) {
                    if (appState.activeModal === 'calendar') {
                        if (e.key === 'ArrowLeft' && !yearInput?.contains(e.target)) {
                            e.preventDefault();
                            appState.changeCalendarYear(-1);
                        } else if (e.key === 'ArrowRight' && !yearInput?.contains(e.target)) {
                            e.preventDefault();
                            appState.changeCalendarYear(1);
                        }
                    } else {
                        document.removeEventListener('keydown', calendarKeyHandler);
                    }
                });
                
                document.querySelectorAll('.month-button').forEach(btn => btn.addEventListener('click', e => appState.setCalendarDate(parseInt(e.currentTarget.dataset.monthIndex))));
            }
        }
          // ===============================================
        // üöÄ FUNCIONES DE PERFORMANCE - Optimizaci√≥n de eventos
        /**
         * Debounce para optimizar eventos de input frecuentes
         * @param {Function} func - Funci√≥n a ejecutar
         * @param {number} wait - Tiempo de espera en ms
         * @returns {Function} Funci√≥n debounced
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
         * Throttle para limitar ejecuci√≥n de funciones
         * @param {Function} func - Funci√≥n a ejecutar
         * @param {number} limit - L√≠mite en ms
         * @returns {Function} Funci√≥n throttled
         */
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }

        /**
         * Lazy loading para elementos que aparecen en viewport
         * @param {string} selector - Selector CSS de elementos
         * @param {Function} callback - Funci√≥n a ejecutar cuando sea visible
         */
        function observeIntersection(selector, callback) {
            if ('IntersectionObserver' in window) {
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            callback(entry.target);
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.1 });

                document.querySelectorAll(selector).forEach(el => observer.observe(el));
            } else {
                // Fallback para navegadores sin IntersectionObserver
                document.querySelectorAll(selector).forEach(callback);
            }        }

        // ===============================================
        // üßÆ FUNCIONES DE C√ÅLCULO FINANCIERO
        // ===============================================
        
        function calculateSummary() {
            const currentTransactions = appState.data.transactions[appState.currentMonthKey] || [];
            const totalIncome = currentTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpenses = currentTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            
            const allTransactions = Object.values(appState.data.transactions).flat();
            const totalSavings = allTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0) - allTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const totalInvestments = appState.data.investments.reduce((sum, i) => sum + i.currentAmount, 0);
            const totalDebts = appState.data.debts.reduce((sum, d) => sum + d.amount, 0);
            
            const balance = totalIncome - totalExpenses;
            const netWorth = totalSavings + totalInvestments - totalDebts;
            
            return { balance, netWorth, totalInvestments, totalDebts, totalIncome, totalExpenses };
        }

        // ===============================================
        // üöÄ SISTEMA DE ATAJOS DE TECLADO RESTAURADO
        // ===============================================
        
        /**
         * ÔøΩ Gestor de Atajos de Teclado Robusto
         * Sistema completo para manejar shortcuts en todos los navegadores
         */
        const ShortcutSystem = {
            shortcuts: new Map(),
            isActive: true,
            
            init() {
                this.registerDefaultShortcuts();
                this.attachListener();
                console.log('‚úÖ ShortcutSystem inicializado correctamente');
            },
            
            /**
             * Registra atajos por defecto de la aplicaci√≥n
             */
            registerDefaultShortcuts() {
                // Navegaci√≥n entre vistas
                this.register('d', () => appState.setView('dashboard'), 'Ir al Dashboard');
                this.register('i', () => appState.setView('income'), 'Ir a Ingresos');
                this.register('g', () => appState.setView('expenses'), 'Ir a Gastos');
                this.register('n', () => appState.setView('investments'), 'Ir a Inversiones');
                this.register('p', () => appState.setView('debts'), 'Ir a Deudas');
                this.register('m', () => appState.setView('goals'), 'Ir a Metas');
                this.register('a', () => appState.setView('settings'), 'Ir a Ajustes');
                
                // Navegaci√≥n temporal
                this.register('ArrowLeft', () => {
                    if (!appState.activeModal) appState.changeMonth(-1);
                }, 'Mes anterior');
                this.register('ArrowRight', () => {
                    if (!appState.activeModal) appState.changeMonth(1);
                }, 'Mes siguiente');
                
                // Funciones especiales
                this.register('Escape', () => {
                    if (appState.activeModal) appState.closeModal();
                }, 'Cerrar modal');
                this.register('c', () => {
                    if (!appState.activeModal) appState.openModal('calendar');
                }, 'Abrir calendario');
                this.register('h', () => {
                    if (!appState.activeModal) appState.openModal('shortcuts');
                }, 'Mostrar atajos');
                this.register('t', () => {
                    appState.togglePrivacy();
                    NotificationSystem.info('Privacidad', 
                        `Modo privado ${appState.isPrivate ? 'activado' : 'desactivado'}`);
                }, 'Alternar privacidad');
            },
            
            /**
             * Registra un nuevo atajo
             */
            register(key, callback, description = '') {
                this.shortcuts.set(key.toLowerCase(), { callback, description });
            },
            
            /**
             * Elimina un atajo
             */
            unregister(key) {
                this.shortcuts.delete(key.toLowerCase());
            },
            
            /**
             * Verifica si una tecla deber√≠a ser ignorada
             */
            shouldIgnoreEvent(event) {
                const activeElement = document.activeElement;
                const isInputField = activeElement && 
                    ['INPUT', 'TEXTAREA', 'SELECT'].includes(activeElement.tagName);
                const isContentEditable = activeElement && 
                    activeElement.contentEditable === 'true';
                
                return isInputField || isContentEditable;
            },
            
            /**
             * Maneja el evento de teclado
             */
            handleKeyDown(event) {
                if (!this.isActive || this.shouldIgnoreEvent(event)) {
                    return;
                }
                
                const key = event.key.toLowerCase();
                const shortcut = this.shortcuts.get(key);
                
                if (shortcut) {
                    event.preventDefault();
                    try {
                        shortcut.callback(event);
                    } catch (error) {
                        console.error('Error executing shortcut:', error);
                        NotificationSystem.error('Error', 'Error al ejecutar atajo de teclado');
                    }
                }
            },
            
            /**
             * Adjunta el listener de eventos
             */
            attachListener() {
                document.addEventListener('keydown', (event) => {
                    this.handleKeyDown(event);
                }, { passive: false });
            },
            
            /**
             * Obtiene lista de atajos registrados
             */
            getShortcutsList() {
                return Array.from(this.shortcuts.entries()).map(([key, data]) => ({
                    key: key.toUpperCase(),
                    description: data.description
                }));
            },
            
            /**
             * Activa/desactiva el sistema de shortcuts
             */            setActive(active) {
                this.isActive = active;
            }        };

        // üéØ DEBUG: Verificar que ShortcutSystem est√° definido
        console.log('üéØ SHORTCUT SYSTEM STATUS:', typeof ShortcutSystem !== 'undefined' ? '‚úÖ DEFINIDO' : '‚ùå NO DEFINIDO');

        // ===============================================
        // üöÄ INICIALIZACI√ìN MEJORADA PARA LIVE SERVER
        // ===============================================
        
        // Funci√≥n de inicializaci√≥n robusta
        function startNebula() {
            try {
                // Verificar si ya est√° inicializada
                if (window.nebulaInitialized) {
                    console.log('‚ö†Ô∏è startNebula ya ejecutada, evitando duplicaci√≥n');
                    return;
                }
                
                console.log('üöÄ Iniciando Nebula Financial...');
                
                // Marcar como inicializada inmediatamente
                window.nebulaInitialized = true;
                
                // Verificar elementos DOM
                const elements = ['content-root', 'dock-root', 'parallax-bg', 'modal-root'];
                const domElements = elements.map(id => document.getElementById(id));
                
                if (domElements.some(el => !el)) {
                    console.error('‚ùå Elementos DOM faltantes:', elements.filter((_, i) => !domElements[i]));
                    throw new Error('Elementos DOM no encontrados');
                }
                
                // Asignar elementos a variables globales
                [contentRoot, dockRoot, parallaxBg, modalRoot] = domElements;
                  // Verificar objetos necesarios
                if (!THEMES || !ICONS || !appState) {
                    throw new Error('Objetos globales no definidos');
                }
                  // üåç EXPOSICI√ìN GLOBAL CR√çTICA - Para compatibilidad con m√≥dulos
                window.appState = appState;
                window.THEMES = THEMES;
                window.ICONS = ICONS;
                window.renderApp = renderApp;
                
                // üîî FUNCI√ìN GLOBAL DE NOTIFICACI√ìN PARA FIREBASE AUTH
                window.showNotification = function(message, type = 'info') {
                    if (NotificationSystem) {
                        switch (type) {
                            case 'success':
                                NotificationSystem.success('Autenticaci√≥n', message);
                                break;
                            case 'error':
                                NotificationSystem.error('Error', message);
                                break;
                            case 'warning':
                                NotificationSystem.warning('Atenci√≥n', message);
                                break;
                            default:
                                NotificationSystem.info('Informaci√≥n', message);
                        }
                    } else {
                        console.log(`${type.toUpperCase()}: ${message}`);
                    }
                };
                  // Funci√≥n global para aplicar autoformato num√©rico
                window.formatThousands = function(value) {
                    if (!value) return '';
                    // Remover todo excepto n√∫meros
                    const cleanValue = value.toString().replace(/[^\d]/g, '');
                    // Aplicar formato con puntos cada 3 d√≠gitos
                    return cleanValue.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                };
                
                window.applyThousandsFormatting = function(input) {
                    if (!input) return;
                    
                    // Evento input para formateo en tiempo real
                    input.addEventListener('input', (e) => {
                        const cursorPosition = e.target.selectionStart;
                        const oldValue = e.target.value;
                        const newValue = window.formatThousands(oldValue);
                        
                        // Solo actualizar si cambi√≥ el valor
                        if (newValue !== oldValue) {
                            e.target.value = newValue;
                            
                            // Mantener posici√≥n del cursor
                            const newCursorPosition = cursorPosition + (newValue.length - oldValue.length);
                            e.target.setSelectionRange(newCursorPosition, newCursorPosition);
                        }
                    });
                    
                    // Formatear valor inicial si existe
                    if (input.value) {
                        input.value = window.formatThousands(input.value);
                    }
                };
                
                window.applyNumericFormatting = function() {
                    // Aplicar formateo autom√°tico de miles a todos los inputs num√©ricos
                    document.querySelectorAll('.numeric-input').forEach(input => {
                        window.applyThousandsFormatting(input);
                    });
                    
                    // Tambi√©n aplicar a inputs de actualizaci√≥n de inversiones
                    document.querySelectorAll('.update-investment-input').forEach(input => {
                        window.applyThousandsFormatting(input);
                    });
                };
                
                console.log('‚úÖ Objetos globales expuestos correctamente');
                
                // Inicializar sistemas
                ShortcutSystem.init();
                NotificationSystem.init();
                
                // Renderizar aplicaci√≥n
                renderApp();
                  // Configurar dock
                setTimeout(() => {
                    if (typeof updateDockGlider === 'function') {
                        updateDockGlider();
                    }
                }, 200);
                
                // Mostrar mensaje de bienvenida si es la primera vez
                const isFirstVisit = NebulaSecurityUtils ? 
                    !NebulaSecurityUtils.secureGetItem('nebula_visited') :
                    !localStorage.getItem('nebula_visited');
                if (isFirstVisit) {
                    if (NebulaSecurityUtils) {
                        NebulaSecurityUtils.secureSetItem('nebula_visited', true);
                    } else {
                        localStorage.setItem('nebula_visited', 'true');
                    }
                    setTimeout(() => {
                        NotificationSystem.info('¬°Bienvenido!', 
                            'Presiona H para ver los atajos de teclado disponibles', 6000);
                    }, 2000);
                }
                
                // üî• CONECTAR FIREBASE AUTH CON APPSTATE
                // =====================================
                if (window.NebulaAuth) {
                    console.log('üî• Conectando Firebase Auth con appState...');
                    
                    // Escuchar eventos de Firebase Auth
                    window.addEventListener('nebula-auth-userSignedIn', (event) => {
                        const user = event.detail;
                        console.log('üî• Usuario Firebase autenticado:', user);
                        appState.handleFirebaseAuthChange(user);
                    });
                    
                    window.addEventListener('nebula-auth-userSignedOut', () => {
                        console.log('üî• Usuario Firebase desconectado');
                        appState.handleFirebaseAuthChange(null);
                    });
                    
                    // Verificar si Firebase Auth ya est√° inicializado
                    setTimeout(async () => {
                        try {
                            if (!window.NebulaAuth.isAuthenticated()) {
                                console.log('üî• Inicializando Firebase Auth...');
                                const success = await window.NebulaAuth.init();
                                if (success) {
                                    console.log('üî• Firebase Auth conectado exitosamente');
                                } else {
                                    console.warn('‚ö†Ô∏è Firebase Auth en modo fallback');
                                }
                            } else {
                                console.log('üî• Firebase Auth ya est√° activo');
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Error inicializando Firebase Auth:', error.message);
                        }
                    }, 1000);
                } else {
                    console.warn('‚ö†Ô∏è NebulaAuth no disponible, funcionando en modo offline');
                }
                
                console.log('‚úÖ Nebula iniciada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                
                // Mostrar p√°gina de error
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #1e3a8a 0%, #7c3aed 100%); color: white; font-family: 'Inter', Arial, sans-serif;">
                        <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.4); border-radius: 20px; backdrop-filter: blur(10px); max-width: 500px;">
                            <h1 style="font-size: 3rem; margin-bottom: 1rem;">üåå</h1>
                            <h2 style="font-size: 2rem; margin-bottom: 1rem; color: #e2e8f0;">Nebula Financial</h2>
                            <p style="margin-bottom: 1.5rem; color: #cbd5e1; font-size: 1.1rem;">Iniciando tu universo financiero...</p>
                            <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 2rem; text-align: left;">
                                <small style="color: #fcd34d; font-family: monospace;">${error.message}</small>
                            </div>
                            <button onclick="location.reload()" style="background: linear-gradient(45deg, #22c55e, #16a34a); border: none; color: white; padding: 14px 28px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); transition: transform 0.2s; margin-right: 10px;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                üîÑ Recargar App
                            </button>
                            <button onclick="if(NebulaSecurityUtils) { NebulaSecurityUtils.clearSecurityData(); } else { localStorage.clear(); } location.reload()" style="background: linear-gradient(45deg, #f59e0b, #d97706); border: none; color: white; padding: 14px 28px; border-radius: 25px; font-size: 1.1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">>
                                üóëÔ∏è Limpiar Datos
                            </button>
                        </div>
                    </div>
                `;
            }
        }
          // Funci√≥n de espera para DOM con verificaci√≥n robusta
        function waitForDOM() {
            console.log('üìã Verificando estado DOM:', document.readyState);
            
            // Verificar que los elementos cr√≠ticos existan
            const criticalElements = ['app-container', 'content-root', 'dock-root', 'parallax-bg', 'modal-root'];
            const allElementsExist = criticalElements.every(id => {
                const element = document.getElementById(id);
                console.log(`üìã Elemento ${id}:`, element ? '‚úÖ Encontrado' : '‚ùå No encontrado');
                return element !== null;
            });
            
            if (document.readyState === 'complete' && allElementsExist) {
                console.log('‚úÖ DOM completamente cargado y elementos verificados');
                if (!window.nebulaInitialized) {
                    startNebula();
                }
            } else if (document.readyState === 'interactive' && allElementsExist) {
                console.log('‚è≥ DOM interactivo, esperando 200ms...');
                setTimeout(() => {
                    const stillExist = criticalElements.every(id => document.getElementById(id));
                    if (stillExist && !window.nebulaInitialized) {
                        startNebula();
                    } else if (!stillExist) {
                        console.log('üîÑ Elementos no listos, esperando evento DOMContentLoaded...');
                        document.addEventListener('DOMContentLoaded', () => {
                            if (!window.nebulaInitialized) startNebula();
                        });
                    }
                }, 200);
            } else {
                console.log('üîÑ Esperando carga completa del DOM...');
                document.addEventListener('DOMContentLoaded', () => {
                    console.log('üìã DOMContentLoaded disparado, reintentando...');
                    setTimeout(waitForDOM, 50);
                });
            }
        }// Iniciar aplicaci√≥n
        waitForDOM();

        // üß™ SISTEMA DE VALIDACI√ìN AUTOM√ÅTICA
        function validateNebula() {
            setTimeout(() => {
                try {
                    console.log('üß™ Iniciando validaci√≥n autom√°tica de Nebula...');                    const validationResults = {
                        shortcuts: false,
                        notifications: false,
                        appState: false,
                        dom: false,
                        themes: false,
                        security: false,
                        inputValidation: false
                    };
                    
                    // Test ShortcutSystem
                    if (typeof ShortcutSystem !== 'undefined' && ShortcutSystem.init) {
                        console.log('‚úÖ ShortcutSystem: Definido y funcional');
                        validationResults.shortcuts = true;
                    } else {
                        console.error('‚ùå ShortcutSystem: No definido o no funcional');
                    }
                    
                    // Test NotificationSystem
                    if (typeof NotificationSystem !== 'undefined' && NotificationSystem.success) {
                        console.log('‚úÖ NotificationSystem: Definido y funcional');
                        validationResults.notifications = true;
                    } else {
                        console.error('‚ùå NotificationSystem: No definido o no funcional');
                    }                      // Test appState
                    if (typeof appState !== 'undefined' && appState.activeView && appState.data) {
                        console.log('‚úÖ appState: Definido y funcional');
                        validationResults.appState = true;
                    } else {
                        console.error('‚ùå appState: No definido o no funcional', {
                            defined: typeof appState !== 'undefined',
                            hasActiveView: typeof appState !== 'undefined' && typeof appState.activeView !== 'undefined',
                            hasData: typeof appState !== 'undefined' && appState.data
                        });
                    }
                    
                    // Test DOM elements
                    const criticalIds = ['content-root', 'dock-root', 'parallax-bg', 'modal-root'];
                    const domOk = criticalIds.every(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            console.log(`‚úÖ DOM ${id}: Encontrado`);
                            return true;
                        } else {
                            console.error(`‚ùå DOM ${id}: No encontrado`);
                            return false;
                        }
                    });
                    validationResults.dom = domOk;                    // Test THEMES
                    if (typeof THEMES !== 'undefined' && THEMES.aureoAmanecer && THEMES.crisonVespertino) {
                        console.log('‚úÖ THEMES: Definido y funcional');
                        validationResults.themes = true;
                    } else {
                        console.error('‚ùå THEMES: No definido o no funcional', {
                            defined: typeof THEMES !== 'undefined',
                            hasAureoAmanecer: typeof THEMES !== 'undefined' && THEMES.aureoAmanecer,
                            hasCrisonVespertino: typeof THEMES !== 'undefined' && THEMES.crisonVespertino
                        });
                    }
                    
                    // Test Security System
                    if (typeof NebulaSecurityUtils !== 'undefined' && NebulaSecurityUtils.encrypt) {
                        console.log('‚úÖ NebulaSecurityUtils: Sistema de seguridad activo');
                        validationResults.security = true;
                        
                        // Test de cifrado b√°sico
                        try {
                            const testData = 'test-encryption';
                            const encrypted = NebulaSecurityUtils.encrypt(testData);
                            const decrypted = NebulaSecurityUtils.decrypt(encrypted);
                            if (decrypted === testData) {
                                console.log('‚úÖ Cifrado/Descifrado: Funcionando correctamente');
                            } else {
                                console.warn('‚ö†Ô∏è Cifrado/Descifrado: Inconsistencia detectada');
                            }
                        } catch (error) {
                            console.error('‚ùå Error en test de cifrado:', error);
                        }                    } else {
                        console.error('‚ùå NebulaSecurityUtils: No definido o no funcional');
                    }
                    
                    // Test Input Validation System
                    if (typeof NebulaInputValidator !== 'undefined' && NebulaInputValidator.validateAmount) {
                        console.log('‚úÖ NebulaInputValidator: Sistema de validaci√≥n activo');
                        validationResults.inputValidation = true;
                        
                        // Test de validaci√≥n b√°sico
                        try {
                            const testResult = NebulaInputValidator.validateAmount('123.45');
                            if (testResult.isValid && testResult.value === 123.45) {
                                console.log('‚úÖ Validaci√≥n de entrada: Funcionando correctamente');
                            } else {
                                console.warn('‚ö†Ô∏è Validaci√≥n de entrada: Comportamiento inesperado');
                            }
                        } catch (error) {
                            console.error('‚ùå Error en test de validaci√≥n:', error);
                        }
                    } else {
                        console.error('‚ùå NebulaInputValidator: No definido o no funcional');
                    }
                    
                    // Calcular resultados
                    const totalTests = Object.keys(validationResults).length;
                    const passedTests = Object.values(validationResults).filter(Boolean).length;
                    const successRate = (passedTests / totalTests * 100).toFixed(1);
                    
                    console.log(`üß™ Validaci√≥n completada: ${passedTests}/${totalTests} tests pasados (${successRate}%)`);
                    
                    if (passedTests === totalTests) {
                        console.log('üéâ ¬°Nebula Financial est√° funcionando perfectamente!');
                        // Mostrar notificaci√≥n de √©xito
                        if (NotificationSystem && NotificationSystem.success) {
                            NotificationSystem.success('Sistema Validado', 
                                `Todos los componentes funcionan correctamente (${successRate}%)`, 4000);
                        }
                    } else {
                        console.warn(`‚ö†Ô∏è Algunas validaciones fallaron. Revisa la consola para m√°s detalles.`);
                        if (NotificationSystem && NotificationSystem.warning) {
                            NotificationSystem.warning('Validaci√≥n Parcial', 
                                `${passedTests}/${totalTests} componentes funcionando`, 6000);
                        }
                    }
                    
                    // üîß Test r√°pido de atajos si todo est√° bien
                    if (validationResults.shortcuts && validationResults.notifications) {
                        console.log('üéÆ Para probar atajos: D=Dashboard, I=Ingresos, G=Gastos, H=Ayuda');
                    }
                      } catch (error) {
                    console.error('‚ùå Error durante la validaci√≥n:', error);
                }
            }, 5000); // ‚è∞ CAMBIADO: 5 segundos para asegurar inicializaci√≥n completa
        }
        
        // Ejecutar validaci√≥n autom√°ticamente
        if (typeof window !== 'undefined') {
            validateNebula();
        }

        // üöÄ Registro del Service Worker para performance
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        // Verificar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            console.log('üîÑ Nueva versi√≥n del SW disponible');
                        });
                    })
                    .catch(error => {
                        console.log('‚ùå Error registrando SW:', error);
                    });
            });        }

    </script>
      <!-- üîß M√ìDULOS DE NEBULA FINANCIAL -->
    <script type="module">
        // Cargar m√≥dulos de forma as√≠ncrona
        import('./js/modules/investments.js').then(module => {
            // El m√≥dulo ya se auto-inicializa, solo verificamos que est√© disponible
            console.log('‚úÖ M√≥dulo de Inversiones cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de inversiones:', error);
        });
        
        import('./js/modules/goals.js').then(module => {
            // El m√≥dulo ya se auto-inicializa, solo verificamos que est√© disponible
            console.log('‚úÖ M√≥dulo de Metas cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de metas:', error);
        });
        
        import('./js/modules/debts.js').then(module => {
            // El m√≥dulo ya se auto-inicializa, solo verificamos que est√© disponible
            console.log('‚úÖ M√≥dulo de Deudas cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de deudas:', error);
        });
        
        import('./js/modules/income.js').then(module => {
            // Asegurarse de que el m√≥dulo est√© disponible globalmente
            if (!window.NebulaIncomeModule && window.IncomeModule) {
                window.NebulaIncomeModule = window.IncomeModule;
            }
            console.log('‚úÖ M√≥dulo de Ingresos cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de ingresos:', error);
        });
        
        import('./js/modules/expenses.js').then(module => {
            // Asegurarse de que el m√≥dulo est√© disponible globalmente
            if (!window.NebulaExpensesModule && window.ExpensesModule) {
                window.NebulaExpensesModule = window.ExpensesModule;
            }
            console.log('‚úÖ M√≥dulo de Gastos cargado');
        }).catch(error => {
            console.error('‚ùå Error cargando m√≥dulo de gastos:', error);
        });
    </script>
</body>
</html>
