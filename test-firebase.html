<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• Test Firebase - Nebula Financial</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        .success { background: rgba(34, 197, 94, 0.2); border: 1px solid #22c55e; }
        .error { background: rgba(239, 68, 68, 0.2); border: 1px solid #ef4444; }
        .warning { background: rgba(245, 158, 11, 0.2); border: 1px solid #f59e0b; }
        .info { background: rgba(59, 130, 246, 0.2); border: 1px solid #3b82f6; }
        button {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        button:hover { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .user-info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        pre {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Test Firebase - Nebula Financial</h1>
        <p>Prueba completa del sistema de autenticaci√≥n Firebase</p>
        
        <div id="status-container">
            <div class="status info">
                üìã Iniciando pruebas de Firebase...
            </div>
        </div>

        <div>
            <h3>üîê Controles de Autenticaci√≥n</h3>
            <button id="btn-google" onclick="testGoogleLogin()">üîë Login con Google</button>
            <button id="btn-anonymous" onclick="testAnonymousLogin()">üëª Login An√≥nimo</button>
            <button id="btn-upgrade" onclick="testUpgradeAccount()" disabled>‚¨ÜÔ∏è Actualizar Cuenta</button>
            <button id="btn-logout" onclick="testLogout()" disabled>üö™ Cerrar Sesi√≥n</button>
        </div>

        <div id="user-info" class="user-info" style="display: none;">
            <h3>üë§ Informaci√≥n del Usuario</h3>
            <div id="user-details"></div>
        </div>

        <div>
            <h3>üìä Logs del Sistema</h3>
            <pre id="logs"></pre>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Environment Loader -->
    <script src="./env-loader.js"></script>
    
    <!-- Firebase Config -->
    <script src="./config/firebase-config.js"></script>
    
    <!-- Firebase Auth Module -->
    <script src="./js/auth/firebase-auth.js"></script>

    <script>
        let logs = [];
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logs.push(`[${timestamp}] ${message}`);
            document.getElementById('logs').textContent = logs.join('\n');
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            document.getElementById('status-container').appendChild(statusDiv);
            
            // Mantener solo los √∫ltimos 5 status
            const statuses = document.querySelectorAll('#status-container .status');
            if (statuses.length > 5) {
                statuses[0].remove();
            }
        }

        async function initializeTest() {
            try {
                addLog('üîÑ Cargando variables de entorno...', 'info');
                
                // Cargar env
                if (window.NebulaEnvLoader) {
                    const envLoader = new NebulaEnvLoader();
                    await envLoader.loadEnvironment();
                    window.NebulaEnv = envLoader;
                    addLog('‚úÖ Variables de entorno cargadas', 'success');
                } else {
                    addLog('‚ö†Ô∏è NebulaEnvLoader no disponible', 'warning');
                }

                // Verificar Firebase
                if (typeof firebase === 'undefined') {
                    throw new Error('Firebase SDK no est√° disponible');
                }
                addLog('‚úÖ Firebase SDK cargado', 'success');

                // Verificar configuraci√≥n
                if (!window.NebulaConfig || !window.NebulaConfig.isValid) {
                    throw new Error('Configuraci√≥n de Firebase no v√°lida');
                }
                addLog('‚úÖ Configuraci√≥n de Firebase v√°lida', 'success');

                // Inicializar autenticaci√≥n
                if (window.NebulaAuth) {
                    const authInitialized = await NebulaAuth.init();
                    if (authInitialized) {
                        addLog('‚úÖ M√≥dulo de autenticaci√≥n inicializado', 'success');
                        
                        // Escuchar eventos de autenticaci√≥n
                        window.addEventListener('userSignedIn', handleUserSignedIn);
                        window.addEventListener('userSignedOut', handleUserSignedOut);
                        
                    } else {
                        addLog('‚ùå Error inicializando autenticaci√≥n', 'error');
                    }
                } else {
                    addLog('‚ö†Ô∏è NebulaAuth no disponible', 'warning');
                }

                addLog('üéâ Sistema listo para pruebas', 'success');

            } catch (error) {
                addLog(`‚ùå Error en inicializaci√≥n: ${error.message}`, 'error');
                console.error('Error:', error);
            }
        }

        function handleUserSignedIn(event) {
            const user = event.detail;
            addLog(`üë§ Usuario autenticado: ${user.email || user.uid}`, 'success');
            
            // Mostrar info del usuario
            document.getElementById('user-details').innerHTML = `
                <p><strong>UID:</strong> ${user.uid}</p>
                <p><strong>Email:</strong> ${user.email || 'No disponible'}</p>
                <p><strong>Nombre:</strong> ${user.displayName || 'No disponible'}</p>
                <p><strong>An√≥nimo:</strong> ${user.isAnonymous ? 'S√≠' : 'No'}</p>
                <p><strong>Email verificado:</strong> ${user.emailVerified ? 'S√≠' : 'No'}</p>
                <p><strong>Fecha de creaci√≥n:</strong> ${user.createdAt}</p>
            `;
            document.getElementById('user-info').style.display = 'block';
            
            // Actualizar botones
            document.getElementById('btn-logout').disabled = false;
            if (user.isAnonymous) {
                document.getElementById('btn-upgrade').disabled = false;
            }
        }

        function handleUserSignedOut() {
            addLog('üö™ Usuario desconectado', 'info');
            document.getElementById('user-info').style.display = 'none';
            
            // Actualizar botones
            document.getElementById('btn-logout').disabled = true;
            document.getElementById('btn-upgrade').disabled = true;
        }

        async function testGoogleLogin() {
            try {
                addLog('üîë Iniciando login con Google...', 'info');
                const result = await NebulaAuth.signInWithGoogle();
                addLog('‚úÖ Login con Google exitoso', 'success');
            } catch (error) {
                addLog(`‚ùå Error en login con Google: ${error.message}`, 'error');
            }
        }

        async function testAnonymousLogin() {
            try {
                addLog('üëª Iniciando login an√≥nimo...', 'info');
                const result = await NebulaAuth.signInAnonymously();
                addLog('‚úÖ Login an√≥nimo exitoso', 'success');
            } catch (error) {
                addLog(`‚ùå Error en login an√≥nimo: ${error.message}`, 'error');
            }
        }

        async function testUpgradeAccount() {
            try {
                addLog('‚¨ÜÔ∏è Actualizando cuenta an√≥nima...', 'info');
                const result = await NebulaAuth.upgradeAnonymousAccount();
                addLog('‚úÖ Cuenta actualizada exitosamente', 'success');
            } catch (error) {
                addLog(`‚ùå Error actualizando cuenta: ${error.message}`, 'error');
            }
        }

        async function testLogout() {
            try {
                addLog('üö™ Cerrando sesi√≥n...', 'info');
                await NebulaAuth.signOut();
                addLog('‚úÖ Sesi√≥n cerrada exitosamente', 'success');
            } catch (error) {
                addLog(`‚ùå Error cerrando sesi√≥n: ${error.message}`, 'error');
            }
        }

        // Inicializar cuando la p√°gina est√© lista
        window.addEventListener('load', () => {
            setTimeout(initializeTest, 1000);
        });
    </script>
</body>
</html>
