<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Test Calendario Integrado</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white">
    
    <!-- Header de Test -->
    <div class="bg-gray-800 border-b border-gray-700 p-4">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold">ğŸ”§ Test Calendario Integrado</h1>
            <div class="flex gap-2">
                <button id="test-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                    ğŸ¯ Test Calendario
                </button>
                <button id="reset-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm">
                    ğŸ”„ Reset
                </button>
            </div>
        </div>
    </div>

    <!-- Log Area -->
    <div class="p-4 bg-gray-800 border-b border-gray-700">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-sm font-bold mb-2">ğŸ“ Log de Debug</h2>
            <div id="log-content" class="text-xs font-mono bg-black p-2 rounded max-h-32 overflow-y-auto">
                <!-- Los logs aparecerÃ¡n aquÃ­ -->
            </div>
        </div>
    </div>

    <!-- Contenedor de la App -->
    <div id="app-container" class="min-h-screen bg-gray-900">
        <div class="flex justify-center items-center h-64">
            <p class="text-gray-400">Haz clic en "Test Calendario" para cargar la app</p>
        </div>
    </div>

    <script>
        // Sistema de logs
        function log(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div class="text-green-400">[${timestamp}] ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }

        function error(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<div class="text-red-400">[${timestamp}] ERROR: ${message}</div>`;
            logContent.scrollTop = logContent.scrollHeight;
            console.error(message);
        }

        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Cargar la aplicaciÃ³n en un iframe
        async function loadApp() {
            log('ğŸš€ Cargando aplicaciÃ³n en iframe...');
            
            const appContainer = document.getElementById('app-container');
            appContainer.innerHTML = `
                <iframe 
                    id="app-frame" 
                    src="index-lab.html" 
                    class="w-full h-screen border-0"
                    onload="appLoaded()"
                ></iframe>
            `;
        }

        // FunciÃ³n que se ejecuta cuando la app termina de cargar
        window.appLoaded = async function() {
            log('âœ… AplicaciÃ³n cargada en iframe');
            await wait(2000);
            await testCalendar();
        }

        // Test del calendario
        async function testCalendar() {
            log('ğŸ” Iniciando test del calendario...');
            
            try {
                const iframe = document.getElementById('app-frame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const iframeWindow = iframe.contentWindow;
                
                // 1. Buscar el botÃ³n del calendario
                log('ğŸ“‹ Paso 1: Buscando botÃ³n del calendario...');
                const calendarButton = iframeDoc.getElementById('calendar-button');
                
                if (!calendarButton) {
                    error('âŒ BotÃ³n del calendario no encontrado');
                    return;
                }
                
                log('âœ… BotÃ³n del calendario encontrado');
                log(`ğŸ“‹ BotÃ³n ID: ${calendarButton.id}`);
                log(`ğŸ“‹ BotÃ³n Clase: ${calendarButton.className}`);
                
                // 2. Verificar appState
                log('ğŸ“‹ Paso 2: Verificando appState...');
                const appState = iframeWindow.appState;
                
                if (!appState) {
                    error('âŒ appState no encontrado');
                    return;
                }
                
                log('âœ… appState encontrado');
                log(`ğŸ“‹ Modal activo: ${appState.activeModal || 'ninguno'}`);
                
                // 3. Simular click en el botÃ³n del calendario
                log('ğŸ“‹ Paso 3: Simulando click en el botÃ³n del calendario...');
                calendarButton.click();
                
                await wait(1000);
                
                // 4. Verificar si el modal se abriÃ³
                log('ğŸ“‹ Paso 4: Verificando modal del calendario...');
                const modalRoot = iframeDoc.getElementById('modal-root');
                
                if (!modalRoot || !modalRoot.innerHTML.trim()) {
                    error('âŒ Modal del calendario no se abriÃ³');
                    log(`ğŸ“‹ Estado del modal: ${appState.activeModal || 'ninguno'}`);
                    return;
                }
                
                log('âœ… Modal del calendario se abriÃ³ correctamente');
                log(`ğŸ“‹ Contenido del modal: ${modalRoot.innerHTML.length} caracteres`);
                
                // 5. Verificar elementos del calendario
                log('ğŸ“‹ Paso 5: Verificando elementos del calendario...');
                
                const yearInput = iframeDoc.getElementById('calendar-year-input');
                const todayBtn = iframeDoc.getElementById('calendar-today-btn');
                const monthButtons = iframeDoc.querySelectorAll('.calendar-month-btn');
                
                log(`ğŸ“‹ Input de aÃ±o: ${yearInput ? 'ENCONTRADO' : 'NO ENCONTRADO'}`);
                log(`ğŸ“‹ BotÃ³n "Ir a Hoy": ${todayBtn ? 'ENCONTRADO' : 'NO ENCONTRADO'}`);
                log(`ğŸ“‹ Botones de mes: ${monthButtons.length} encontrados`);
                
                if (yearInput) {
                    log(`ğŸ“‹ Valor del input de aÃ±o: "${yearInput.value}"`);
                }
                
                // 6. Test de interacciÃ³n con el input de aÃ±o
                if (yearInput) {
                    log('ğŸ“‹ Paso 6: Probando input de aÃ±o...');
                    const originalYear = yearInput.value;
                    const testYear = '2025';
                    
                    yearInput.value = testYear;
                    yearInput.dispatchEvent(new Event('change'));
                    
                    await wait(500);
                    
                    log(`ğŸ“‹ Input cambiÃ³ de ${originalYear} a ${testYear}`);
                    log('âœ… Input de aÃ±o funciona correctamente');
                }
                
                // 7. Test de botÃ³n de mes
                if (monthButtons.length > 0) {
                    log('ğŸ“‹ Paso 7: Probando botÃ³n de mes...');
                    const firstMonthBtn = monthButtons[0];
                    const monthName = firstMonthBtn.textContent.trim();
                    
                    log(`ğŸ“‹ Probando click en: ${monthName}`);
                    firstMonthBtn.click();
                    
                    await wait(1000);
                    
                    // Verificar si el modal se cerrÃ³ (deberÃ­a cerrarse al seleccionar mes)
                    const modalAfterClick = iframeDoc.getElementById('modal-root');
                    
                    if (!modalAfterClick || !modalAfterClick.innerHTML.trim()) {
                        log('âœ… Modal se cerrÃ³ correctamente despuÃ©s de seleccionar mes');
                        log('ğŸ‰ TEST COMPLETO: Calendario funciona perfectamente');
                    } else {
                        error('âŒ Modal no se cerrÃ³ despuÃ©s de seleccionar mes');
                    }
                }
                
            } catch (err) {
                error(`Error durante el test: ${err.message}`);
                console.error('Error completo:', err);
            }
        }

        // Event listeners
        document.getElementById('test-btn').addEventListener('click', async () => {
            document.getElementById('log-content').innerHTML = '';
            await loadApp();
        });

        document.getElementById('reset-btn').addEventListener('click', () => {
            document.getElementById('log-content').innerHTML = '';
            document.getElementById('app-container').innerHTML = `
                <div class="flex justify-center items-center h-64">
                    <p class="text-gray-400">Haz clic en "Test Calendario" para cargar la app</p>
                </div>
            `;
            log('ğŸ”„ Test reiniciado');
        });

        log('ğŸ¯ Test Calendario Integrado listo. Haz clic en "Test Calendario" para comenzar.');
    </script>
</body>
</html>
